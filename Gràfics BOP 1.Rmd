---
title: "Gràfics data I 2023"
output: html_notebook
---

# ------------------------------------------------------------------------------

# Llibreries

```{r}
library(pacman)
p_load(tidyverse,
       haven,
       sjlabelled,
       labelled,
       janitor,
       stringi,
       ggrepel,
       naniar,
       tidytext,
       sjmisc,
       scales,
       CEOdata,
       yaml)
```

# Dades

```{r}
list2env(read_yaml("config/config.yaml"), envir=globalenv()) # Arxiu config

data <- read_sav(file.path(DTA_FOLDER, "Microdades anonimitzades 1050.sav")) # Matriu del BOP

evolucio <- read_csv2(file.path(DTA_FOLDER, "evolucio.csv")) # Evolució de les estimacions

poblacio <- read_csv2(file.path(DTA_FOLDER, "poblacio.csv")) # Dades poblacionals
poblacio <- poblacio  |>  
  select(grup,
         categoria,
         resposta = resposta_18,
         valor = esp_18)

bop_historic <- CEOdata(raw = TRUE) # Matriu històrica
bop_historic$REO = factor(bop_historic$REO, 
                          levels=unique(bop_historic$REO))
```

# Funcions 

```{r}
# Per a que els percentatges sumin 100

round_percent <- function(x) { 
  x <- x/sum(x)*100  
  res <- floor(x)    
  rsum <- sum(res)   
  if(rsum<100) { 
    o <- order(x%%1, sample(length(x)), decreasing=TRUE) 
    res[o[1:(100-rsum)]] <- res[o[1:(100-rsum)]]+1
  } 
  res 
}

# Noms dels partits

clean_party_name <- function(x) {
  if (!is.factor(x)) {
    stop("Variable is expected to be a factor")
  }
  
  levels(x) <- stri_trans_general(levels(x), "latin-ascii") 
  levels(x) <- stri_replace_all_charclass(levels(x), "[[:punct:]]", "")
  levels(x) <- stri_replace_all_charclass(levels(x), "[[:whitespace:]]", ".")
  return(x)
}

prettify_party_names <- function(x) {
  if (!is.factor(x)) {
    stop("Variable is expected to be a factor")
  }
  
  for (i in levels(x)) {
    if (i %in% names(PRETTY_PARTY_NAMES)) {
      levels(x)[which(levels(x) == i)] <- as.character(PRETTY_PARTY_NAMES[i])
    }
  }
  
  return(x)
}

# Noms dels líders polítics

prettify_politic_names <- function(x) {
  if (!is.factor(x)) {
    stop("Variable is expected to be a factor")
  }
  
  for (i in levels(x)) {
    if (i %in% names(PRETTY_POLITIC_NAMES)) {
      levels(x)[which(levels(x) == i)] <- as.character(PRETTY_POLITIC_NAMES[i])
    }
  }
  
  return(x)
}

# Data dels Baròmetres

prettify_bop_names <- function(x) {
  if (!is.factor(x)) {
    stop("Variable is expected to be a factor")
  }
  
  for (i in levels(x)) {
    if (i %in% names(PRETTY_BOP_NAMES)) {
      levels(x)[which(levels(x) == i)] <- as.character(PRETTY_BOP_NAMES[i])
    }
  }
  
  return(x)
}
```

# Colors i font

```{r}
# Colors dels partits

party_color <- unlist(lapply(PARTITS_COLORS, \(x) x[1]))
vot2_party_color <- unlist(lapply(PARTITS_COLORS_ALTRES, \(x) x[1]))

#  Escales de colors

## Mostra

two_colors <- c("#5A7E8C",
                "#BFBFBF")

three_colors <- c("#5C7E91",
                 "#859EAD",
                 "#C3C3C3")

four_colors <- c("#5C7E91",
                 "#859EAD",
                 "#D6DFE3",
                 "#C3C3C3")

five_colors <- c("#5C7E91",
                 "#859EAD",
                 "#ADBEC8",
                 "#D6DFE3",
                 "#C3C3C3")

## Pos-Neg

pos_neg_5_colors <- c("#7EC23E", 
                      "#BAE390",
                      "#F9DA72",
                      "#EE9595", 
                      "#E66060",
                      "#C6C6C6",
                      "#9E9B9B")
                      
pos_neg_5_text <- c("#FFFFFF",
                   "#585858",
                   "#585858",
                   "#585858",
                   "#FFFFFF",
                   "#585858",
                   "#FFFFFF")

pos_neg_4_colors <- c("#7EC23E", 
                      "#BAE390",
                      "#EE9595", 
                      "#E66060",
                      "#C6C6C6",
                      "#9E9B9B")
                      
pos_neg_4_text <- c("#FFFFFF",
                   "#585858",
                   "#585858",
                   "#FFFFFF",
                   "#585858",
                   "#FFFFFF")

pos_neg_3_colors <- c("#7EC23E", 
                      "#F9DA72",
                      "#E66060",
                      "#C6C6C6",
                      "#9E9B9B")
                      
pos_neg_3_text <- c("#FFFFFF",
                   "#585858",
                   "#FFFFFF",
                   "#585858",
                   "#FFFFFF")

pos_neg_2_colors <- c("#7EC23E", 
                      "#E66060",
                      "#C6C6C6",
                      "#9E9B9B")
                      
pos_neg_2_text <- c("#FFFFFF",
                   "#FFFFFF",
                   "#585858",
                   "#FFFFFF")
                   
## Categòriques
                   
categ_6_colors <- c("#2274A5",
                      "#32936F",
                      "#FBAF00",
                      "#E83F6F",
                      "#613F75",
                      "#875053",
                      "#C6C6C6",
                      "#9E9B9B")
                      
categ_6_text <- c("#FFFFFF",
                   "#FFFFFF",
                   "#585858",
                   "#FFFFFF",
                   "#FFFFFF",
                   "#FFFFFF",
                   "#585858",
                   "#FFFFFF")

categ_5_colors <- c("#2274A5",
                      "#32936F",
                      "#FBAF00",
                      "#E83F6F",
                      "#613F75",
                      "#C6C6C6",
                      "#9E9B9B")
                      
                      
categ_5_text <- c("#FFFFFF",
                   "#FFFFFF",
                   "#585858",
                   "#FFFFFF",
                   "#FFFFFF",
                   "#585858",
                   "#FFFFFF")

categ_4_colors <- c("#2274A5",
                      "#32936F",
                      "#FBAF00",
                      "#E83F6F",
                      "#C6C6C6",
                      "#9E9B9B")
                      
categ_4_text <- c("#FFFFFF",
                   "#FFFFFF",
                   "#585858",
                   "#FFFFFF",
                   "#585858",
                   "#FFFFFF")

categ_3_colors <- c("#2274A5",
                      "#32936F",
                      "#FBAF00",
                      "#C6C6C6",
                      "#9E9B9B")
                      
categ_3_text <- c("#FFFFFF",
                   "#FFFFFF",
                   "#585858",
                   "#585858",
                   "#FFFFFF")

categ_2_colors <- c("#2274A5",
                      "#32936F",
                      "#C6C6C6",
                      "#9E9B9B")
                      
categ_2_text <- c("#FFFFFF",
                   "#FFFFFF",
                   "#585858",
                   "#FFFFFF")

# Font de text (NOMÉS A WINDOWS)

windowsFonts(open_sans=windowsFont("Open Sans"))

# Funció per a canviar els punts decimals per comes

point <- format_format(big.mark = ".", decimal.mark = ",", scientific = FALSE)
```

# ------------------------------------------------------------------------------

# Mostra

## Sexe

```{r}
plot_sexe <- data |> 
  as_label(SEXE, drop.levels = FALSE)  |>  
  group_by(SEXE) |> 
  count(SEXE)  |> 
  ungroup() |> 
  mutate(percent = (n / sum(n))*100) |> 
  mutate(grup = "Mostra",
         categoria = "Sexe") |> 
  select(grup,
         categoria,
         resposta = SEXE,
         valor = percent) |> 
  rbind(poblacio) |> 
  filter(categoria == "Sexe") |> 
  group_by(grup) |> 
  mutate(valor =  round_percent(as.numeric(valor))) |> 
  ggplot() +
  geom_col(aes(valor, 
               grup,
               group = resposta,
               fill = resposta),
           width = 2/3,
           position = position_stack(reverse = TRUE)) +
  geom_text(aes(valor, 
                grup,
                label = valor,
                group = resposta),
            position = position_stack(vjust = 0.5,
                                      reverse = TRUE),
            size = 6,
            fontface = "bold",
            family = "sans") +
  scale_fill_manual(values = rev(two_colors)) +
  scale_y_discrete(limits = rev,
                   expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.margin=margin(margin(0,0,0,0, "cm")),
        panel.grid.major = element_blank(),
        panel.grid.minor= element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size = 15),
        plot.margin = margin(0,0.5,0,0, "cm"),
        text = element_text(color  = "black",
                            family = "sans",
                            size = 15),
        plot.title = element_text(margin = margin(0.25,0,0.5,0, "cm"),
                                  face = "bold", 
                                  color = "black",
                                  size = 17,
                                  hjust = 0.5)) +
  labs(x = "",
       y = "",
       fill = "",
       title = "Sexe")
plot_sexe

ggsave(file.path(MOSTRA_IMG_FOLDER, "sexe.png"),
       plot = plot_sexe,
       width = 17,
       height = 5,
       dpi=300,
       units = "cm")  
```

## Llengua

```{r}
plot_llengua <- data  |> 
  mutate(LLENGUA_PRIMERA_1_3 = case_when(
    LLENGUA_PRIMERA_1_3 == 1 ~ "Català",
    LLENGUA_PRIMERA_1_3 == 2 ~ "Castellà",
    LLENGUA_PRIMERA_1_3 == 80 ~ "Altres",
    LLENGUA_PRIMERA_1_3 == 98 ~ "NS/NC",
    LLENGUA_PRIMERA_1_3 == 99 ~ "NS/NC"),
    LLENGUA_PRIMERA_1_3 = factor(LLENGUA_PRIMERA_1_3,
                             levels = c("Català",
                                        "Castellà",
                                        "Altres",
                                        "NS/NC"))) |> 
  group_by(LLENGUA_PRIMERA_1_3) |> 
  count(LLENGUA_PRIMERA_1_3) |> 
  ungroup() |> 
  mutate(percent = (n / sum(n))*100) |> 
  mutate(grup = "Mostra",
         categoria = "Llengua primera") |>
  select(grup,
         categoria,
         resposta = LLENGUA_PRIMERA_1_3,
         valor = percent) |> 
  rbind(poblacio) |> 
  filter(categoria == "Llengua primera") |> 
  group_by(grup) |> 
  mutate(valor = round_percent(as.numeric(valor))) |> 
  filter(resposta != "NS/NC") |> 
  ggplot() +
  geom_col(aes(valor, 
               grup,
               group = resposta,
               fill = resposta),
           width = 2/3,
           position = position_stack(reverse = TRUE)) +
  geom_text(aes(valor, 
                grup,
                label = valor,
                group = resposta),
            position = position_stack(vjust = 0.5,
                                      reverse = TRUE),
            size = 6,
            fontface = "bold",
            family = "sans") +
  scale_fill_manual(values = four_colors) +
  scale_y_discrete(limits = rev,
                   expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.margin=margin(margin(0,0,0,0, "cm")),
        panel.grid.major = element_blank(),
        panel.grid.minor= element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size = 15),
        plot.margin = margin(0,0.5,0,0, "cm"),
        text = element_text(color  = "black",
                            family = "sans",
                            size = 15),
        plot.title = element_text(margin = margin(0.25,0,0.5,0, "cm"),
                                  face = "bold", 
                                  color = "black",
                                  size = 17,
                                  hjust = 0.5)) +
  labs(x = "",
       y = "",
       fill = "",
       title = "Llengua primera")
plot_llengua

ggsave(file.path(MOSTRA_IMG_FOLDER, "llengua.png"),
       plot = plot_llengua,
       width = 17,
       height = 5,
       dpi=300,
       units = "cm")  
```

## Lloc de naixement

```{r}
plot_naixement <- data |> 
  as_label(drop.levels = FALSE) |> 
  group_by(LLOC_NAIX) |> 
  count(LLOC_NAIX) |> 
  ungroup() |> 
  mutate(percent = (n / sum(n))*100) |> 
  mutate(grup = "Mostra",
         categoria = "Lloc de naix") |>
  select(grup,
         categoria,
         resposta = LLOC_NAIX,
         valor = percent) |> 
  rbind(poblacio) |> 
  filter(categoria == "Lloc de naix") |> 
  group_by(grup) |> 
  mutate(valor = round_percent(as.numeric(valor))) |> 
  ggplot() +
  geom_col(aes(valor, 
               grup,
               group = resposta,
               fill = resposta),
           width = 2/3,
           position = position_stack(reverse = TRUE)) +
  geom_text(aes(valor, 
                grup,
                label = valor,
                group = resposta),
            position = position_stack(vjust = 0.5,
                                      reverse = TRUE),
            size = 6,
            fontface = "bold",
            family = "sans") +
  scale_fill_manual(values = three_colors) +
  scale_y_discrete(limits = rev,
                   expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.margin=margin(margin(0,0,0,0, "cm")),
        panel.grid.major = element_blank(),
        panel.grid.minor= element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size = 15),
        plot.margin = margin(0,0.5,0,0, "cm"),
        text = element_text(color  = "black",
                            family = "sans",
                            size = 15),
        plot.title = element_text(margin = margin(0.25,0,0.5,0, "cm"),
                                  face = "bold", 
                                  color = "black",
                                  size = 17,
                                  hjust = 0.5)) +
  labs(x = "",
       y = "",
       fill = "",
       title = "Lloc de naixement")
plot_naixement

ggsave(file.path(MOSTRA_IMG_FOLDER, "naixement.png"),
       plot = plot_naixement,
       width = 17,
       height = 5,
       dpi=300,
       units = "cm")  
```

## Edat

```{r}
plot_edat <- data |>
  as_label(EDAT_GR, drop.levels = F) |> 
  group_by(EDAT_GR) |> 
  count(EDAT_GR) |> 
  ungroup() |> 
  mutate(percent = (n / sum(n))*100) |> 
  mutate(grup = "Mostra",
         categoria = "Franges edat") |>
  select(grup,
         categoria,
         resposta = EDAT_GR,
         valor = percent) |> 
  mutate(resposta = str_replace(resposta, "De ", ""),
         resposta = str_replace(resposta, "de ", "")) |> 
  rbind(poblacio) |> 
  filter(categoria == "Franges edat") |> 
  group_by(grup) |> 
  mutate(valor = round_percent(as.numeric(valor))) |> 
  ggplot() +
  geom_col(aes(valor, 
               grup,
               group = resposta,
               fill = resposta),
           width = 2/3,
           position = position_stack(reverse = TRUE)) +
  geom_text(aes(valor, 
                grup,
                label = valor,
                group = resposta),
            position = position_stack(vjust = 0.5,
                                      reverse = TRUE),
            size = 6,
            fontface = "bold",
            family = "sans") +
  scale_fill_manual(values = five_colors) +
  scale_y_discrete(limits = rev,
                   expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.margin=margin(margin(0,0,0,0, "cm")),
        panel.grid.major = element_blank(),
        panel.grid.minor= element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size = 15),
        plot.margin = margin(0,0.5,0,0, "cm"),
        text = element_text(color  = "black",
                            family = "sans",
                            size = 15),
        plot.title = element_text(margin = margin(0.25,0,0.5,0, "cm"),
                                  face = "bold", 
                                  color = "black",
                                  size = 17,
                                  hjust = 0.5)) +
  labs(x = "",
       y = "",
       fill = "",
       title = "Edat")
plot_edat

ggsave(file.path(MOSTRA_IMG_FOLDER, "edat.png"),
       plot = plot_edat,
       width = 21,
       height = 5,
       dpi=300,
       units = "cm") 
```

## Nivell d'estudis

```{r}
plot_estudis <- data |>
  mutate(ESTUDIS_1_15 = case_when(
    ESTUDIS_1_15 < 4 ~ "Educació primària o inferior",
    ESTUDIS_1_15 > 3 & ESTUDIS_1_15 < 8 ~ "Educació secundària i similar",
    ESTUDIS_1_15 > 7  ~ "Educació superior"
  )) |> 
  group_by(ESTUDIS_1_15) |> 
  count(ESTUDIS_1_15) |> 
  ungroup() |> 
  mutate(percent = (n / sum(n))*100) |> 
  mutate(grup = "Mostra",
         categoria = "Educació") |>
  select(grup,
         categoria,
         resposta = ESTUDIS_1_15,
         valor = percent) |> 
  rbind(poblacio) |> 
  filter(categoria == "Educació") |> 
  group_by(grup) |> 
  mutate(valor = round_percent(as.numeric(valor))) |> 
  ggplot() +
  geom_col(aes(valor, 
               grup,
               group = resposta,
               fill = resposta),
           width = 2/3,
           position = position_stack(reverse = TRUE)) +
  geom_text(aes(valor, 
                grup,
                label = valor,
                group = resposta),
            position = position_stack(vjust = 0.5,
                                      reverse = TRUE),
            size = 6,
            fontface = "bold",
            family = "sans") +
  scale_fill_manual(values = three_colors) +
    scale_x_continuous(expand = c(0,0)) +
  scale_y_discrete(limits = rev,
                   expand = c(0,0)) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.margin=margin(margin(0,0,0,0, "cm")),
        panel.grid.major = element_blank(),
        panel.grid.minor= element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size = 15),
        plot.margin = margin(0,0.5,0,0, "cm"),
        text = element_text(color  = "black",
                            family = "sans",
                            size = 15),
        plot.title = element_text(margin = margin(0.25,0,0.5,0, "cm"),
                                  face = "bold", 
                                  color = "black",
                                  size = 17,
                                  hjust = 0.5)) +
  labs(x = "",
       y = "",
       fill = "",
       title = "Nivell d'estudis")
plot_estudis

ggsave(file.path(MOSTRA_IMG_FOLDER, "estudis.png"),
       plot = plot_estudis,
       width = 21,
       height = 5,
       dpi=300,
       units = "cm") 
```

# ------------------------------------------------------------------------------

# Electoral

## Evolució de les estimacions

```{r}
evolucio_plot <- evolucio |>
  mutate(party = factor(party,
                        c("PSC",
                          "ERC",
                          "Junts per Catalunya",
                          "Vox",
                          "En Comú Podem",
                          "CUP",
                          "Ciudadanos",
                          "PP"))) |> 
  ggplot() +
  geom_ribbon(aes(x = fct_relevel(bop,
                            c("Març 22",
                              "Juny 22",
                              "Octubre 22",
                              "Març 23")), 
                  ymin = lower, 
                  ymax = upper, 
                  fill = party,
                  group = party),
              alpha = 0.15) +
  geom_line(aes(fct_relevel(bop,
                            c("Març 22",
                              "Juny 22",
                              "Octubre 22",
                              "Març 23")),
                median,
                group = party,
                color = party),
            size = 1) +
  geom_point(aes(fct_relevel(bop,
                            c("Març 22",
                              "Juny 22",
                              "Octubre 22",
                              "Març 23")),
                 median,
                 group = party,
                 color = party),
             size = 2.5, show.legend = F) +
  geom_hline(aes(yintercept = 0)) +
  scale_y_continuous(limits = c(0,32),
                     expand = c(0,0)) +
  scale_x_discrete(expand = c(0, 0.2)) +
  scale_color_manual(values = c("PSC" = "#E73B39",
                                "ERC" = "#FFB232",
                                "Junts per Catalunya" = "#00C3B2",
                                "PP" = "#0BB2FF",
                                "CUP" = "#EAC134",
                                "Vox" = "#63BE21",
                                "En Comú Podem" = "#6E236E",
                                "Ciudadanos" = "#EB6109")) +
  scale_fill_manual(values = c("PSC" = "#E73B39",
                                "ERC" = "#FFB232",
                                "Junts per Catalunya" = "#00C3B2",
                                "PP" = "#0BB2FF",
                                "CUP" = "#EAC134",
                                "Vox" = "#63BE21",
                                "En Comú Podem" = "#6E236E",
                                "Ciudadanos" = "#EB6109")) +
  guides(color = guide_legend(override.aes = list(size = 6))) +
  theme_minimal()+
  theme(panel.grid.major.x = element_blank(),
        plot.margin = margin(0.5,0.5,0,0.5, "cm"),
        text = element_text(family = "open_sans",
                            size = 20,
                            color  = "black"),
        plot.title = element_text(margin = margin(0.25,0,0.25,0, "cm"),
                                  face = "bold", 
                                  color = "black"),
        plot.subtitle = element_text(margin = margin(0,0,0.5,0, "cm"),
                                     color="#ACACAC",
                                     face = "italic"),
        plot.title.position = "plot",
        plot.caption.position = "plot") +
  labs(x= "",
       y = "",
       color = "",
       fill = "")
evolucio_plot

ggsave(file.path(ELECT_IMG_FOLDER, "evolucio_plot.png"),
       plot = evolucio_plot,
       width = 30,
       height = 15,
       dpi = 300,
       units = "cm")
```

## Segona opció de vot segons intenció de vot

```{r}
vot2_plot <- data |> 
  mutate(INT_PARLAMENT_VOT2 = car::recode(INT_PARLAMENT_VOT2, "c(2)=21; c(19, 20)=80; c(93, 94, 96, 97, 98, 99)=95")) |> 
  filter(INT_PARLAMENT_VOT_R <= 80,
         INT_PARLAMENT_VOT2_PROB < 900) |> 
  mutate(INT_PARLAMENT_VOT_R = as_label(INT_PARLAMENT_VOT_R), 
         INT_PARLAMENT_VOT_R = clean_party_name(INT_PARLAMENT_VOT_R),
         INT_PARLAMENT_VOT_R = prettify_party_names(INT_PARLAMENT_VOT_R),
         INT_PARLAMENT_VOT2 = as_label(INT_PARLAMENT_VOT2), 
         INT_PARLAMENT_VOT2 = clean_party_name(INT_PARLAMENT_VOT2),
         INT_PARLAMENT_VOT2 = prettify_party_names(INT_PARLAMENT_VOT2)) |> 
  group_by(INT_PARLAMENT_VOT_R, INT_PARLAMENT_VOT2) |> 
  summarize(n = length(INT_PARLAMENT_VOT_R)) |>  
  ungroup() |>  
  group_by(INT_PARLAMENT_VOT_R) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  mutate(INT_PARLAMENT_VOT_R = case_when(
    INT_PARLAMENT_VOT_R == "PSC" ~ "PSC (159)",
    INT_PARLAMENT_VOT_R == "ERC" ~ "ERC (265)",
    INT_PARLAMENT_VOT_R == "Junts per Catalunya" ~ "Junts per Catalunya (134)",
    INT_PARLAMENT_VOT_R == "PP" ~ "PP (57)",
    INT_PARLAMENT_VOT_R == "En Comú Podem" ~ "En Comú Podem (162)",
    INT_PARLAMENT_VOT_R == "CUP" ~ "CUP (122)",
    INT_PARLAMENT_VOT_R == "Vox" ~ "Vox (40)",
    INT_PARLAMENT_VOT_R == "Ciudadanos" ~ "Ciudadanos (40)",
    INT_PARLAMENT_VOT_R == "Altres" ~ "Altres (28)"),
    INT_PARLAMENT_VOT_R = factor(INT_PARLAMENT_VOT_R,
                                 levels = c("PSC (159)",
                                            "ERC (265)",
                                            "Junts per Catalunya (134)",
                                            "Vox (40)",
                                            "En Comú Podem (162)",
                                            "CUP (122)",
                                            "Ciudadanos (40)",
                                            "PP (57)",
                                            "Altres (28)"))) |> 
  ggplot() + 
  geom_col(aes(proportion, 
               reorder_within(INT_PARLAMENT_VOT2, proportion, INT_PARLAMENT_VOT_R), 
               fill = INT_PARLAMENT_VOT2)) +
  geom_vline(aes(xintercept = 0)) +
  geom_text(aes(x = proportion,
                y = reorder_within(INT_PARLAMENT_VOT2, proportion, INT_PARLAMENT_VOT_R), 
                label = proportion),
            fontface = "bold",
            size = 5,
            hjust = -0.3) +
  scale_y_reordered() +
  scale_x_continuous(limits = c(0,75),
                     expand = c(0,0)) +
  scale_fill_manual(values = vot2_party_color) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        text = element_text(family = "open_sans",
                            size = 15,
                            color  = "black"),
        strip.text.x = element_text(hjust=0)) +
  labs(x = "",
       y = "") +
facet_wrap(vars(INT_PARLAMENT_VOT_R), 
             nrow=3,
             scales = "free_y")
vot2_plot

ggsave(file.path(ELECT_IMG_FOLDER, "vot2_plot.png"),
       plot = vot2_plot,
       width = 30,
       height = 20,
       dpi = 300,
       units = "cm")
```

# ------------------------------------------------------------------------------

# Líders

## Coneixement líders (general)

```{r}
coneixement_plot <- data |> 
  as_label() |> 
  select(matches("CONEIX_"),
         PONDERA) |>
  pivot_longer(cols = starts_with("CONEIX_"),
               names_to = "politic", 
               values_to = "coneixement") |> 
  group_by(politic, coneixement) |> 
  count(politic, wt = PONDERA) |>  
  ungroup() |> 
  group_by(politic) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(coneixement == "Coneix") |> 
  select(politic,
         proportion) |> 
  mutate(politic = factor(str_replace_all(politic, "CONEIX_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  ggplot() +
  geom_col(aes(x = proportion,
               y = fct_reorder(politic, proportion)),
           fill = "#0E2F59") +
    geom_text(aes(x = proportion,
                y = fct_reorder(politic, proportion),
                label = proportion), 
            hjust = -0.3,
            family = "open_sans", 
            color = "#646464",
            fontface = "bold",
            size = 6) +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,110)) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size = 15),
        plot.margin = margin(0.5,1,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
coneixement_plot

ggsave(file.path(LIDERS_IMG_FOLDER, "coneixement_liders.png"),
       plot = coneixement_plot,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm") 
```

## Valoració líders dels enquestats que coneixen el/la líder (mitjanes)

```{r}
valoracio_plot <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1)) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  group_by(politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  ggplot() +
  geom_linerange(aes(xmin = 0,
                     xmax = valoracio,
                     y = fct_reorder(politic, valoracio),
                     group = politic),
                 size = 1,
                 color = "#0E2F59") +
  geom_point(aes(valoracio, 
                 fct_reorder(politic, valoracio)),
             size = 11,
             color = "#0E2F59") +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,10)) +
  geom_text(aes(valoracio,
                fct_reorder(politic, 
                            valoracio),
                label = point(valoracio)), 
            hjust = 0.5,
            color = "white",
            family = "open_sans", 
            fontface = "bold",
            size = 4) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size = 13),
        plot.margin = margin(0.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
valoracio_plot

ggsave(file.path(LIDERS_IMG_FOLDER, "valoracio_liders.png"),
       plot = valoracio_plot,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm") 
```

## Índex d’aprovació dels líders dels enquestats que coneixen el/la líder

```{r}
coneixement <- data |> # Percentatges de coneixement
  as_label() |> 
  select(matches("CONEIX_"), PONDERA) |>
  pivot_longer(cols = starts_with("CONEIX_"),
               names_to = "politic", 
               values_to = "coneixement") |> 
  group_by(politic, coneixement) |> 
  count(politic, wt = PONDERA) |>  
  ungroup() |> 
  group_by(politic) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(coneixement == "Coneix") |> 
  select(politic,
         proportion) |> 
  mutate(politic = factor(str_replace_all(politic, "CONEIX_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  select(politic,
         coneixement = proportion)

valoracio <- data |> # Percentatges de aprovació
  filter(if_any(contains("CONEIX_"), ~ .x == 1)) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  mutate(valoracio = case_when(
    valoracio < 5 ~ "Desaprovacio",
    valoracio >= 5 & valoracio <= 10 ~ "Aprovació",
    valoracio >= 98 ~ "NS/NC",
    TRUE ~ NA_character_)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  filter(valoracio != is.na(valoracio)) |> 
  group_by(politic, valoracio) |> 
  count(politic, wt = PONDERA) |>  
  ungroup() |> 
  group_by(politic) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  mutate(politic = prettify_politic_names(politic)) |>
  filter(valoracio == "Aprovació") |> 
  select(politic,
         valoracio = proportion)

aprovacio <- coneixement |> # S'uneixen els percentatges
  left_join(valoracio, by = "politic")

aprovacio_plot <- aprovacio |> 
  ggplot() + 
  geom_col(aes(x = valoracio,
               y = fct_reorder(politic, valoracio)),
           width = 0.5,
           position = position_nudge(y = 0.12),
           fill = "#0E2F59") +
  geom_col(aes(x = coneixement,
               y = politic),
           alpha = 0.5,
           fill = "#0E2F59",
           width = 0.3,
           position = position_nudge(y = -0.3)) +
  geom_text(aes(x = valoracio,
                y = politic, 
                label = valoracio), 
            hjust = -0.3,
            vjust = 0.1,
            family = "open_sans", 
            color = "#646464",
            fontface = "bold",
            size = 4.5) +
  geom_text(aes(x = coneixement,
                y = politic, 
                label = coneixement), 
            hjust = -0.3,
            vjust = 1.5,
            family = "open_sans", 
            color = "#646464",
            fontface = "italic",
            size = 3.7) +
  scale_x_continuous(limits = c(0, 105),
                     expand = c(0, 0)) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size = 15),
        plot.margin = margin(0.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black")) +
  labs(x= "",
       y = "")
aprovacio_plot

ggsave(file.path(LIDERS_IMG_FOLDER, "aprovacio_liders.png"),
       plot = aprovacio_plot,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm") 
```

## Valoració dels líders pels seus electors

```{r}
pp <- data  |>  
  filter(if_any(contains("CONEIX_"), ~ .x == 1), REC_PARLAMENT_VOT_CENS_R == 1) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  group_by(politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  filter(politic %in% c("Alejandro Fernández", "Lorena Roldán"))

erc <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1), REC_PARLAMENT_VOT_CENS_R == 3) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  group_by(politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  filter(politic %in% c("Oriol Junqueras", "Pere Aragonès"))

psc <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1), REC_PARLAMENT_VOT_CENS_R == 4) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  group_by(politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  filter(politic %in% c("Salvador Illa", "Miquel Iceta"))

cs <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1), REC_PARLAMENT_VOT_CENS_R == 6) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  group_by(politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  filter(politic %in% c("Inés Arrimadas", "Carlos Carrizosa"))

cup <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1), REC_PARLAMENT_VOT_CENS_R == 10) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  group_by(politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  filter(politic %in% c("Eulàlia Reguant", "Dolors Sabater"))

ecp <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1), REC_PARLAMENT_VOT_CENS_R == 18) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  group_by(politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  filter(politic %in% c("Jèssica Albiach", "Jaume Asens"))

junts <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1), REC_PARLAMENT_VOT_CENS_R == 21) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  group_by(politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  filter(politic %in% c("Carles Puigdemont", "Laura Borràs"))

vox <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1), REC_PARLAMENT_VOT_CENS_R == 23) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  group_by(politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  filter(politic %in% c("Ignacio Garriga"))

valoracio_electors <- rbind(pp,erc,psc,cs,cup,ecp,junts,vox)

electors_plot <- valoracio_electors |> 
  ggplot() +
  geom_linerange(aes(xmin = 0,
                     xmax = valoracio,
                     y = fct_reorder(politic, valoracio),
                     group = politic),
                 size = 1,
                 color = "#0E2F59") +
  geom_point(aes(valoracio, 
                 fct_reorder(politic, valoracio)),
             size = 11,
             color = "#0E2F59") +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,10)) +
  geom_text(aes(valoracio,
                fct_reorder(politic, 
                            valoracio),
                label = point(valoracio)), 
            hjust = 0.5,
            color = "white",
            family = "open_sans", 
            fontface = "bold",
            size = 4) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size = 13),
        plot.margin = margin(0.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
electors_plot

ggsave(file.path(LIDERS_IMG_FOLDER, "valoracio_liders_electors.png"),
       plot = electors_plot,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Valoració dels líders pels no electors

```{r}
no_pp <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1), REC_PARLAMENT_VOT_CENS_R != 1) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  group_by(politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  filter(politic %in% c("Alejandro Fernández", "Lorena Roldán"))

no_erc <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1), REC_PARLAMENT_VOT_CENS_R != 3) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  group_by(politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  filter(politic %in% c("Oriol Junqueras", "Pere Aragonès"))

no_psc <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1), REC_PARLAMENT_VOT_CENS_R != 4) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  group_by(politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  filter(politic %in% c("Salvador Illa", "Miquel Iceta"))

no_cs <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1), REC_PARLAMENT_VOT_CENS_R != 6) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  group_by(politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  filter(politic %in% c("Inés Arrimadas", "Carlos Carrizosa"))

no_cup <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1), REC_PARLAMENT_VOT_CENS_R != 10) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  group_by(politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  filter(politic %in% c("Eulàlia Reguant", "Dolors Sabater"))

no_ecp <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1), REC_PARLAMENT_VOT_CENS_R != 18) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  group_by(politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  filter(politic %in% c("Jèssica Albiach", "Jaume Asens"))

no_junts <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1), REC_PARLAMENT_VOT_CENS_R != 21) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  group_by(politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  filter(politic %in% c("Carles Puigdemont", "Laura Borràs"))

no_vox <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1), REC_PARLAMENT_VOT_CENS_R != 23) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  group_by(politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  filter(politic %in% c("Ignacio Garriga"))

valoracio_no_electors <- rbind(no_pp,no_erc,no_psc,no_cs,no_cup,no_ecp,no_junts,no_vox)

no_electors_plot <- valoracio_no_electors |> 
  ggplot() +
  geom_linerange(aes(xmin = 0,
                     xmax = valoracio,
                     y = fct_reorder(politic, valoracio),
                     group = politic),
                 size = 1,
                 color = "#0E2F59") +
  geom_point(aes(valoracio, 
                 fct_reorder(politic, valoracio)),
             size = 11,
             color = "#0E2F59") +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,10)) +
  geom_text(aes(valoracio,
                fct_reorder(politic, 
                            valoracio),
                label = point(valoracio)), 
            hjust = 0.5,
            color = "white",
            family = "open_sans", 
            fontface = "bold",
            size = 4) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size = 13),
        plot.margin = margin(0.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
no_electors_plot

ggsave(file.path(LIDERS_IMG_FOLDER, "valoracio_liders_no_electors.png"),
       plot = no_electors_plot,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Distribució percentual de la valoració dels líders

```{r}
valoracio_distribucio <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1)) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE), PONDERA) |>
  select(-contains("GOV"), PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  mutate(distribucio = case_when(
    valoracio < 3 ~ "0-2",
    valoracio > 2 & valoracio < 5 ~ "3-4",
    valoracio > 4 & valoracio < 6 ~ "5",
    valoracio > 5 & valoracio < 8 ~ "6-7",
    valoracio > 7 & valoracio < 98 ~ "8-10",
    valoracio > 10 & valoracio < 100 ~ "NS/NC")) |> 
  na.omit() |> 
  group_by(politic, distribucio) |> 
  count(politic, wt = PONDERA) |> 
  ungroup() |> 
  group_by(politic) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  mutate(distribucio = factor(distribucio, levels = distribucio)) |> 
  ggplot() +
  geom_col(aes(proportion,
               fct_relevel(politic,
                           c("Carlos Carrizosa",
                             "Inés Arrimadas",
                             "Ignacio Garriga",
                             "Alejandro Fernández",
                             "Lorena Roldán",
                             "Laura Borràs",
                             "Carles Puigdemont",
                             "Miquel Iceta",
                             "Salvador Illa",
                             "Eulàlia Reguant",
                             "Pere Aragonès",
                             "Dolors Sabater",
                             "Jèssica Albiach",
                             "Jaume Asens",
                             "Oriol Junqueras")),
               group = rev(distribucio),
               fill = distribucio), 
           width = 0.8) +
 geom_vline(aes(xintercept = 50,
                group = rev(distribucio)),
             size = 0.1,
             linetype = "dashed") +
  geom_text(aes(proportion,
                fct_relevel(politic,
                           c("Carlos Carrizosa",
                             "Inés Arrimadas",
                             "Ignacio Garriga",
                             "Alejandro Fernández",
                             "Lorena Roldán",
                             "Laura Borràs",
                             "Carles Puigdemont",
                             "Miquel Iceta",
                             "Salvador Illa",
                             "Eulàlia Reguant",
                             "Pere Aragonès",
                             "Dolors Sabater",
                             "Jèssica Albiach",
                             "Jaume Asens",
                             "Oriol Junqueras")),
                group = rev(distribucio),
                color = distribucio,
                label = ifelse(proportion > 1, proportion, "")),
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  scale_fill_manual(values = c("#E66060",
                               "#EE9595",
                               "#F9DA72",
                               "#BAE390", 
                               "#7EC23E",
                               "#C6C6C6")) +
  scale_color_manual(values = pos_neg_5_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-0.7,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
valoracio_distribucio

ggsave(file.path(LIDERS_IMG_FOLDER, "valoracio_liders_distribucio.png"),
       plot = valoracio_distribucio,
       width = 19,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Valoració dels líders segons simpatia de partit

```{r}
valoracio_simpatia <- data |> 
  filter(if_any(contains("CONEIX_"), ~ .x == 1),
         !SIMPATIA_PARTIT_R %in% c(80, 98,99)) |> 
  select(matches("VAL_[A-Z]{1}_[A-Z]{1,}", perl=TRUE),
         SIMPATIA_PARTIT_R, PONDERA) |>
  select(-contains("GOV"),
         SIMPATIA_PARTIT_R, PONDERA) |> 
  pivot_longer(cols = starts_with("VAL_"),
               names_to = "politic", 
               values_to = "valoracio") |> 
  replace_with_na(replace = list(valoracio = c(99, 98))) |> 
  mutate(SIMPATIA_PARTIT_R = as_label(SIMPATIA_PARTIT_R), 
         SIMPATIA_PARTIT_R = clean_party_name(SIMPATIA_PARTIT_R),
         SIMPATIA_PARTIT_R = prettify_party_names(SIMPATIA_PARTIT_R)) |> 
  group_by(SIMPATIA_PARTIT_R, politic) |> 
  summarise(valoracio = round(weighted.mean(valoracio, w = PONDERA, na.rm = T), 
                              digits = 1)) |> 
  mutate(politic = factor(str_replace_all(politic, "VAL_", ""))) |> 
  mutate(politic = prettify_politic_names(politic)) |> 
  mutate(color = case_when(
    valoracio < 3 ~ "0-2",
    valoracio >= 3 & valoracio < 4 ~ "3-4",
    valoracio >= 4  & valoracio < 5 ~ "4-5",
    valoracio >= 5 & valoracio < 7 ~ "5-7",
    valoracio >= 7 & valoracio < 98 ~ "7-10")) |> 
  ggplot() +
geom_tile(aes(fct_relevel(SIMPATIA_PARTIT_R,
                  c("PSC",
                    "ERC",
                    "Junts per Catalunya",
                    "Vox",
                    "En Comú Podem",
                    "CUP",
                    "Ciudadanos*",
                    "PP",
                    "Cap")),
                 fct_relevel(politic,
                           c("Salvador Illa",
                             "Miquel Iceta",
                             "Pere Aragonès",
                             "Oriol Junqueras",
                             "Laura Borràs",
                             "Carles Puigdemont",
                             "Ignacio Garriga",
                             "Jèssica Albiach",
                             "Jaume Asens",
                             "Dolors Sabater",
                             "Eulàlia Reguant",
                             "Carlos Carrizosa",
                             "Inés Arrimadas",
                             "Alejandro Fernández",
                             "Lorena Roldán")),
                fill=color),
            color="white",
            size=1) +
  geom_text(aes(fct_relevel(SIMPATIA_PARTIT_R,
                  c("PSC",
                    "ERC",
                    "Junts per Catalunya",
                    "Vox",
                    "En Comú Podem",
                    "CUP",
                    "Ciudadanos*",
                    "PP",
                    "Cap")),
                 fct_relevel(politic,
                           c("Salvador Illa",
                             "Miquel Iceta",
                             "Pere Aragonès",
                             "Oriol Junqueras",
                             "Laura Borràs",
                             "Carles Puigdemont",
                             "Ignacio Garriga",
                             "Jèssica Albiach",
                             "Jaume Asens",
                             "Dolors Sabater",
                             "Eulàlia Reguant",
                             "Carlos Carrizosa",
                             "Inés Arrimadas",
                             "Alejandro Fernández",
                             "Lorena Roldán")),
                label=point(valoracio)),
            color="white",
            size=6,
            fontface="bold") +
  scale_y_discrete(limits=rev) +
  scale_x_discrete(position="top", 
  labels = scales::label_wrap(10)) +
scale_fill_manual(values = c("0-2" = "#E66060", 
                             "3-4" = "#EE9595",
                             "4-5" = "#F8D256",
                             "5-7" = "#BAE390", 
                             "7-10" = "#7EC23E")) +
  theme_minimal() +
  theme(legend.position="none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.margin = margin(0,1,0,0, "cm"),
        text = element_text(size = 15, 
                            family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
valoracio_simpatia

ggsave(file.path(LIDERS_IMG_FOLDER, "valoracio_liders_simpatia.png"),
       plot = valoracio_simpatia,
       width = 24,
       height = 14,
       dpi = 300,
       units = "cm")
```

# ------------------------------------------------------------------------------

# Economia

## Principal problema

```{r}
principal_problema <- data |> 
  filter(PRE_PROBLEMES == 0) |> 
  select(PROBLEMA_REDUIDA, PONDERA) |> 
   mutate(PROBLEMA_REDUIDA = case_when(
    PROBLEMA_REDUIDA == 100 ~ "Immigració",
    PROBLEMA_REDUIDA == 200 ~ "Atur i precarietat laboral",
    PROBLEMA_REDUIDA == 300 ~ "Accés a l'habitatge",
    PROBLEMA_REDUIDA == 400 ~ "Inseguretat ciutadana",
    PROBLEMA_REDUIDA == 500 ~ "Sanitat",
    PROBLEMA_REDUIDA == 600 ~ "Relacions Catalunya-Espanya",
    PROBLEMA_REDUIDA == 700 ~ "Altres",
    PROBLEMA_REDUIDA == 800 ~ "Insatisfacció amb la política",
    PROBLEMA_REDUIDA == 900 ~ "Educació-cultura-investigació",
    PROBLEMA_REDUIDA == 1000 ~ "Altres",
    PROBLEMA_REDUIDA == 1100 ~ "Incivisme i violència",
    PROBLEMA_REDUIDA == 1200 ~ "Funcionament de l'economia",
    PROBLEMA_REDUIDA == 1300 ~ "Altres",
    PROBLEMA_REDUIDA == 1500 ~ "Excessiva pressió fiscal",
    PROBLEMA_REDUIDA == 1600 ~ "Baix nivell salarial",
    PROBLEMA_REDUIDA == 1700 ~ "Serveis deficients i males instal·lacions públiques",
    PROBLEMA_REDUIDA == 1800 ~ "Millorar polítiques socials",
    PROBLEMA_REDUIDA == 8000 ~ "Altres",
    PROBLEMA_REDUIDA == 8003 ~ "Altres",
    PROBLEMA_REDUIDA == 9400 ~ "Altres",
    TRUE ~ "NS/NC")) |> 
  group_by(PROBLEMA_REDUIDA) |> 
  count(PROBLEMA_REDUIDA, wt = PONDERA) |> 
  ungroup() |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(proportion,
               fct_relevel(PROBLEMA_REDUIDA, 
                           c("Insatisfacció amb la política",
                             "Funcionament de l'economia",
                             "Atur i precarietat laboral",
                             "Relacions Catalunya-Espanya",
                             "Sanitat",
                             "Inseguretat ciutadana",
                             "Millorar polítiques socials",
                             "Accés a l'habitatge",
                             "Educació-cultura-investigació",
                             "Serveis deficients i males instal·lacions públiques",
                             "Incivisme i violència",
                             "Immigració",
                             "Excessiva pressió fiscal",
                             "Baix nivell salarial",
                             "Altres",
                             "NS/NC")),
               fill = PROBLEMA_REDUIDA)) +
    geom_text(aes(x = proportion,
                y = fct_relevel(PROBLEMA_REDUIDA, 
                           c("Insatisfacció amb la política",
                             "Funcionament de l'economia",
                             "Atur i precarietat laboral",
                             "Relacions Catalunya-Espanya",
                             "Sanitat",
                             "Inseguretat ciutadana",
                             "Millorar polítiques socials",
                             "Accés a l'habitatge",
                             "Educació-cultura-investigació",
                             "Serveis deficients i males instal·lacions públiques",
                             "Incivisme i violència",
                             "Immigració",
                             "Excessiva pressió fiscal",
                             "Baix nivell salarial",
                             "Altres",
                             "NS/NC")),
                label = proportion), 
            hjust = -0.3,
            family = "open_sans", 
            color = "#646464",
            fontface = "bold",
            size = 6) +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,50)) +
  scale_y_discrete(limits = rev) +
  scale_fill_manual(values = c("Insatisfacció amb la política" = "#E09330",
                               "Funcionament de l'economia" = "#E09330",
                               "Atur i precarietat laboral" = "#E09330",
                               "Relacions Catalunya-Espanya" = "#E09330",
                               "Sanitat" = "#E09330",
                               "Inseguretat ciutadana" = "#E09330",
                               "Millorar polítiques socials" = "#E09330",
                               "Accés a l'habitatge" = "#E09330",
                               "Educació-cultura-investigació" = "#E09330",
                               "Serveis deficients i males instal·lacions públiques" = "#E09330",
                               "Incivisme i violència" = "#E09330",
                               "Immigració" = "#E09330",
                               "Excessiva pressió fiscal" = "#E09330",
                               "Baix nivell salarial" = "#E09330",
                               "Altres" = "#9E9B9B",
                               "NS/NC" = "#C6C6C6")) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size = 13),
        plot.margin = margin(0.5,1,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
principal_problema

ggsave(file.path(ECO_IMG_FOLDER, "principal_problema.png"),
       plot = principal_problema,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Comparativa situació econòmica Catalunya-Espanya

```{r}
SIT_ECO_CAT_ESP <- data |> 
  select(SIT_ECO_CAT,
         SIT_ECO_ESP,
         PONDERA) |>
  pivot_longer(starts_with("SIT_ECO"), 
               names_to = "categoria", 
               values_to = "resposta") |>
  mutate(categoria = case_when(
  categoria == "SIT_ECO_CAT" ~ "Catalunya",
  categoria == "SIT_ECO_ESP" ~ "Espanya"),
  resposta = case_when(
    resposta == 1 ~ "Molt bona",
    resposta == 2 ~ "Bona",
    resposta == 3 ~ "Ni bona ni dolenta",
    resposta == 4 ~ "Dolenta",
    resposta == 5 ~ "Molt dolenta",
    TRUE ~ "NS/NC"),
    resposta = factor(resposta,
                                levels = c("Molt bona",
                                           "Bona",
                                           "Ni bona ni dolenta",
                                           "Dolenta",
                                           "Molt dolenta",
                                           "NS/NC"))) |>
  group_by(categoria, resposta) |>
  count(categoria, wt = PONDERA) |> 
  ungroup() |>
  group_by(categoria) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |>
  ggplot() +
  geom_col(aes(proportion,
               categoria,
               group = rev(resposta),
               fill = resposta),
           width = 0.5) +
  geom_text(aes(proportion,
                categoria,
                group = rev(resposta),
                label =  ifelse(proportion > 1, proportion, ""),
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  geom_text(aes(x = 0, 
                label = categoria, 
                y = categoria), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = pos_neg_5_colors) +
  scale_color_manual(values = pos_neg_5_text,
                     guide = 'none') +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
SIT_ECO_CAT_ESP

ggsave(file.path(ECO_IMG_FOLDER, "SIT_ECO_CAT_ESP.png"),
       plot = SIT_ECO_CAT_ESP,
       width = 17,
       height = 10,
       dpi = 300,
       units = "cm")
```

## Evolució situació econòmica actual de Catalunya

```{r}
sit_eco_cat_historic <- bop_historic |> 
  mutate(REO = prettify_bop_names(REO)) |> 
  filter(REO %in% c("Nov. 19", 
                    "Feb. 20",
                    "Jul. 20",
                    "Oct. 20",
                    "Març 22",
                    "Juny 22",
                    "Oct. 22")) |> 
  mutate(SIT_ECO_CAT = case_when(
    SIT_ECO_CAT < 3 ~ "Molt bona + bona",
    SIT_ECO_CAT == 3 ~ "Ni bona ni dolenta",
    SIT_ECO_CAT > 3 & SIT_ECO_CAT < 98 ~ "Dolenta + molt dolenta",
    SIT_ECO_CAT > 5 ~ "NS/NC"),
    SIT_ECO_CAT = factor(SIT_ECO_CAT,
                         levels = c("Molt bona + bona",
                                    "Ni bona ni dolenta",
                                    "Dolenta + molt dolenta",
                                    "NS/NC"))) |> 
  group_by(REO, SIT_ECO_CAT) |> 
  count(SIT_ECO_CAT, wt = PONDERA) |>
  ungroup() |> 
  group_by(REO) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(SIT_ECO_CAT != "NS/NC") 

sit_eco_cat_actual <- data |> 
  mutate(REO = "Març 23") |> 
  mutate(SIT_ECO_CAT = case_when(
    SIT_ECO_CAT < 3 ~ "Molt bona + bona",
    SIT_ECO_CAT == 3 ~ "Ni bona ni dolenta",
    SIT_ECO_CAT > 3 & SIT_ECO_CAT < 98 ~ "Dolenta + molt dolenta",
    SIT_ECO_CAT > 5 ~ "NS/NC"),
    SIT_ECO_CAT = factor(SIT_ECO_CAT,
                         levels = c("Molt bona + bona",
                                    "Ni bona ni dolenta",
                                    "Dolenta + molt dolenta",
                                    "NS/NC"))) |> 
  group_by(REO, SIT_ECO_CAT) |> 
  count(SIT_ECO_CAT, wt = PONDERA) |>
  ungroup() |> 
  group_by(REO) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(SIT_ECO_CAT != "NS/NC") 

sit_eco_evol <- rbind(sit_eco_cat_historic, sit_eco_cat_actual)
sit_eco_evol <- sit_eco_evol |> 
  mutate(REO = factor(REO, levels = 
                            c("Nov. 19", 
                              "Feb. 20",
                              "Jul. 20",
                              "Oct. 20",
                              "Març 22",
                              "Juny 22",
                              "Oct. 22",
                              "Març 23")))

sit_eco_cat <- sit_eco_evol |> 
  ggplot() +
  geom_line(aes(REO,
                proportion,
                group = SIT_ECO_CAT,
                color = SIT_ECO_CAT),
            size = 2) +
  geom_point(aes(REO,
                 proportion,
                 group = SIT_ECO_CAT,
                 color = SIT_ECO_CAT),
             size = 4, 
             show.legend = F) +
  geom_label_repel(aes(REO,
                       proportion,
                       group = SIT_ECO_CAT,
                       label = proportion,
                       fill = SIT_ECO_CAT),
                   color = "white",
                   point.padding=unit(1,'lines'),
                   vjust = 0.7,
                   direction='y',
                   size = 5,
                   segment.size = 0,
                   show.legend  = FALSE) +
  scale_y_continuous(limits = c(0,100)) +
  scale_x_discrete(expand = c(0,0.2)) +
  scale_fill_manual(values = pos_neg_3_colors) +
  scale_color_manual(values = pos_neg_3_colors) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-0.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       color = "")
sit_eco_cat

ggsave(file.path(ECO_IMG_FOLDER, "sit_eco_cat.png"),
       plot = sit_eco_cat,
       width = 20,
       height = 14,
       dpi = 300,
       units = "cm")

```

## Evolució situació econòmica actual d’Espanya

```{r}
sit_eco_esp_historic <- bop_historic |> 
  mutate(REO = prettify_bop_names(REO)) |> 
  filter(REO %in% c("Nov. 19", 
                    "Feb. 20",
                    "Jul. 20",
                    "Oct. 20",
                    "Març 22",
                    "Juny 22",
                    "Oct. 22")) |> 
  mutate(SIT_ECO_ESP = case_when(
    SIT_ECO_ESP < 3 ~ "Molt bona + bona",
    SIT_ECO_ESP == 3 ~ "Ni bona ni dolenta",
    SIT_ECO_ESP > 3 & SIT_ECO_ESP < 98 ~ "Dolenta + molt dolenta",
    SIT_ECO_ESP > 5 ~ "NS/NC"),
    SIT_ECO_ESP = factor(SIT_ECO_ESP,
                         levels = c("Molt bona + bona",
                                    "Ni bona ni dolenta",
                                    "Dolenta + molt dolenta",
                                    "NS/NC"))) |> 
  group_by(REO, SIT_ECO_ESP) |> 
  count(SIT_ECO_ESP, wt = PONDERA) |>
  ungroup() |> 
  group_by(REO) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(SIT_ECO_ESP != "NS/NC") 

sit_eco_esp_actual <- data |> 
  mutate(REO = "Març 23") |> 
  mutate(SIT_ECO_ESP = case_when(
    SIT_ECO_ESP < 3 ~ "Molt bona + bona",
    SIT_ECO_ESP == 3 ~ "Ni bona ni dolenta",
    SIT_ECO_ESP > 3 & SIT_ECO_ESP < 98 ~ "Dolenta + molt dolenta",
    SIT_ECO_ESP > 5 ~ "NS/NC"),
    SIT_ECO_ESP = factor(SIT_ECO_ESP,
                         levels = c("Molt bona + bona",
                                    "Ni bona ni dolenta",
                                    "Dolenta + molt dolenta",
                                    "NS/NC"))) |> 
  group_by(REO, SIT_ECO_ESP) |> 
  count(SIT_ECO_ESP, wt = PONDERA) |>
  ungroup() |> 
  group_by(REO) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(SIT_ECO_ESP != "NS/NC") 

sit_eco_esp_evol <- rbind(sit_eco_esp_historic, sit_eco_esp_actual)
sit_eco_esp_evol <- sit_eco_esp_evol |> 
  mutate(REO = factor(REO, levels = 
                            c("Nov. 19", 
                              "Feb. 20",
                              "Jul. 20",
                              "Oct. 20",
                              "Març 22",
                              "Juny 22",
                              "Oct. 22",
                              "Març 23")))

sit_eco_esp <- sit_eco_esp_evol |> 
  ggplot() +
  geom_line(aes(REO,
                proportion,
                group = SIT_ECO_ESP,
                color = SIT_ECO_ESP),
            size = 2) +
  geom_point(aes(REO,
                 proportion,
                 group = SIT_ECO_ESP,
                 color = SIT_ECO_ESP),
             size = 4, 
             show.legend = F) +
  geom_label_repel(aes(REO,
                       proportion,
                       group = SIT_ECO_ESP,
                       label = proportion,
                       fill = SIT_ECO_ESP),
                   color = "white",
                   point.padding=unit(1,'lines'),
                   vjust = 0.7,
                   direction='y',
                   size = 5,
                   segment.size = 0.2,
                   show.legend  = FALSE) +
  scale_y_continuous(limits = c(0,100)) +
  scale_x_discrete(expand = c(0,0.2)) +
  scale_fill_manual(values = pos_neg_3_colors) +
  scale_color_manual(values = pos_neg_3_colors) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-0.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       color = "")
sit_eco_esp

ggsave(file.path(ECO_IMG_FOLDER, "sit_eco_esp.png"),
       plot = sit_eco_esp,
       width = 20,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Situació econòmica retrospectiva de Catalunya

```{r}
sit_eco_ret_historic <- bop_historic |> 
  mutate(REO = prettify_bop_names(REO)) |> 
  filter(REO %in% c("Nov. 19", 
                    "Feb. 20",
                    "Jul. 20",
                    "Oct. 20",
                    "Març 22",
                    "Juny 22",
                    "Oct. 22")) |> 
  as_label() |> 
  group_by(REO, SIT_ECO_CAT_RETROSPECTIVA) |> 
  count(SIT_ECO_CAT_RETROSPECTIVA, wt = PONDERA) |>
  ungroup() |> 
  group_by(REO) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(!SIT_ECO_CAT_RETROSPECTIVA %in% c("No ho sap", "No contesta"))

sit_eco_ret_actual <- data |> 
  mutate(REO = "Març 23") |> 
  as_label() |> 
  group_by(REO, SIT_ECO_CAT_RETROSPECTIVA) |> 
  count(SIT_ECO_CAT_RETROSPECTIVA, wt = PONDERA) |>
  ungroup() |> 
  group_by(REO) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(!SIT_ECO_CAT_RETROSPECTIVA %in% c("No ho sap", "No contesta"))

sit_eco_ret <- rbind(sit_eco_ret_historic, sit_eco_ret_actual)
sit_eco_ret <- sit_eco_ret |> 
  mutate(REO = factor(REO, levels = 
                            c("Nov. 19", 
                              "Feb. 20",
                              "Jul. 20",
                              "Oct. 20",
                              "Març 22",
                              "Juny 22",
                              "Oct. 22",
                              "Març 23")))

sit_eco_ret <- sit_eco_ret |> 
  ggplot() +
  geom_line(aes(REO,
                proportion,
                group = SIT_ECO_CAT_RETROSPECTIVA,
                color = SIT_ECO_CAT_RETROSPECTIVA),
            size = 2) +
  geom_point(aes(REO,
                 proportion,
                 group = SIT_ECO_CAT_RETROSPECTIVA,
                 color = SIT_ECO_CAT_RETROSPECTIVA),
             size = 4, 
             show.legend = F) +
  geom_label_repel(aes(REO,
                       proportion,
                       group = SIT_ECO_CAT_RETROSPECTIVA,
                       label = proportion,
                       fill = SIT_ECO_CAT_RETROSPECTIVA),
                   color = "white",
                   point.padding=unit(1,'lines'),
                   vjust=0.5,
                   direction='y',
                   size = 5,
                   segment.size=0.2,
                   show.legend  = FALSE) +
  scale_y_continuous(limits = c(0,100)) +
  scale_x_discrete(expand = c(0,0.2)) +
  scale_fill_manual(values = pos_neg_3_colors) +
  scale_color_manual(values = pos_neg_3_colors) +
  guides(color = guide_legend(override.aes = list(size = 6))) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-0.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       color = "")
sit_eco_ret

ggsave(file.path(ECO_IMG_FOLDER, "sit_eco_ret.png"),
       plot = sit_eco_ret,
       width = 20,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Situació econòmica prospectiva de Catalunya

```{r}
sit_eco_pros_historic <- bop_historic |> 
  mutate(REO = prettify_bop_names(REO)) |> 
  filter(REO %in% c("Nov. 19", 
                    "Feb. 20",
                    "Jul. 20",
                    "Oct. 20",
                    "Març 22",
                    "Juny 22",
                    "Oct. 22")) |> 
  as_label() |> 
  group_by(REO, SIT_ECO_CAT_PROSPECTIVA) |> 
  count(SIT_ECO_CAT_PROSPECTIVA, wt = PONDERA) |>
  ungroup() |> 
  group_by(REO) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(!SIT_ECO_CAT_PROSPECTIVA %in% c("No ho sap", "No contesta"))

sit_eco_pros_actual <- data |> 
  mutate(REO = "Març 23") |> 
  as_label() |> 
  group_by(REO, SIT_ECO_CAT_PROSPECTIVA) |> 
  count(SIT_ECO_CAT_PROSPECTIVA, wt = PONDERA) |>
  ungroup() |> 
  group_by(REO) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(!SIT_ECO_CAT_PROSPECTIVA %in% c("No ho sap", "No contesta"))

sit_eco_pros <- rbind(sit_eco_pros_historic, sit_eco_pros_actual)
sit_eco_pros <- sit_eco_pros |> 
  mutate(REO = factor(REO, levels = 
                            c("Nov. 19", 
                              "Feb. 20",
                              "Jul. 20",
                              "Oct. 20",
                              "Març 22",
                              "Juny 22",
                              "Oct. 22",
                              "Març 23")))

sit_eco_pros <- sit_eco_pros |> 
  ggplot() +
  geom_line(aes(REO,
                proportion,
                group = SIT_ECO_CAT_PROSPECTIVA,
                color = SIT_ECO_CAT_PROSPECTIVA),
            size = 2) +
  geom_point(aes(REO,
                 proportion,
                 group = SIT_ECO_CAT_PROSPECTIVA,
                 color = SIT_ECO_CAT_PROSPECTIVA),
             size = 4, 
             show.legend = F) +
  geom_label_repel(aes(REO,
                       proportion,
                       group = SIT_ECO_CAT_PROSPECTIVA,
                       label = proportion,
                       fill = SIT_ECO_CAT_PROSPECTIVA),
                   color = "white",
                   point.padding=unit(1,'lines'),
                   vjust=0.5,
                   direction='y',
                   size = 5,
                   segment.size=0.2,
                   show.legend  = FALSE) +
  scale_y_continuous(limits = c(0,100)) +
  scale_x_discrete(expand = c(0,0.2)) +
  scale_fill_manual(values = pos_neg_3_colors) +
  scale_color_manual(values = pos_neg_3_colors) +
  guides(color = guide_legend(override.aes = list(size = 6))) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-0.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       color = "")
sit_eco_pros

ggsave(file.path(ECO_IMG_FOLDER, "sit_eco_pros.png"),
       plot = sit_eco_pros,
       width = 20,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Situació econòmica personal

```{r}
sit_eco_pers_historic <- bop_historic |> 
  mutate(REO = prettify_bop_names(REO)) |> 
  filter(REO %in% c("Nov. 19", 
                    "Feb. 20",
                    "Jul. 20",
                    "Oct. 20",
                    "Març 22",
                    "Juny 22",
                    "Oct. 22")) |> 
  as_label() |> 
  group_by(REO, SIT_ECO_PERSONAL) |> 
  count(SIT_ECO_PERSONAL, wt = PONDERA) |>
  ungroup() |> 
  group_by(REO) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(!SIT_ECO_PERSONAL %in% c("No ho sap", "No contesta"))

sit_eco_pers_actual <- data |> 
  mutate(REO = "Març 23") |> 
  as_label() |> 
  group_by(REO, SIT_ECO_PERSONAL) |> 
  count(SIT_ECO_PERSONAL, wt = PONDERA) |>
  ungroup() |> 
  group_by(REO) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(!SIT_ECO_PERSONAL %in% c("No ho sap", "No contesta"))

sit_eco_pers <- rbind(sit_eco_pers_historic, sit_eco_pers_actual)
sit_eco_pers <- sit_eco_pers |> 
  mutate(REO = factor(REO, levels = 
                            c("Nov. 19", 
                              "Feb. 20",
                              "Jul. 20",
                              "Oct. 20",
                              "Març 22",
                              "Juny 22",
                              "Oct. 22",
                              "Març 23")))

sit_eco_pers <- sit_eco_pers |> 
  ggplot() +
  geom_line(aes(REO,
                proportion,
                group = SIT_ECO_PERSONAL,
                color = SIT_ECO_PERSONAL),
            size = 2) +
  geom_point(aes(REO,
                 proportion,
                 group = SIT_ECO_PERSONAL,
                 color = SIT_ECO_PERSONAL),
             size = 4, 
             show.legend = F) +
  geom_label_repel(aes(REO,
                       proportion,
                       group = SIT_ECO_PERSONAL,
                       label = proportion,
                       fill = SIT_ECO_PERSONAL),
                   color = "white",
                   point.padding=unit(1,'lines'),
                   vjust=0.7,
                   direction='y',
                   size = 5,
                   segment.size=0.2,
                   show.legend  = FALSE) +
  scale_y_continuous(limits = c(0,100)) +
  scale_x_discrete(expand = c(0,0.2)) +
  scale_fill_manual(values = pos_neg_3_colors) +
  scale_color_manual(values = pos_neg_3_colors) +
  guides(color = guide_legend(override.aes = list(size = 6))) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-0.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       color = "")
sit_eco_pers

ggsave(file.path(ECO_IMG_FOLDER, "sit_eco_pers.png"),
       plot = sit_eco_pers,
       width = 20,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Coneix de la taxa anual espanyola 

```{r}
INF_POL_OBJ_INFLACIO <- data |> 
  mutate(INF_POL_OBJ_INFLACIO = case_when(
    INF_POL_OBJ_INFLACIO == 1 ~ "Correcte",
    INF_POL_OBJ_INFLACIO == 2 ~ "Aproximat",
    INF_POL_OBJ_INFLACIO == 3 ~ "Incorrecte",
    INF_POL_OBJ_INFLACIO > 3 ~ "NS/NC"),
    INF_POL_OBJ_INFLACIO = factor(INF_POL_OBJ_INFLACIO,
                                   levels = c("Correcte", "Aproximat", "Incorrecte", "NS/NC"))) |> 
  as_label(drop.levels = FALSE) |> 
  group_by(INF_POL_OBJ_INFLACIO) |> 
  count(INF_POL_OBJ_INFLACIO, wt = PONDERA) |> 
  ungroup() |>  
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ungroup() |> 
  mutate(ymax = cumsum(proportion),
         ymin = c(0, head(ymax, n=-1)),
         labelPosition = (ymax + ymin) / 2) |> 
  ggplot() +
  geom_rect(aes(ymax = ymax, 
                ymin = ymin, 
                xmax = 4, 
                xmin = 3, 
                fill= INF_POL_OBJ_INFLACIO)) +
  geom_text(aes(y=labelPosition,
                label=proportion, 
                color = INF_POL_OBJ_INFLACIO),
            show.legend  = FALSE,
            family = "open_sans",
            fontface = "bold",
            x = 3.5,
            size = 7) +
  scale_fill_manual(values = pos_neg_3_colors) +
  scale_color_manual(values = pos_neg_3_text) + 
  xlim(c(1, 4)) +
  coord_polar(theta="y")  +
  theme_void() +
  theme(legend.position = "bottom",
        plot.margin = margin(0,0,0.5,0, "cm"),
        legend.margin = margin(-0.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black",
                            size = 16)) +
  labs(x = "",
       y = "",
       color = "",
       fill = "")
INF_POL_OBJ_INFLACIO

ggsave(file.path(ECO_IMG_FOLDER, "INF_POL_OBJ_INFLACIO.png"),
       plot = INF_POL_OBJ_INFLACIO,
       width = 14,
       height = 14,
       dpi = 300,
       units = "cm")
```

# ------------------------------------------------------------------------------

# Relacions Catalunya-Espanya

## Percepció del grau d’autonomia assolit

```{r}
AUTONOMIA_CAT <- data |>
  select(PONDERA,
         resposta = AUTONOMIA_CAT) |>
    mutate(resposta = case_when(
    resposta == 1 ~ "Massa autonomia",
    resposta == 2 ~ "Un nivell suficient d'autonomia",
    resposta == 3 ~ "Un nivell insuficient d'autonomia",
    TRUE ~ "NS/NC"),
    resposta = factor(resposta, levels = c("Massa autonomia",
                                           "Un nivell suficient d'autonomia",
                                           "Un nivell insuficient d'autonomia",
                                           "NS/NC"))) |>
  group_by(resposta) |>
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(proportion,
               fct_relevel(resposta, c("Un nivell insuficient d'autonomia",
                                        "Un nivell suficient d'autonomia",
                                        "Massa autonomia",
                                        "NS/NC")),
               fill = resposta), 
           width = 0.5) +
  geom_text(aes(proportion,
                fct_relevel(resposta, c("Un nivell insuficient d'autonomia",
                                        "Un nivell suficient d'autonomia",
                                        "Massa autonomia",
                                        "NS/NC")),
                label = proportion,
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  geom_text(aes(x = 0, 
                label = resposta, 
                y = resposta), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = c("#A67A53",
                               "#728C3B",
                               "#536270",
                               "#C6C6C6")) +
  scale_color_manual(values = c("#FFFFFF",
                                "#FFFFFF",
                                "#FFFFFF",
                                "#585858"),
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,-1,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
AUTONOMIA_CAT

ggsave(file.path(RELS_IMG_FOLDER, "AUTONOMIA_CAT.png"),
       plot = AUTONOMIA_CAT,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Percepció del grau d’autonomia assolit, segons sentiment de pertinença

```{r}
AUTONOMIA_CAT_SENT <- data |>
  select(PONDERA,
         resposta = AUTONOMIA_CAT,
         SENTIMENT_PERTINENCA) |>
  filter(SENTIMENT_PERTINENCA < 6) |> 
    mutate(resposta = case_when(
    resposta == 1 ~ "Massa autonomia",
    resposta == 2 ~ "Un nivell suficient d'autonomia",
    resposta == 3 ~ "Un nivell insuficient d'autonomia",
    TRUE ~ "NS/NC"),
    resposta = factor(resposta, levels = c("Massa autonomia",
                                           "Un nivell suficient d'autonomia",
                                           "Un nivell insuficient d'autonomia",
                                           "NS/NC"))) |>
  as_label(SENTIMENT_PERTINENCA, drop.levels = F) |> 
  group_by(SENTIMENT_PERTINENCA, resposta) |>
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  group_by(SENTIMENT_PERTINENCA) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |>  
  ggplot() +
  geom_col(aes(proportion,
               SENTIMENT_PERTINENCA,
               group = rev(resposta),
               fill = resposta),
           width = 0.5) +
  geom_text(aes(proportion,
                SENTIMENT_PERTINENCA,
                group = rev(resposta),
                label =  ifelse(proportion > 2, proportion, ""),
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  geom_text(aes(x = 0, 
                label = SENTIMENT_PERTINENCA, 
                y = SENTIMENT_PERTINENCA), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = c("#A67A53",
                               "#728C3B",
                               "#536270",
                               "#C6C6C6")) +
  scale_color_manual(values = c("#FFFFFF",
                                "#FFFFFF",
                                "#FFFFFF",
                                "#585858"),
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
AUTONOMIA_CAT_SENT

ggsave(file.path(RELS_IMG_FOLDER, "AUTONOMIA_CAT_SENT.png"),
       plot = AUTONOMIA_CAT_SENT,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Percepció del grau d’autonomia assolit, segons simpatia de partit

```{r}
AUTONOMIA_CAT_SIMP <- data |>
  filter(!SIMPATIA_PARTIT_R %in% c(80, 98,99)) |> 
  select(PONDERA,
         resposta = AUTONOMIA_CAT,
         SIMPATIA_PARTIT_R) |>
    mutate(resposta = case_when(
    resposta == 1 ~ "Massa autonomia",
    resposta == 2 ~ "Un nivell suficient d'autonomia",
    resposta == 3 ~ "Un nivell insuficient d'autonomia",
    TRUE ~ "NS/NC"),
    resposta = factor(resposta, levels = c("Massa autonomia",
                                           "Un nivell suficient d'autonomia",
                                           "Un nivell insuficient d'autonomia",
                                           "NS/NC"))) |>
  mutate(SIMPATIA_PARTIT_R = as_label(SIMPATIA_PARTIT_R), 
         SIMPATIA_PARTIT_R = clean_party_name(SIMPATIA_PARTIT_R),
         SIMPATIA_PARTIT_R = prettify_party_names(SIMPATIA_PARTIT_R)) |> 
  group_by(SIMPATIA_PARTIT_R, resposta) |>
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  group_by(SIMPATIA_PARTIT_R) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |>
  complete(resposta, 
           fill = list(proportion = 0)) |>  
  ggplot() +
  geom_col(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("CUP",
                             "Junts per Catalunya",
                             "ERC",
                             "En Comú Podem",
                             "PSC","Vox",
                             "Ciudadanos*",
                             "PP",
                             "Cap")),
               group = rev(resposta),
               fill = resposta),
           width = 0.8) +
  geom_text(aes(proportion,
                SIMPATIA_PARTIT_R,
                group = rev(resposta),
                label =  ifelse(proportion > 2, proportion, ""),
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = c("#A67A53",
                               "#728C3B",
                               "#536270",
                               "#C6C6C6")) +
  scale_color_manual(values = c("#FFFFFF",
                                "#FFFFFF",
                                "#FFFFFF",
                                "#585858"),
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
AUTONOMIA_CAT_SIMP

ggsave(file.path(RELS_IMG_FOLDER, "AUTONOMIA_CAT_SIMP.png"),
       plot = AUTONOMIA_CAT_SIMP,
       width = 20,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Dret dels catalans a decidir el seu futur com a país en un referèndum

```{r}
DRET_DECIDIR <- data |>
  select(PONDERA,
         resposta = DRET_DECIDIR) |>
    mutate(resposta = case_when(
    resposta == 1 ~ "Molt d'acord",
    resposta == 2 ~ "Bastant d'acord",
    resposta == 3 ~ "Ni d'acord ni en desacord",
    resposta == 4 ~ "En desacord",
    resposta == 5 ~ "Molt en desacord",
    TRUE ~ "NS/NC"),
    resposta = factor(resposta, levels = c("Molt d'acord",
                                           "Bastant d'acord",
                                           "Ni d'acord ni en desacord",
                                           "En desacord",
                                           "Molt en desacord",
                                           "NS/NC"))) |>
  group_by(resposta) |>
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(proportion,
               resposta,
               fill = resposta), 
           width = 0.5) +
  geom_text(aes(proportion,
                resposta,
                label = proportion,
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  geom_text(aes(x = 0, 
                label = resposta, 
                y = resposta), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = pos_neg_5_colors) +
  scale_color_manual(values = pos_neg_5_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,-1,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
DRET_DECIDIR

ggsave(file.path(RELS_IMG_FOLDER, "DRET_DECIDIR.png"),
       plot = DRET_DECIDIR,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Dret dels catalans a decidir el seu futur com a país en un referèndum, segons actituds davant la independència

```{r}
DRET_DECIDIR_INDEP <- data |>
  select(PONDERA,
         resposta = DRET_DECIDIR,
         ACTITUD_INDEPENDENCIA) |>
    mutate(resposta = case_when(
    resposta < 3 ~ "Molt + bastant d'acord",
    resposta == 3 ~ "Ni d'acord ni en desacord",
    resposta > 3 & resposta < 98 ~ "Molt + bastant en desacord",
    resposta > 5 ~ "NS/NC"),
    resposta = factor(resposta,
                         levels = c("Molt + bastant d'acord",
                                    "Ni d'acord ni en desacord",
                                    "Molt + bastant en desacord",
                                    "NS/NC")),
    ACTITUD_INDEPENDENCIA = case_when(
    ACTITUD_INDEPENDENCIA == 1 ~ "Sí",
    ACTITUD_INDEPENDENCIA == 2 ~ "No",
    ACTITUD_INDEPENDENCIA > 2 ~ "NS/NC"),
    ACTITUD_INDEPENDENCIA = factor(ACTITUD_INDEPENDENCIA,
                                   levels = c("Sí", "No", "NS/NC"))) |>
  as_label(ACTITUD_INDEPENDENCIA, drop.levels = F) |> 
  group_by(ACTITUD_INDEPENDENCIA, resposta) |>
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  group_by(ACTITUD_INDEPENDENCIA) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |>  
  ggplot() +
  geom_col(aes(proportion,
               ACTITUD_INDEPENDENCIA,
               group = rev(resposta),
               fill = resposta),
           width = 0.5) +
  geom_text(aes(proportion,
                ACTITUD_INDEPENDENCIA,
                group = rev(resposta),
                label =  ifelse(proportion > 4, proportion, ""),
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
    geom_text(aes(x = 0, 
                label = ACTITUD_INDEPENDENCIA, 
                y = ACTITUD_INDEPENDENCIA), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = pos_neg_3_colors) +
  scale_color_manual(values = pos_neg_3_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
DRET_DECIDIR_INDEP

ggsave(file.path(RELS_IMG_FOLDER, "DRET_DECIDIR_INDEP.png"),
       plot = DRET_DECIDIR_INDEP,
       width = 17,
       height = 12,
       dpi = 300,
       units = "cm")
```

## Dret dels catalans a decidir el seu futur com a país en un referèndum, segons sentiment de pertinença

```{r}
DRET_DECIDIR_SENT <- data |>
  select(PONDERA,
         resposta = DRET_DECIDIR,
         SENTIMENT_PERTINENCA) |>
  filter(SENTIMENT_PERTINENCA < 6) |> 
    mutate(resposta = case_when(
    resposta < 3 ~ "Molt + bastant d'acord",
    resposta == 3 ~ "Ni d'acord ni en desacord",
    resposta > 3 & resposta < 98 ~ "Molt + bastant en desacord",
    resposta > 5 ~ "NS/NC"),
    resposta = factor(resposta,
                         levels = c("Molt + bastant d'acord",
                                    "Ni d'acord ni en desacord",
                                    "Molt + bastant en desacord",
                                    "NS/NC"))) |>
  as_label(SENTIMENT_PERTINENCA, drop.levels = F) |> 
  group_by(SENTIMENT_PERTINENCA, resposta) |>
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  group_by(SENTIMENT_PERTINENCA) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |>  
  ggplot() +
  geom_col(aes(proportion,
               SENTIMENT_PERTINENCA,
               group = rev(resposta),
               fill = resposta),
           width = 0.5) +
  geom_text(aes(proportion,
                SENTIMENT_PERTINENCA,
                group = rev(resposta),
                label =  ifelse(proportion > 1, proportion, ""),
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
    geom_text(aes(x = 0, 
                label = SENTIMENT_PERTINENCA, 
                y = SENTIMENT_PERTINENCA), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = pos_neg_3_colors) +
  scale_color_manual(values = pos_neg_3_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
DRET_DECIDIR_SENT

ggsave(file.path(RELS_IMG_FOLDER, "DRET_DECIDIR_SENT.png"),
       plot = DRET_DECIDIR_SENT,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Dret dels catalans a decidir el seu futur com a país en un referèndum, segons simpatia de partit

```{r}
DRET_DECIDIR_SIMP <- data |>
  filter(!SIMPATIA_PARTIT_R %in% c(80, 98,99)) |>
  select(PONDERA,
         resposta = DRET_DECIDIR,
         SIMPATIA_PARTIT_R) |>
    mutate(resposta = case_when(
    resposta < 3 ~ "Molt + bastant d'acord",
    resposta == 3 ~ "Ni d'acord ni en desacord",
    resposta > 3 & resposta < 98 ~ "Molt + bastant en desacord",
    resposta > 5 ~ "NS/NC"),
    resposta = factor(resposta,
                         levels = c("Molt + bastant d'acord",
                                    "Ni d'acord ni en desacord",
                                    "Molt + bastant en desacord",
                                    "NS/NC"))) |>
  mutate(SIMPATIA_PARTIT_R = as_label(SIMPATIA_PARTIT_R), 
         SIMPATIA_PARTIT_R = clean_party_name(SIMPATIA_PARTIT_R),
         SIMPATIA_PARTIT_R = prettify_party_names(SIMPATIA_PARTIT_R)) |> 
  group_by(SIMPATIA_PARTIT_R, resposta) |>
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  group_by(SIMPATIA_PARTIT_R) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |>
  complete(resposta, 
           fill = list(proportion = 0)) |>  
  ggplot() +
  geom_col(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("CUP",
                             "Junts per Catalunya",
                             "ERC",
                             "En Comú Podem",
                             "PSC",
                             "PP",
                             "Ciudadanos*",
                             "Vox",
                             "Cap")),
               group = rev(resposta),
               fill = resposta),
           width = 0.8) +
  geom_text(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("CUP",
                             "Junts per Catalunya",
                             "ERC",
                             "En Comú Podem",
                             "PSC",
                             "PP",
                             "Ciudadanos*",
                             "Vox",
                             "Cap")),
                group = rev(resposta),
                label =  ifelse(proportion > 1, proportion, ""),
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = pos_neg_3_colors) +
  scale_color_manual(values = pos_neg_3_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
DRET_DECIDIR_SIMP

ggsave(file.path(RELS_IMG_FOLDER, "DRET_DECIDIR_SIMP.png"),
       plot = DRET_DECIDIR_SIMP,
       width = 19,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Posicionament sobre la independència 

```{r}
pos_indep <- data |> 
  mutate(ACTITUD_INDEPENDENCIA = case_when(
    ACTITUD_INDEPENDENCIA == 1 ~ "Sí",
    ACTITUD_INDEPENDENCIA == 2 ~ "No",
    ACTITUD_INDEPENDENCIA > 2 ~ "NS/NC"),
    ACTITUD_INDEPENDENCIA = factor(ACTITUD_INDEPENDENCIA,
                                   levels = c("Sí", "No", "NS/NC"))) |> 
  as_label(drop.levels = FALSE) |> 
  group_by(ACTITUD_INDEPENDENCIA) |> 
 count(ACTITUD_INDEPENDENCIA, wt = PONDERA) |>
  ungroup() |>  
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ungroup() |> 
  mutate(ymax = cumsum(proportion),
         ymin = c(0, head(ymax, n=-1)),
         labelPosition = (ymax + ymin) / 2) |> 
  ggplot() +
  geom_rect(aes(ymax = ymax, 
                ymin = ymin, 
                xmax = 4, 
                xmin = 3, 
                fill= ACTITUD_INDEPENDENCIA)) +
  geom_text(aes(y=labelPosition,
                label=proportion, 
                color= ACTITUD_INDEPENDENCIA),
            show.legend  = FALSE,
            family = "open_sans",
            fontface = "bold",
            x = 3.5,
            size = 7) +
  scale_fill_manual(values = pos_neg_2_colors) +
  scale_color_manual(values = pos_neg_2_text,
                     guide = "none") +
  xlim(c(1, 4)) +
  coord_polar(theta="y")  +
  theme_void() +
  theme(legend.position = "bottom",
        plot.margin = margin(0,0,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black",
                            size = 16)) +
  labs(x = "",
       y = "",
       color = "",
       fill = "")
pos_indep

ggsave(file.path(RELS_IMG_FOLDER, "pos_indep.png"),
       plot = pos_indep,
       width = 14,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Posicionament sobre la independència (històric)

```{r}
pos_indep_historic <- bop_historic |> 
  mutate(REO = prettify_bop_names(REO)) |> 
  filter(REO %in% c("Feb. 15",
                    "Juny 15",
                    "Oct. 15",
                    "Feb. 16",
                    "Juny 16",
                    "Oct. 16",
                    "Març 17",
                    "Juny 17",
                    "Oct. 17",
                    "Abril 18",
                    "Juny 18",
                    "Oct. 18",
                    "Març 19",
                    "Jul. 19",
                    "Nov. 19", 
                    "Feb. 20",
                    "Jul. 20",
                    "Oct. 20",
                    "Març 22",
                    "Juny 22",
                    "Oct. 22")) |> 
  mutate(ACTITUD_INDEPENDENCIA = case_when(
    ACTITUD_INDEPENDENCIA == 1 ~ "Sí",
    ACTITUD_INDEPENDENCIA == 2 ~ "No",
    ACTITUD_INDEPENDENCIA > 2 ~ "NS/NC"),
    ACTITUD_INDEPENDENCIA = factor(ACTITUD_INDEPENDENCIA,
                                   levels = c("Sí", "No", "NS/NC"))) |> 
  group_by(REO, ACTITUD_INDEPENDENCIA) |> 
  count(ACTITUD_INDEPENDENCIA, wt = PONDERA) |>
  ungroup() |> 
  group_by(REO) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(ACTITUD_INDEPENDENCIA != "NS/NC") 

pos_indep_actual <- data |> 
  mutate(REO = "Març 23") |> 
  mutate(ACTITUD_INDEPENDENCIA = case_when(
    ACTITUD_INDEPENDENCIA == 1 ~ "Sí",
    ACTITUD_INDEPENDENCIA == 2  ~ "No",
    ACTITUD_INDEPENDENCIA >= 3   ~ "NS/NC"),
    ACTITUD_INDEPENDENCIA = factor(ACTITUD_INDEPENDENCIA,
                                   levels = c("Sí", "No", "NS/NC"))) |> 
  group_by(REO, ACTITUD_INDEPENDENCIA) |> 
  count(ACTITUD_INDEPENDENCIA, wt = PONDERA) |>
  group_by(REO) |>
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(ACTITUD_INDEPENDENCIA != "NS/NC") 

pos_indep_evol <- rbind(pos_indep_historic, pos_indep_actual)
pos_indep_evol <- pos_indep_evol |> 
  mutate(REO = factor(REO, levels = 
                            c("Feb. 15",
                              "Juny 15",
                              "Oct. 15",
                              "Feb. 16",
                              "Juny 16",
                              "Oct. 16",
                              "Març 17",
                              "Juny 17",
                              "Oct. 17",
                              "Abril 18",
                              "Juny 18",
                              "Oct. 18",
                              "Març 19",
                              "Jul. 19",
                              "Nov. 19", 
                              "Feb. 20",
                              "Jul. 20",
                              "Oct. 20",
                              "Març 22",
                              "Juny 22",
                              "Oct. 22",
                              "Març 23")))

indep_evol <- pos_indep_evol |>
  ggplot() +
  geom_line(aes(REO,
                proportion,
                group = ACTITUD_INDEPENDENCIA,
                color = ACTITUD_INDEPENDENCIA),
            size = 1) +
  geom_point(aes(REO,
                 proportion,
                 group = ACTITUD_INDEPENDENCIA,
                 color = ACTITUD_INDEPENDENCIA),
             size = 2.5,
             show.legend  = FALSE) +
  geom_label_repel(aes(REO,
                       proportion,
                       group = ACTITUD_INDEPENDENCIA,
                       label = round(proportion, digits = 0),
                       fill = ACTITUD_INDEPENDENCIA),
                   color = "white",
                   point.padding=unit(1,'lines'),
                   vjust=0.5,
                   size = 5,
                   direction='y',
                   segment.size=0.2,
                   show.legend  = FALSE) +
  scale_y_continuous(limits = c(0,100)) +
  scale_fill_manual(values = pos_neg_2_colors) +
  scale_color_manual(values = pos_neg_2_colors,
                     guide = "none") +
  guides(color = guide_legend(override.aes = list(size = 6))) + 
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.margin = margin(0,0,0.5,0, "cm"),
        legend.margin = margin(-0.5,0,0,0, "cm"),
        axis.text.x = element_text(angle = 45, hjust=1),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        text = element_text(family = "open_sans", 
                            color  = "black",
                            size = 16)) +
  labs(x = "",
       y = "",
       color = "",
       fill = "")
indep_evol

ggsave(file.path(RELS_IMG_FOLDER, "indep_evol.png"),
       plot = indep_evol,
       width = 25,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Posicionament sobre la independència, segons simpatia de partit

```{r}
ACTITUD_INDEPENDENCIA_SIMP <- data |> 
  filter(!SIMPATIA_PARTIT_R %in% c(80, 98,99)) |>
  mutate(ACTITUD_INDEPENDENCIA = case_when(
    ACTITUD_INDEPENDENCIA == 1 ~ "Sí",
    ACTITUD_INDEPENDENCIA == 2 ~ "No",
    ACTITUD_INDEPENDENCIA > 2 ~ "NS/NC"),
    ACTITUD_INDEPENDENCIA = factor(ACTITUD_INDEPENDENCIA,
                                   levels = c("Sí", "No", "NS/NC"))) |> 
    mutate(SIMPATIA_PARTIT_R = as_label(SIMPATIA_PARTIT_R), 
         SIMPATIA_PARTIT_R = clean_party_name(SIMPATIA_PARTIT_R),
         SIMPATIA_PARTIT_R = prettify_party_names(SIMPATIA_PARTIT_R)) |> 
  group_by(SIMPATIA_PARTIT_R, ACTITUD_INDEPENDENCIA) |> 
  count(ACTITUD_INDEPENDENCIA, wt = PONDERA) |>
  ungroup() |>  
  group_by(SIMPATIA_PARTIT_R) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |>
  complete(ACTITUD_INDEPENDENCIA, 
           fill = list(proportion = 0)) |> 
     ggplot() +
  geom_col(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("CUP",
                             "Junts per Catalunya",
                             "ERC",
                             "En Comú Podem",
                             "PSC",
                             "PP",
                             "Ciudadanos*",
                             "Vox",
                             "Cap")),
               group = rev(ACTITUD_INDEPENDENCIA),
               fill = ACTITUD_INDEPENDENCIA),
           width = 0.8) +
  geom_text(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("CUP",
                             "Junts per Catalunya",
                             "ERC",
                             "En Comú Podem",
                             "PSC",
                             "PP",
                             "Ciudadanos*",
                             "Vox",
                             "Cap")),
                group = rev(ACTITUD_INDEPENDENCIA),
                label =  ifelse(proportion > 2, proportion, ""),
                color = ACTITUD_INDEPENDENCIA), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = pos_neg_2_colors) +
  scale_color_manual(values = pos_neg_2_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
ACTITUD_INDEPENDENCIA_SIMP

ggsave(file.path(RELS_IMG_FOLDER, "ACTITUD_INDEPENDENCIA_SIMP.png"),
       plot = ACTITUD_INDEPENDENCIA_SIMP,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Canvi d’actitud davant la independència de Catalunya

```{r}
ACTITUD_INDEP_CANVI <- data |> 
  mutate(grup = "Població general",
         ACTITUD_INDEP_CANVI = case_when(
    ACTITUD_INDEP_CANVI == 1 ~ "Sí, sempre he tingut aquesta opinió",
    ACTITUD_INDEP_CANVI == 2 ~ "No, abans havia tingut una altra opinió",
    TRUE ~ "NS/NC"),
    ACTITUD_INDEP_CANVI = factor(ACTITUD_INDEP_CANVI,
                                levels = c("Sí, sempre he tingut aquesta opinió",
                                           "No, abans havia tingut una altra opinió",
                                           "NS/NC"))) |> 
  group_by(grup, ACTITUD_INDEP_CANVI) |>
  count(ACTITUD_INDEP_CANVI, wt = PONDERA) |> 
  ungroup() |>
  group_by(grup) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |>
  ggplot() +
  geom_col(aes(proportion,
               grup,
               group = rev(ACTITUD_INDEP_CANVI),
               fill = ACTITUD_INDEP_CANVI), 
           width = 0.8) +
  geom_text(aes(proportion,
                grup,
                group = rev(ACTITUD_INDEP_CANVI),
                label = proportion,
                color = ACTITUD_INDEP_CANVI), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  scale_fill_manual(values = pos_neg_2_colors) +
  scale_color_manual(values = pos_neg_2_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black"),
        axis.text = element_blank()) +
  labs(x = "",
       y = "",
       fill = "")
ACTITUD_INDEP_CANVI

ggsave(file.path(RELS_IMG_FOLDER, "ACTITUD_INDEP_CANVI.png"),
       plot = ACTITUD_INDEP_CANVI,
       width = 17,
       height = 5,
       dpi = 300,
       units = "cm")
```

## Data en què van canviar el posicionament sobre la independència de Catalunya

```{r}
ACTITUD_INDEP_CANVI_TEMPS <- data |> 
  filter(ACTITUD_INDEP_CANVI == 2) |> 
  mutate(grup = "Població general",
         ACTITUD_INDEP_CANVI_TEMPS = case_when(
    ACTITUD_INDEP_CANVI_TEMPS == 1 ~ "Fa dos anys o menys",
    ACTITUD_INDEP_CANVI_TEMPS == 2 ~ "Fa entre 2 i 6 anys (Després del 2017)",
    ACTITUD_INDEP_CANVI_TEMPS == 3 ~ "Fa més 6 anys (Abans del 2017)",
    TRUE ~ "NS/NC"),
    ACTITUD_INDEP_CANVI_TEMPS = factor(ACTITUD_INDEP_CANVI_TEMPS,
                                levels = c("Fa dos anys o menys",
                                           "Fa entre 2 i 6 anys (Després del 2017)",
                                           "Fa més 6 anys (Abans del 2017)",
                                           "NS/NC"))) |> 
  group_by(grup, ACTITUD_INDEP_CANVI_TEMPS) |>
  count(ACTITUD_INDEP_CANVI_TEMPS, wt = PONDERA) |> 
  ungroup() |>
  group_by(grup) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |>
  ggplot() +
  geom_col(aes(proportion,
               grup,
               group = rev(ACTITUD_INDEP_CANVI_TEMPS),
               fill = ACTITUD_INDEP_CANVI_TEMPS), 
           width = 0.8) +
  geom_text(aes(proportion,
                grup,
                group = rev(ACTITUD_INDEP_CANVI_TEMPS),
                label = proportion,
                color = ACTITUD_INDEP_CANVI_TEMPS), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  scale_fill_manual(values = c("#E66060",
                               "#F09F9F",
                               "#FADFDF",
                               "#C6C6C6")) +
  scale_color_manual(values = c("#FFFFFF",
                                "#585858",
                                "#585858",
                                "#585858"),
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 3)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black"),
        axis.text = element_blank()) +
  labs(x = "",
       y = "",
       fill = "",
       subtitle = "Data en què van canviar el posicionament")
ACTITUD_INDEP_CANVI_TEMPS

ggsave(file.path(RELS_IMG_FOLDER, "ACTITUD_INDEP_CANVI_TEMPS.png"),
       plot = ACTITUD_INDEP_CANVI_TEMPS,
       width = 17,
       height = 6,
       dpi = 300,
       units = "cm")
```

## Canvi d’actitud davant la independència de Catalunya, segons simpatia de partit

```{r}
ACTITUD_INDEP_CANVI_SIMP <- data |> 
  filter(!SIMPATIA_PARTIT_R %in% c(80, 98,99)) |>
  mutate(ACTITUD_INDEP_CANVI = case_when(
    ACTITUD_INDEP_CANVI == 1 ~ "Sí, sempre he tingut aquesta opinió",
    ACTITUD_INDEP_CANVI == 2 ~ "No, abans havia tingut una altra opinió",
    TRUE ~ "NS/NC"),
    ACTITUD_INDEP_CANVI = factor(ACTITUD_INDEP_CANVI,
                                levels = c("Sí, sempre he tingut aquesta opinió",
                                           "No, abans havia tingut una altra opinió",
                                           "NS/NC"))) |> 
  mutate(SIMPATIA_PARTIT_R = as_label(SIMPATIA_PARTIT_R), 
         SIMPATIA_PARTIT_R = clean_party_name(SIMPATIA_PARTIT_R),
         SIMPATIA_PARTIT_R = prettify_party_names(SIMPATIA_PARTIT_R)) |> 
  group_by(SIMPATIA_PARTIT_R, ACTITUD_INDEP_CANVI) |>
  count(ACTITUD_INDEP_CANVI, wt = PONDERA) |> 
  ungroup() |>
  group_by(SIMPATIA_PARTIT_R) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |>
  complete(ACTITUD_INDEP_CANVI, 
           fill = list(proportion = 0)) |> 
  ggplot() +
  geom_col(aes(proportion,
              fct_relevel(SIMPATIA_PARTIT_R,
                           c("Ciudadanos*",
                             "Vox",
                             "PP",
                             "PSC",
                             "Junts per Catalunya",
                             "ERC",
                             "CUP",
                             "En Comú Podem",
                             "Cap")),
               group = rev(ACTITUD_INDEP_CANVI),
               fill = ACTITUD_INDEP_CANVI),
           width = 0.8) +
  geom_text(aes(proportion,
              fct_relevel(SIMPATIA_PARTIT_R,
                           c("Ciudadanos*",
                             "Vox",
                             "PP",
                             "PSC",
                             "Junts per Catalunya",
                             "ERC",
                             "CUP",
                             "En Comú Podem",
                             "Cap")),
                group = rev(ACTITUD_INDEP_CANVI),
                label =  ifelse(proportion > 2, proportion, ""),
                color = ACTITUD_INDEP_CANVI), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = pos_neg_2_colors) +
  scale_color_manual(values = pos_neg_2_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
ACTITUD_INDEP_CANVI_SIMP

ggsave(file.path(RELS_IMG_FOLDER, "ACTITUD_INDEP_CANVI_SIMP.png"),
       plot = ACTITUD_INDEP_CANVI_SIMP,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Canvi d’opinió sobre la independència, per posicionament independència

```{r}
ACTITUD_INDEPENDENCIA_CANVI <- data |> 
  mutate(ACTITUD_INDEPENDENCIA = case_when(
    ACTITUD_INDEPENDENCIA == 1 ~ "Sí",
    ACTITUD_INDEPENDENCIA == 2 ~ "No",
    ACTITUD_INDEPENDENCIA > 2 ~ "NS/NC"),
    ACTITUD_INDEPENDENCIA = factor(ACTITUD_INDEPENDENCIA,
                                   levels = c("Sí", "No", "NS/NC")),
    ACTITUD_INDEP_CANVI = case_when(
    ACTITUD_INDEP_CANVI == 1 ~ "Sí, sempre he tingut aquesta opinió",
    ACTITUD_INDEP_CANVI == 2 ~ "No, abans havia tingut una altra opinió",
    TRUE ~ "NS/NC"),
    ACTITUD_INDEP_CANVI = factor(ACTITUD_INDEP_CANVI,
                                levels = c("Sí, sempre he tingut aquesta opinió",
                                           "No, abans havia tingut una altra opinió",
                                           "NS/NC"))) |> 
  group_by(ACTITUD_INDEPENDENCIA, ACTITUD_INDEP_CANVI) |> 
  count(ACTITUD_INDEPENDENCIA, wt = PONDERA) |>
  ungroup() |>  
  group_by(ACTITUD_INDEPENDENCIA) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
   geom_col(aes(proportion,
               ACTITUD_INDEPENDENCIA,
               group = rev(ACTITUD_INDEP_CANVI),
               fill = ACTITUD_INDEP_CANVI),
           width = 0.5) +
  geom_text(aes(proportion,
                ACTITUD_INDEPENDENCIA,
                group = rev(ACTITUD_INDEP_CANVI),
                label = ifelse(proportion > 1, proportion, ""),
                color = ACTITUD_INDEP_CANVI), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  geom_text(aes(x = 0, 
                label = ACTITUD_INDEPENDENCIA, 
                y = ACTITUD_INDEPENDENCIA), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = pos_neg_2_colors) +
  scale_color_manual(values = pos_neg_2_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
ACTITUD_INDEPENDENCIA_CANVI

ggsave(file.path(RELS_IMG_FOLDER, "ACTITUD_INDEPENDENCIA_CANVI.png"),
       plot = ACTITUD_INDEPENDENCIA_CANVI,
       width = 17,
       height = 12,
       dpi = 300,
       units = "cm")
```

## Preferència sobre la relació Catalunya-Espanya

```{r}
RELACIONS_CAT_ESP <- data |>
  select(PONDERA,
         resposta = RELACIONS_CAT_ESP) |>
    mutate(resposta = case_when(
    resposta == 1 ~ "Una regió d'Espanya",
    resposta == 2 ~ "Una comunitat autònoma d'Espanya",
    resposta == 3 ~ "Un estat dins una Espanya federal",
    resposta == 4 ~ "Un estat independent",
    TRUE ~ "NS/NC"),
    resposta = factor(resposta, levels = c("Una regió d'Espanya",
                                           "Una comunitat autònoma d'Espanya",
                                           "Un estat dins una Espanya federal",
                                           "Un estat independent",
                                           "NS/NC"))) |>
  group_by(resposta) |>
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(proportion,
               fct_relevel(resposta,
                           c("Un estat independent",
                             "Una comunitat autònoma d'Espanya",
                             "Un estat dins una Espanya federal",
                             "Una regió d'Espanya",
                             "NS/NC")),
               fill = resposta), 
           width = 0.5) +
  geom_text(aes(proportion,
               fct_relevel(resposta,
                           c("Un estat independent",
                             "Una comunitat autònoma d'Espanya",
                             "Un estat dins una Espanya federal",
                             "Una regió d'Espanya",
                             "NS/NC")),
                label = proportion,
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  geom_text(aes(x = 0, 
                label = resposta, 
                y = resposta), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = c("#AE8055",
                               "#77933C",
                               "#DCAF48",
                               "#5C7E91",
                               "#C6C6C6")) +
  scale_color_manual(values = c("#FFFFFF",
                                "#FFFFFF",
                                "#585858",
                                "#FFFFFF",
                                "#585858"),
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,-1,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
RELACIONS_CAT_ESP

ggsave(file.path(RELS_IMG_FOLDER, "RELACIONS_CAT_ESP.png"),
       plot = RELACIONS_CAT_ESP,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Preferència sobre la relació Catalunya-Espanya (històric) 

```{r}
pref_rel_cat_esp_historic <- bop_historic |> 
  mutate(REO = prettify_bop_names(REO)) |> 
  filter(REO %in% c("Feb. 15",
                    "Juny 15",
                    "Oct. 15",
                    "Feb. 16",
                    "Juny 16",
                    "Oct. 16",
                    "Març 17",
                    "Juny 17",
                    "Oct. 17",
                    "Abril 18",
                    "Juny 18",
                    "Oct. 18",
                    "Març 19",
                    "Jul. 19",
                    "Nov. 19", 
                    "Feb. 20",
                    "Jul. 20",
                    "Oct. 20",
                    "Març 22",
                    "Juny 22",
                    "Oct. 22")) |> 
  as_label(RELACIONS_CAT_ESP, drop.levels = F) |> 
  group_by(REO, RELACIONS_CAT_ESP) |> 
  count(RELACIONS_CAT_ESP, wt = PONDERA) |>
  ungroup() |> 
  group_by(REO) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion),
         RELACIONS_CAT_ESP = factor(RELACIONS_CAT_ESP,
                                    levels = RELACIONS_CAT_ESP)) |> 
  filter(!RELACIONS_CAT_ESP %in% c("No ho sap", "No contesta"))

pref_rel_cat_esp_actual <- data |> 
  mutate(REO = "Març 23") |> 
  as_label(RELACIONS_CAT_ESP, drop.levels = F) |> 
  group_by(REO, RELACIONS_CAT_ESP) |> 
  count(RELACIONS_CAT_ESP, wt = PONDERA) |>
  ungroup() |> 
  group_by(REO) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion),
         RELACIONS_CAT_ESP = factor(RELACIONS_CAT_ESP,
                                    levels = RELACIONS_CAT_ESP)) |> 
  filter(!RELACIONS_CAT_ESP %in% c("No ho sap", "No contesta"))

pref_rel_cat_esp <- rbind(pref_rel_cat_esp_historic, pref_rel_cat_esp_actual)
pref_rel_cat_esp <- pref_rel_cat_esp |> 
  mutate(REO = factor(REO, levels = 
                            c("Feb. 15",
                              "Juny 15",
                              "Oct. 15",
                              "Feb. 16",
                              "Juny 16",
                              "Oct. 16",
                              "Març 17",
                              "Juny 17",
                              "Oct. 17",
                              "Abril 18",
                              "Juny 18",
                              "Oct. 18",
                              "Març 19",
                              "Jul. 19",
                              "Nov. 19", 
                              "Feb. 20",
                              "Jul. 20",
                              "Oct. 20",
                              "Març 22",
                              "Juny 22",
                              "Oct. 22",
                              "Març 23")))

pref_rel_cat_esp <- pref_rel_cat_esp |> 
  ggplot() +
  geom_line(aes(REO,
                proportion,
                group = RELACIONS_CAT_ESP,
                color = RELACIONS_CAT_ESP),
            size = 2) +
  geom_point(aes(REO,
                 proportion,
                 group = RELACIONS_CAT_ESP,
                 color = RELACIONS_CAT_ESP),
             size = 4, 
             show.legend = F) +
  geom_label_repel(aes(REO,
                       proportion,
                       group = RELACIONS_CAT_ESP,
                       label = proportion,
                       fill = RELACIONS_CAT_ESP),
                   color = "white",
                   point.padding=unit(1,'lines'),
                   vjust=0.5,
                   direction='y',
                   segment.size = 0.2,
                   show.legend  = FALSE) +
  guides(color = guide_legend(override.aes = list(size = 6),
                              ncol = 2)) +
  scale_fill_manual(values = c("#AE8055",
                               "#77933C",
                               "#DCAF48",
                               "#5C7E91",
                               "#C6C6C6")) +
  scale_color_manual(values = c("#AE8055",
                               "#77933C",
                               "#DCAF48",
                               "#5C7E91",
                               "#C6C6C6"),
                     guide = "none") +
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.margin = margin(0,0,0.5,0, "cm"),
        legend.margin = margin(-0.5,0,0,0, "cm"),
        axis.text.x = element_text(angle = 45, hjust=1),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        text = element_text(family = "open_sans", 
                            color  = "black",
                            size = 16)) +
  labs(x = "",
       y = "",
       color = "")
pref_rel_cat_esp

ggsave(file.path(RELS_IMG_FOLDER, "pref_rel_cat_esp.png"),
       plot = pref_rel_cat_esp,
       width = 25,
       height = 13,
       dpi = 300,
       units = "cm")
```

## Preferència sobre la relació Catalunya-Espanya, segons simpatia de partit

```{r}
RELACIONS_CAT_ESP_SIMP <- data |>
  select(PONDERA,
         SIMPATIA_PARTIT_R,
         resposta = RELACIONS_CAT_ESP) |>
  filter(!SIMPATIA_PARTIT_R %in% c(80, 98,99)) |>
    mutate(resposta = case_when(
    resposta == 1 ~ "Una regió d'Espanya",
    resposta == 2 ~ "Una comunitat autònoma d'Espanya",
    resposta == 3 ~ "Un estat dins una Espanya federal",
    resposta == 4 ~ "Un estat independent",
    TRUE ~ "NS/NC"),
    resposta = factor(resposta, levels = c("Una regió d'Espanya",
                                           "Una comunitat autònoma d'Espanya",
                                           "Un estat dins una Espanya federal",
                                           "Un estat independent",
                                           "NS/NC"))) |>
  mutate(SIMPATIA_PARTIT_R = as_label(SIMPATIA_PARTIT_R), 
         SIMPATIA_PARTIT_R = clean_party_name(SIMPATIA_PARTIT_R),
         SIMPATIA_PARTIT_R = prettify_party_names(SIMPATIA_PARTIT_R)) |> 
  group_by(SIMPATIA_PARTIT_R, resposta) |>
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  group_by(SIMPATIA_PARTIT_R) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |>
  complete(resposta, 
           fill = list(proportion = 0)) |> 
  ggplot() +
  geom_col(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("Junts per Catalunya",
                             "CUP",
                             "ERC",
                             "En Comú Podem",
                             "PSC",
                             "PP",
                             "Ciudadanos*",
                             "Vox",
                             "Cap")),
               group = rev(resposta),
               fill = resposta), 
           width = 0.8) +
  geom_text(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("Junts per Catalunya",
                             "CUP",
                             "ERC",
                             "En Comú Podem",
                             "PSC",
                             "PP",
                             "Ciudadanos*",
                             "Vox",
                             "Cap")),
                group = rev(resposta),
                label =  ifelse(proportion > 2, proportion, ""),
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  scale_fill_manual(values = c("#AE8055",
                               "#77933C",
                               "#DCAF48",
                               "#5C7E91",
                               "#C6C6C6")) +
  scale_color_manual(values = c("#FFFFFF",
                                "#FFFFFF",
                                "#585858",
                                "#FFFFFF",
                                "#585858"),
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 4)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
RELACIONS_CAT_ESP_SIMP

ggsave(file.path(RELS_IMG_FOLDER, "RELACIONS_CAT_ESP_SIMP.png"),
       plot = RELACIONS_CAT_ESP_SIMP,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Segona preferència sobre la relació Catalunya-Espanya, per primera preferència

```{r}
RELACIONS_CAT_ESP_2 <- data |> 
  mutate(RELACIONS_CAT_ESP = case_when(
    RELACIONS_CAT_ESP == 1 ~ "Una regió d'Espanya",
    RELACIONS_CAT_ESP == 2 ~ "Una comunitat autònoma d'Espanya",
    RELACIONS_CAT_ESP == 3 ~ "Un estat dins una Espanya federal",
    RELACIONS_CAT_ESP == 4 ~ "Un estat independent",
    TRUE ~ "NS/NC"),
    RELACIONS_CAT_ESP = factor(RELACIONS_CAT_ESP, levels = c("Una regió d'Espanya",
                                           "Una comunitat autònoma d'Espanya",
                                           "Un estat dins una Espanya federal",
                                           "Un estat independent",
                                           "NS/NC")),
    RELACIONS_CAT_ESP_2 = case_when(
    RELACIONS_CAT_ESP_2 == 1 ~ "Una regió d'Espanya",
    RELACIONS_CAT_ESP_2 == 2 ~ "Una comunitat autònoma d'Espanya",
    RELACIONS_CAT_ESP_2 == 3 ~ "Un estat dins una Espanya federal",
    RELACIONS_CAT_ESP_2 == 4 ~ "Un estat independent",
    RELACIONS_CAT_ESP_2 == 5 ~ "Cap altre",
    TRUE ~ "NS/NC"),
    RELACIONS_CAT_ESP_2 = factor(RELACIONS_CAT_ESP_2, levels = c("Una regió d'Espanya",
                                           "Una comunitat autònoma d'Espanya",
                                           "Un estat dins una Espanya federal",
                                           "Un estat independent",
                                           "Cap altre",
                                           "NS/NC"))) |> 
  group_by(RELACIONS_CAT_ESP, RELACIONS_CAT_ESP_2) |> 
  summarize(n = length(RELACIONS_CAT_ESP)) |>  
  ungroup() |>  
  group_by(RELACIONS_CAT_ESP) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(RELACIONS_CAT_ESP != "NS/NC") |> 
  ggplot() + 
  geom_col(aes(proportion, 
               reorder_within(RELACIONS_CAT_ESP_2, proportion, RELACIONS_CAT_ESP), 
               fill = RELACIONS_CAT_ESP_2)) +
  geom_vline(aes(xintercept = 0)) +
  geom_text(aes(x = proportion,
                y = reorder_within(RELACIONS_CAT_ESP_2, proportion, RELACIONS_CAT_ESP), 
                label = proportion),
            fontface = "bold",
            size = 5,
            hjust = -0.3) +
  scale_y_reordered() +
  scale_x_continuous(limits = c(0,75),
                     expand = c(0,0)) +
  scale_fill_manual(values = c("#AE8055",
                               "#77933C",
                               "#DCAF48",
                               "#5C7E91",
                               "#9E9B9B",
                               "#C6C6C6")) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        text = element_text(family = "open_sans",
                            size = 15,
                            color  = "black"),
        strip.text.x = element_text(hjust=0)) +
  labs(x = "",
       y = "") +
facet_wrap(vars(RELACIONS_CAT_ESP), 
             nrow=3,
             scales = "free_y")
RELACIONS_CAT_ESP_2

ggsave(file.path(RELS_IMG_FOLDER, "RELACIONS_CAT_ESP_2.png"),
       plot = RELACIONS_CAT_ESP_2,
       width = 30,
       height = 12,
       dpi = 300,
       units = "cm")
```

## Actituds davant la independència (general)

```{r}
act_indep <- data |> 
  mutate(RELACIONS_CAT_ESP_1_5 = case_when(
    RELACIONS_CAT_ESP_1_5 == 1 ~ "Independència unilateral",
    RELACIONS_CAT_ESP_1_5 == 2 ~ "Independència pactada",
    RELACIONS_CAT_ESP_1_5 == 3 ~ "Sense posició definida",
    RELACIONS_CAT_ESP_1_5 == 4 ~ "Unitat d'Espanya pactada",
    RELACIONS_CAT_ESP_1_5 == 5 ~ "Unitat d'Espanya sense negociació",
    RELACIONS_CAT_ESP_1_5 > 5 ~ "NS/NC"), 
    RELACIONS_CAT_ESP_1_5 = factor(RELACIONS_CAT_ESP_1_5,
                                   levels = c("Independència unilateral",
                                              "Independència pactada",
                                              "Sense posició definida",
                                              "Unitat d'Espanya pactada",
                                              "Unitat d'Espanya sense negociació",
                                              "NS/NC"))) |> 
  group_by(RELACIONS_CAT_ESP_1_5) |> 
  summarize(n = length(RELACIONS_CAT_ESP_1_5)) |>  
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion),
         RELACIONS_CAT_ESP_1_5 = factor(RELACIONS_CAT_ESP_1_5,
                                    levels = RELACIONS_CAT_ESP_1_5)) |> 
   ggplot() +
  geom_col(aes(proportion,
               RELACIONS_CAT_ESP_1_5,
               fill = RELACIONS_CAT_ESP_1_5), 
           width = 0.5) +
  geom_text(aes(proportion,
               RELACIONS_CAT_ESP_1_5,
                label = proportion,
                color = RELACIONS_CAT_ESP_1_5), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  geom_text(aes(x = 0, 
                label = RELACIONS_CAT_ESP_1_5, 
                y = RELACIONS_CAT_ESP_1_5), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = c("#264653", 
                               "#2a9d8f",
                               "#e9c46a",
                               "#f4a261", 
                               "#e76f51",
                               "#C6C6C6",
                               "#9E9B9B")) +
  scale_color_manual(values = c("#FFFFFF",
                                "#FFFFFF",
                                "#585858",
                                "#585858",
                                "#FFFFFF",
                                "#585858",
                                "#FFFFFF"),
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,-1,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
act_indep

ggsave(file.path(RELS_IMG_FOLDER, "act_indep.png"),
       plot = act_indep,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Actituds davant la independència, segons simpatia de partit

```{r}
act_indep_partit <- data |>
  select(PONDERA,
         SIMPATIA_PARTIT_R,
         resposta = RELACIONS_CAT_ESP_1_5) |>
  filter(!SIMPATIA_PARTIT_R %in% c(80, 98,99)) |>
    mutate(resposta = case_when(
    resposta == 1 ~ "Independència unilateral",
    resposta == 2 ~ "Independència pactada",
    resposta == 3 ~ "Sense posició definida",
    resposta == 4 ~ "Unitat d'Espanya pactada",
    resposta == 5 ~ "Unitat d'Espanya sense negociació",
    resposta > 5 ~ "NS/NC"), 
    resposta = factor(resposta,
                                   levels = c("Independència unilateral",
                                              "Independència pactada",
                                              "Sense posició definida",
                                              "Unitat d'Espanya pactada",
                                              "Unitat d'Espanya sense negociació",
                                              "NS/NC"))) |>
  mutate(SIMPATIA_PARTIT_R = as_label(SIMPATIA_PARTIT_R), 
         SIMPATIA_PARTIT_R = clean_party_name(SIMPATIA_PARTIT_R),
         SIMPATIA_PARTIT_R = prettify_party_names(SIMPATIA_PARTIT_R)) |> 
  group_by(SIMPATIA_PARTIT_R, resposta) |>
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  group_by(SIMPATIA_PARTIT_R) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |>
  complete(resposta, 
           fill = list(proportion = 0)) |> 
  ggplot() +
  geom_col(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("Junts per Catalunya",
                             "CUP",
                             "ERC",
                             "En Comú Podem",
                             "PSC",
                             "PP",
                             "Ciudadanos*",
                             "Vox",
                             "Cap")),
               group = rev(resposta),
               fill = resposta), 
           width = 0.8) +
  geom_text(aes(proportion,
                fct_relevel(SIMPATIA_PARTIT_R,
                           c("Junts per Catalunya",
                             "CUP",
                             "ERC",
                             "En Comú Podem",
                             "PSC",
                             "PP",
                             "Ciudadanos*",
                             "Vox",
                             "Cap")),
                group = rev(resposta),
                label =  ifelse(proportion > 2, proportion, ""),
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  scale_fill_manual(values = c("#264653", 
                               "#2a9d8f",
                               "#e9c46a",
                               "#f4a261", 
                               "#e76f51",
                               "#C6C6C6",
                               "#9E9B9B")) +
  scale_color_manual(values = c("#FFFFFF",
                                "#FFFFFF",
                                "#585858",
                                "#585858",
                                "#FFFFFF",
                                "#585858",
                                "#FFFFFF"),
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 5)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
act_indep_partit

ggsave(file.path(RELS_IMG_FOLDER, "act_indep_partit.png"),
       plot = act_indep_partit,
       width = 17,
       height = 15,
       dpi = 300,
       units = "cm")
```

## Probabilitat d’escenaris relació Catalunya-Espanya en els propers 5 anys

```{r}
PROB_5A <- data |> 
  select(starts_with("PROB_5A_"),
         PONDERA) |>
  pivot_longer(starts_with("PROB_5A_"), 
               names_to = "categoria", 
               values_to = "resposta") |>
  mutate(categoria = case_when(
  categoria == "PROB_5A_INDEPENDENCIA" ~ "La independència de Catalunya",
  categoria == "PROB_5A_AUTOGOVERN_MES" ~ "Un acord amb Espanya per dotar a Catalunya de més autogovern",
  categoria == "PROB_5A_AUTOGOVERN_IGUAL" ~ "Que Catalunya es quedi amb el mateix autogovern que té",
  categoria == "PROB_5A_AUTOGOVERN_MENYS" ~ "Que Catalunya tingui menys autogovern",
  categoria == "PROB_5A_AUTOGOVERN_GENS" ~ "Que Catalunya perdi l’autonomia durant un període de temps"),
  resposta = case_when(
    resposta == 1 ~ "Segur",
    resposta == 2 ~ "Molt probable",
    resposta == 3 ~ "Bastant probable",
    resposta == 4 ~ "Poc probable",
    resposta == 5 ~ "Molt poc probable",
    resposta == 6 ~ "Gens probable",
    resposta > 6 & resposta < 100 ~ "NS/NC"),
    resposta = factor(resposta, levels = c("Segur",
                                           "Molt probable",
                                           "Bastant probable",
                                           "Poc probable",
                                           "Molt poc probable",
                                           "Gens probable",
                                           "NS/NC"))) |>
  filter(!is.na(resposta)) |> 
  group_by(categoria, resposta) |>
  count(categoria, wt = PONDERA) |> 
  ungroup() |>
  group_by(categoria) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |>
  ggplot() +
  geom_col(aes(proportion,
               fct_relevel(categoria,
                           c("Que Catalunya es quedi amb el mateix autogovern que té",
                             "Un acord amb Espanya per dotar a Catalunya de més autogovern",
                             "Que Catalunya tingui menys autogovern",
                             "Que Catalunya perdi l’autonomia durant un període de temps",
                             "La independència de Catalunya")),
               group = rev(resposta),
               fill = resposta),
           width = 0.5) +
  geom_text(aes(proportion,
               fct_relevel(categoria,
                           c("Que Catalunya es quedi amb el mateix autogovern que té",
                             "Un acord amb Espanya per dotar a Catalunya de més autogovern",
                             "Que Catalunya tingui menys autogovern",
                             "Que Catalunya perdi l’autonomia durant un període de temps",
                             "La independència de Catalunya")),
                group = rev(resposta),
                label = ifelse(proportion > 2, proportion, ""),
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  geom_text(aes(x = 0, 
                label = categoria, 
                y = categoria), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = c("#529A0F",
                               "#7EC23E", 
                               "#BAE390",
                               "#EE9595", 
                               "#E66060",
                               "#C12828",
                               "#C6C6C6")) +
  scale_color_manual(values = c("#FFFFFF",
                                "#FFFFFF",
                                "#585858",
                                "#585858",
                                "#FFFFFF",
                                "#FFFFFF",
                                "#585858"),
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
PROB_5A

ggsave(file.path(RELS_IMG_FOLDER, "PROB_5A.png"),
       plot = PROB_5A,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Probabilitat d’escenaris relació Catalunya-Espanya en els propers 10 anys

```{r}
PROB_10A <- data |> 
  select(starts_with("PROB_10A_"),
         PONDERA) |>
  pivot_longer(starts_with("PROB_10A_"), 
               names_to = "categoria", 
               values_to = "resposta") |>
  mutate(categoria = case_when(
  categoria == "PROB_10A_INDEPENDENCIA" ~ "La independència de Catalunya",
  categoria == "PROB_10A_AUTOGOVERN_MES" ~ "Un acord amb Espanya per dotar a Catalunya de més autogovern",
  categoria == "PROB_10A_AUTOGOVERN_IGUAL" ~ "Que Catalunya es quedi amb el mateix autogovern que té",
  categoria == "PROB_10A_AUTOGOVERN_MENYS" ~ "Que Catalunya tingui menys autogovern",
  categoria == "PROB_10A_AUTOGOVERN_GENS" ~ "Que Catalunya perdi l’autonomia durant un període de temps"),
  resposta = case_when(
    resposta == 1 ~ "Segur",
    resposta == 2 ~ "Molt probable",
    resposta == 3 ~ "Bastant probable",
    resposta == 4 ~ "Poc probable",
    resposta == 5 ~ "Molt poc probable",
    resposta == 6 ~ "Gens probable",
    resposta > 6 & resposta < 100 ~ "NS/NC"),
    resposta = factor(resposta, levels = c("Segur",
                                           "Molt probable",
                                           "Bastant probable",
                                           "Poc probable",
                                           "Molt poc probable",
                                           "Gens probable",
                                           "NS/NC"))) |>
  filter(!is.na(resposta)) |> 
  group_by(categoria, resposta) |>
  count(categoria, wt = PONDERA) |> 
  ungroup() |>
  group_by(categoria) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |>
  ggplot() +
  geom_col(aes(proportion,
               fct_relevel(categoria,
                           c("Que Catalunya es quedi amb el mateix autogovern que té",
                             "Un acord amb Espanya per dotar a Catalunya de més autogovern",
                             "Que Catalunya tingui menys autogovern",
                             "Que Catalunya perdi l’autonomia durant un període de temps",
                             "La independència de Catalunya")),
               group = rev(resposta),
               fill = resposta),
           width = 0.5) +
  geom_text(aes(proportion,
               fct_relevel(categoria,
                           c("Que Catalunya es quedi amb el mateix autogovern que té",
                             "Un acord amb Espanya per dotar a Catalunya de més autogovern",
                             "Que Catalunya tingui menys autogovern",
                             "Que Catalunya perdi l’autonomia durant un període de temps",
                             "La independència de Catalunya")),
                group = rev(resposta),
                label = ifelse(proportion > 1, proportion, ""),
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  geom_text(aes(x = 0, 
                label = categoria, 
                y = categoria), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = c("#529A0F",
                               "#7EC23E", 
                               "#BAE390",
                               "#EE9595", 
                               "#E66060",
                               "#C12828",
                               "#C6C6C6")) +
  scale_color_manual(values = c("#FFFFFF",
                                "#FFFFFF",
                                "#585858",
                                "#585858",
                                "#FFFFFF",
                                "#FFFFFF",
                                "#585858"),
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
PROB_10A

ggsave(file.path(RELS_IMG_FOLDER, "PROB_10A.png"),
       plot = PROB_10A,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

# ------------------------------------------------------------------------------

# Govern i institucions

## Valoració de la gestió de Govern català (Mitjana)

```{r}
mitjana <- data |> 
  select(variable = VAL_GOV_CAT,
         PONDERA) |>
  mutate(grup = 1,
         grup = factor(grup, labels = "Població general")) |> 
  group_by(grup) |>
  replace_with_na(list(variable = c(98,99))) |> 
  summarise(mitjana = round(weighted.mean(variable, w = PONDERA, na.rm = T), digits = 1))

VAL_GOV_CAT <- data |>
  select(variable = VAL_GOV_CAT,
         PONDERA) |> 
  filter(!variable %in% c(98, 99)) |> 
  count(variable, wt = PONDERA) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ggplot(aes(variable,
             proportion,
             group = 1)) +
  geom_smooth(span = 0.4,
              method = "loess",
              size = 1.5,
              color = "#C00000") +
  stat_smooth(se = FALSE, 
              geom ="area",
              method = 'loess', 
              alpha = 0.5,
              span = 0.4,
              fill = "#C00000") + 
  geom_vline(aes(xintercept = mitjana), 
             linetype = "dashed",
             data = mitjana) +
  annotate("label", 
           x = 3, 
           y = 28,
           size = 5,
           label = paste("Mitjana: 4,2"), 
           family= "open_sans") +
  scale_x_continuous(expand = c(0,0),
                     breaks = c(0,1,2,3,4,5,6,7,8,9,10)) +
  scale_y_continuous(expand = c(0,0),
                     limits = c(0,32),
                     breaks = c(5,10,15,20,25,30)) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.margin = margin(0.5,0.5,0,0, "cm"),
        text = element_text(size = 16, 
                            family = "open_sans",
                            color  = "black")) +
  labs(x = "",
       y = "")
VAL_GOV_CAT

ggsave(file.path(INST_IMG_FOLDER, "VAL_GOV_CAT.png"),
       plot = VAL_GOV_CAT,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm") 
```

## Aprovació de la gestió de Govern català

```{r}
VAL_GOV_CAT_PROP <- data |> 
  select(variable = VAL_GOV_CAT,
         PONDERA) |>
  mutate(variable = case_when(
    variable < 5 ~ "Desaprova (0-4)",
    variable >= 5 & variable < 11 ~ "Aprova (5-10)",
    TRUE ~ "NS/NC"),
    variable = factor(variable,
                      levels = c("Aprova (5-10)",
                                 "Desaprova (0-4)",
                                 "NS/NC"))) |>
  count(variable, wt = PONDERA) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |>
  ggplot() +
  geom_col(aes(proportion,
               variable,
               fill = variable),
           width = 0.5) +
 geom_text(aes(x = proportion,
                y = variable,
                label = proportion), 
            hjust = -0.3,
            family = "open_sans", 
            color = "#646464",
            fontface = "bold",
            size = 6) +
geom_text(aes(x = 0, 
                label = variable, 
                y = variable), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,57)) +
  scale_y_discrete(limits = rev) +
  scale_fill_manual(values = pos_neg_2_colors) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,-1,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
VAL_GOV_CAT_PROP

ggsave(file.path(INST_IMG_FOLDER, "VAL_GOV_CAT_PROP.png"),
       plot = VAL_GOV_CAT_PROP,
       width = 17,
       height = 10,
       dpi = 300,
       units = "cm") 
```


## Valoració de la gestió de Govern català, segons simpatia de partit

```{r}
val_gene_partit <- data |> 
  select(variable = VAL_GOV_CAT, 
         grup = SIMPATIA_PARTIT_R,
         PONDERA) |>
  filter(!grup %in% c(80, 98,99)) |>
  mutate(grup = as_label(grup), 
         grup = clean_party_name(grup),
         grup = prettify_party_names(grup)) |> 
  group_by(grup)  |>
  replace_with_na(list(variable = c(98,99))) |> 
  summarise(mitjana = round(weighted.mean(variable, w = PONDERA, na.rm = T), digits = 1)) |> 
  filter(grup != "Altres")
 
val_gene_simp <- rbind(mitjana, val_gene_partit)
 
VAL_GOV_CAT_SIMP <- val_gene_simp |> 
   ggplot() +
  geom_linerange(aes(xmin = 0,
                     xmax = mitjana,
                     y = fct_reorder(grup, mitjana),
                     group = grup,
                     color = grup),
                 linewidth = 1) + 
  geom_point(aes(mitjana, 
                 fct_reorder(grup, mitjana),
                 color = grup),
             size = 12) + 
 geom_text(aes(mitjana,
                fct_reorder(grup, 
                            mitjana),
                label = point(mitjana)), 
            hjust = 0.5,
            color = "white",
            fontface = "bold",
            family = "open_sans", 
            size = 5) +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,10)) + 
  scale_color_manual(values = party_color) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(face = c('plain', 
                                            'plain', 
                                            'plain', 
                                            'plain', 
                                            'plain',
                                            'bold',
                                            'plain',
                                            'plain',
                                            'plain')),
        plot.margin = margin(0,0,-0.5,0, "cm"),
        text = element_text(size = 15, 
                            family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
VAL_GOV_CAT_SIMP

ggsave(file.path(INST_IMG_FOLDER, "VAL_GOV_CAT_SIMP.png"),
       plot = VAL_GOV_CAT_SIMP,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Aprovació de la gestió de Govern català, segons simpatia de partit

```{r}
prop_general <- data |> 
  select(variable = VAL_GOV_CAT,
         PONDERA) |>
  mutate(variable = case_when(
    variable < 5 ~ "Desaprova (0-4)",
    variable >= 5 & variable < 11 ~ "Aprova (5-10)",
    TRUE ~ "NS/NC"),
    variable = factor(variable,
                      levels = c("Aprova (5-10)",
                                 "Desaprova (0-4)",
                                 "NS/NC")),
    grup = "Població general") |>
  group_by(grup) |> 
  count(variable, wt = PONDERA) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion))

prop_simp <- data |> 
  select(variable = VAL_GOV_CAT, 
         grup = SIMPATIA_PARTIT_R,
         PONDERA) |>
 filter(!grup %in% c(80, 98,99)) |>
 mutate(grup = as_label(grup), 
        grup = clean_party_name(grup),
        grup = prettify_party_names(grup)) |> 
  mutate(variable = case_when(
    variable < 5 ~ "Desaprova (0-4)",
    variable >= 5 & variable < 11 ~ "Aprova (5-10)",
    TRUE ~ "NS/NC"),
    variable = factor(variable,
                      levels = c("Aprova (5-10)",
                                 "Desaprova (0-4)",
                                 "NS/NC"))) |> 
  group_by(grup) |> 
  count(variable, wt = PONDERA) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion))

prop <- rbind(prop_general, prop_simp)

VAL_GOV_CAT_PROP_SIMP <- prop  |> 
  filter(variable == "Aprova (5-10)") |> 
  filter(grup != "Altres") |> 
   ggplot() +
  geom_linerange(aes(xmin = 0,
                     xmax = proportion,
                     y = fct_reorder(grup, proportion),
                     group = grup,
                     color = grup),
                 linewidth = 1) + 
  geom_point(aes(proportion, 
                 fct_reorder(grup, proportion),
                 color = grup),
             size = 12) + 
 geom_text(aes(proportion,
                fct_reorder(grup, 
                            proportion),
                label = proportion), 
            hjust = 0.5,
            color = "white",
           fontface = "bold",
            family = "open_sans", 
            size = 5) +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,77)) + 
  scale_color_manual(values = party_color) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(face = c('plain', 
                                            'plain', 
                                            'plain', 
                                            'plain', 
                                            'plain',
                                            'bold',
                                            'plain',
                                            'plain',
                                            'plain',
                                            'plain')),
        plot.margin = margin(0,0,-0.5,0, "cm"),
        text = element_text(size = 15, 
                            family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
VAL_GOV_CAT_PROP_SIMP

ggsave(file.path(INST_IMG_FOLDER, "VAL_GOV_CAT_PROP_SIMP.png"),
       plot = VAL_GOV_CAT_PROP_SIMP,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```


## Valoració de la gestió de Govern espanyol

```{r}
mitjana <- data |> 
  select(variable = VAL_GOV_ESP,
         PONDERA) |>
  mutate(grup = 1,
         grup = factor(grup, labels = "Població general")) |> 
  group_by(grup) |>
  replace_with_na(list(variable = c(98,99))) |> 
  summarise(mitjana = round(weighted.mean(variable, w = PONDERA, na.rm = T), digits = 1))

VAL_GOV_ESP <- data |> # Abans de la fletxa es posa el nom del gràfic, que ha de canviar-se cada vegada
  select(variable = VAL_GOV_ESP,
         PONDERA) |> # Aquí es canvia la variable
 filter(!variable %in% c(98, 99)) |> 
  count(variable, wt = PONDERA) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ggplot(aes(variable,
             proportion,
             group = 1)) +
  geom_smooth(span = 0.4,
              method = "loess",
              size = 1.5,
              color = "#C00000") + # Aquí es canvia el color
  stat_smooth(se = FALSE, 
              geom ="area",
              method = 'loess', 
              alpha = 0.5,
              span = 0.4,
              fill = "#C00000") + # Aquí es canvia el color
  geom_vline(aes(xintercept = mitjana), # Aquí es canvia la línia mitjana 
             linetype = "dashed",
             data = mitjana) +
  annotate("label", 
           x = 2.9, 
           y = 22.5,
           size = 5,
           label = paste("Mitjana: 4,1"),
           family= "open_sans") +
  scale_x_continuous(expand = c(0,0),
                     breaks = c(0,1,2,3,4,5,6,7,8,9,10)) +
  scale_y_continuous(expand = c(0,0),
                     limits = c(0,26),
                     breaks = c(5,10,15,20, 25)) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.margin = margin(0.5,0.5,0,0, "cm"),
        text = element_text(size = 16, # Aquí es canvia la grandària del text
                            family = "open_sans",
                            color  = "black")) +
  labs(x = "",
       y = "")
VAL_GOV_ESP

ggsave(file.path(INST_IMG_FOLDER, "VAL_GOV_ESP.png"),
       plot = VAL_GOV_ESP,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm") 
```

## Aprovació de la gestió de Govern espanyol

```{r}
VAL_GOV_ESP_PROP <- data |> 
  select(variable = VAL_GOV_ESP,
         PONDERA) |>
  mutate(variable = case_when(
    variable < 5 ~ "Desaprova (0-4)",
    variable >= 5 & variable < 11 ~ "Aprova (5-10)",
    TRUE ~ "NS/NC"),
    variable = factor(variable,
                      levels = c("Aprova (5-10)",
                                 "Desaprova (0-4)",
                                 "NS/NC"))) |>
  count(variable, wt = PONDERA) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |>
  ggplot() +
  geom_col(aes(proportion,
               variable,
               fill = variable),
           width = 0.5) +
 geom_text(aes(x = proportion,
                y = variable,
                label = proportion), 
            hjust = -0.3,
            family = "open_sans", 
            color = "#646464",
            fontface = "bold",
            size = 6) +
geom_text(aes(x = 0, 
                label = variable, 
                y = variable), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,53)) +
  scale_y_discrete(limits = rev) +
  scale_fill_manual(values = pos_neg_2_colors) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,-1,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
VAL_GOV_ESP_PROP

ggsave(file.path(INST_IMG_FOLDER, "VAL_GOV_ESP_PROP.png"),
       plot = VAL_GOV_ESP_PROP,
       width = 17,
       height = 10,
       dpi = 300,
       units = "cm") 
```

## Valoració de la gestió de Govern espanyol (Simpatia)

```{r}
val_esp_partit <- data |> 
  select(variable = VAL_GOV_ESP, 
         grup = SIMPATIA_PARTIT_R,
         PONDERA) |>
  filter(!grup %in% c(80, 98,99)) |>
  mutate(grup = as_label(grup), 
         grup = clean_party_name(grup),
         grup = prettify_party_names(grup)) |> 
  group_by(grup) |>
  replace_with_na(list(variable = c(98,99))) |> 
  summarise(mitjana = round(weighted.mean(variable, w = PONDERA, na.rm = T), digits = 1)) |> 
  filter(grup != "Altres")
 
val_esp_simp <- rbind(mitjana, val_esp_partit)
 
VAL_GOV_ESP_SIMP <- val_esp_simp |> 
   ggplot() +
  geom_linerange(aes(xmin = 0,
                     xmax = mitjana,
                     y = fct_reorder(grup, mitjana),
                     group = grup,
                     color = grup),
                 linewidth = 1) + 
  geom_point(aes(mitjana, 
                 fct_reorder(grup, mitjana),
                 color = grup),
             size = 12) + 
 geom_text(aes(mitjana,
                fct_reorder(grup, 
                            mitjana),
                label = point(mitjana)), 
            hjust = 0.5,
           fontface = "bold",
            color = "white",
            family = "open_sans", 
            size = 5) +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,10)) + 
  scale_color_manual(values = party_color) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(face = c('plain', 
                                            'plain', 
                                            'plain', 
                                            'plain', 
                                            'plain',
                                            'plain',
                                            'bold',
                                            'plain',
                                            'plain')),
        plot.margin = margin(0,0,-0.5,0, "cm"),
        text = element_text(size = 15, 
                            family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
VAL_GOV_ESP_SIMP

ggsave(file.path(INST_IMG_FOLDER, "VAL_GOV_ESP_SIMP.png"),
       plot = VAL_GOV_ESP_SIMP,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Aprovació de la gestió de Govern espanyol, segons simpatia de partit

```{r}
prop_general <- data |> 
  select(variable = VAL_GOV_ESP,
         PONDERA) |>
  mutate(variable = case_when(
    variable < 5 ~ "Desaprova (0-4)",
    variable >= 5 & variable < 11 ~ "Aprova (5-10)",
    TRUE ~ "NS/NC"),
    variable = factor(variable,
                      levels = c("Aprova (5-10)",
                                 "Desaprova (0-4)",
                                 "NS/NC")),
    grup = "Població general") |>
  group_by(grup) |> 
  count(variable, wt = PONDERA) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion))

prop_simp <- data |> 
  select(variable = VAL_GOV_ESP, 
         grup = SIMPATIA_PARTIT_R,
         PONDERA) |>
  filter(!grup %in% c(80, 98,99)) |>
  mutate(grup = as_label(grup), 
         grup = clean_party_name(grup),
         grup = prettify_party_names(grup)) |> 
  mutate(variable = case_when(
    variable < 5 ~ "Desaprova (0-4)",
    variable >= 5 & variable < 11 ~ "Aprova (5-10)",
    TRUE ~ "NS/NC"),
    variable = factor(variable,
                      levels = c("Aprova (5-10)",
                                 "Desaprova (0-4)",
                                 "NS/NC"))) |> 
  group_by(grup) |> 
  count(variable, wt = PONDERA) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion))

prop <- rbind(prop_general, prop_simp)

VAL_GOV_ESP_PROP_SIMP <- prop |> 
   filter(variable == "Aprova (5-10)") |> 
  filter(grup != "Altres") |> 
   ggplot() +
  geom_linerange(aes(xmin = 0,
                     xmax = proportion,
                     y = fct_reorder(grup, proportion),
                     group = grup,
                     color = grup),
                 linewidth = 1) + 
  geom_point(aes(proportion, 
                 fct_reorder(grup, proportion),
                 color = grup),
             size = 12) + 
 geom_text(aes(proportion,
                fct_reorder(grup, 
                            proportion),
                label = proportion), 
            hjust = 0.5,
           fontface = "bold",
            color = "white",
            family = "open_sans", 
            size = 5) +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,90)) + 
  scale_color_manual(values = party_color) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(face = c('plain', 
                                            'plain', 
                                            'plain', 
                                            'plain', 
                                            'plain',
                                            'plain',
                                            'bold',
                                            'plain',
                                            'plain',
                                            'plain')),
        plot.margin = margin(0,0,-0.5,0, "cm"),
        text = element_text(size = 15, 
                            family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
VAL_GOV_ESP_PROP_SIMP

ggsave(file.path(INST_IMG_FOLDER, "VAL_GOV_ESP_PROP_SIMP.png"),
       plot = VAL_GOV_ESP_PROP_SIMP,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Evolució de la valoració de la gestió del Govern de Catalunya i del Govern espanyol

```{r}
val_historic <- bop_historic |> 
  mutate(REO = prettify_bop_names(REO)) |> 
  filter(REO %in% c("Juny 18",
                    "Oct. 18",
                    "Març 19",
                    "Jul. 19",
                    "Nov. 19", 
                    "Feb. 20",
                    "Jul. 20",
                    "Oct. 20",
                    "Març 22",
                    "Juny 22",
                    "Oct. 22")) |> 
  select(REO, PONDERA, VAL_GOV_CAT, VAL_GOV_ESP) %>%
  pivot_longer(c(VAL_GOV_CAT, VAL_GOV_ESP), 
               names_to = "govern", 
               values_to = "valoracio") %>% 
  mutate(govern = case_when(
           govern == "VAL_GOV_CAT" ~ "Govern català",
           govern == "VAL_GOV_ESP" ~ "Govern espanyol")) %>% 
  replace_with_na(replace = list(valoracio = c(99, 98))) %>% 
  group_by(REO, govern) %>% 
  summarise(mean = weighted.mean(valoracio, w = PONDERA, na.rm = T)) %>% 
  mutate(mean = round(mean, digits = 1))

val_actual <- data |> 
  mutate(REO = "Març 23") |> 
 select(REO, PONDERA, VAL_GOV_CAT, VAL_GOV_ESP) %>%
  pivot_longer(c(VAL_GOV_CAT, VAL_GOV_ESP), 
               names_to = "govern", 
               values_to = "valoracio") %>% 
  mutate(govern = case_when(
           govern == "VAL_GOV_CAT" ~ "Govern català",
           govern == "VAL_GOV_ESP" ~ "Govern espanyol")) %>% 
  replace_with_na(replace = list(valoracio = c(99, 98))) %>% 
  group_by(REO, govern) %>% 
  summarise(mean = weighted.mean(valoracio, w = PONDERA, na.rm = T)) %>% 
  mutate(mean = round(mean, digits = 1))

evolucio_val <- rbind(val_historic, val_actual)
evolucio_val <- evolucio_val |> 
  mutate(REO = factor(REO, levels = 
                            c("Juny 18",
                              "Oct. 18",
                              "Març 19",
                              "Jul. 19",
                              "Nov. 19", 
                              "Feb. 20",
                              "Jul. 20",
                              "Oct. 20",
                              "Març 22",
                              "Juny 22",
                              "Oct. 22",
                              "Març 23")))

EVOL_VAL_GOV <- evolucio_val |> 
  ggplot() +
  geom_line(aes(REO,
                mean,
                group = govern,
                color = govern),
            size = 1) +
  geom_point(aes(REO,
                 mean,
                 group = govern,
                 color = govern),
             size = 3, 
             show.legend = F) +
  geom_text(aes(REO,
                 mean,
                 group = govern,
                 label = mean,
                color = govern),
             size = 5,
             family = "sans",
             vjust=-0.7,
             show.legend  = FALSE,
             data = . %>% filter(govern == "Govern català")) +
  geom_text(aes(REO,
                 mean,
                 group = govern,
                 label = mean,
                color = govern),
             size = 5,
             family = "sans",
             vjust=1.6,
             show.legend  = FALSE,
             data = . %>% filter(govern == "Govern espanyol")) +
  scale_y_continuous(limits = c(0,10)) +
  scale_color_manual(values = c("#C00000",
                                "#0E2F59")) +
  scale_fill_manual(values = c("#C00000",
                               "#0E2F59")) +
  guides(color = guide_legend(override.aes = list(size = 6))) +
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.margin = margin(0,0,0.5,0, "cm"),
        legend.margin = margin(-0.5,0,0,0, "cm"),
        axis.text.x = element_text(angle = 45, hjust=1),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        text = element_text(family = "sans", 
                            color  = "black",
                            size = 16)) +
  labs(x = "",
       y = "",
       color = "")
EVOL_VAL_GOV

ggsave(file.path(INST_IMG_FOLDER, "EVOL_VAL_GOV.png"),
       plot = EVOL_VAL_GOV,
       width = 20,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Grau de confiança en les institucions

```{r}
CONFI_INST <- data |> 
  select(starts_with("CONFI"),
         PONDERA) |>
  pivot_longer(starts_with("CONFI"), 
               names_to = "categoria", 
               values_to = "resposta") |>
  mutate(categoria = case_when(
  categoria == "CONFI_TRIBUNALS" ~ "Els tribunals de justícia",
  categoria == "CONFI_PARTITS" ~ "Els partits polítics",
  categoria == "CONFI_AJUNTAMENT" ~ "El seu ajuntament",
  categoria == "CONFI_GOV_ESP" ~ "El Govern espanyol/central",
  categoria == "CONFI_GOV_CAT" ~ "El Govern de la Generalitat",
  categoria == "CONFI_CONGRES" ~ "El Congrés dels Diputats",
  categoria == "CONFI_PARLAMENT" ~ "El Parlament de Catalunya",
  categoria == "CONFI_UE" ~ "La Unió Europea",
  categoria == "CONFI_MONARQUIA" ~ "La monarquia espanyola")) |> 
  group_by(categoria) |>
  replace_with_na(list(resposta = c(98,99))) |> 
  summarise(mitjana = round(weighted.mean(resposta, w = PONDERA, na.rm = T), digits = 1)) |> 
  ggplot() +
  geom_linerange(aes(xmin = 0,
                     xmax = mitjana,
                     y = fct_reorder(categoria, mitjana),
                     group = categoria),
                 color = "#C00000",
                 linewidth = 1) + 
  geom_point(aes(mitjana, 
                 fct_reorder(categoria, mitjana)),
                 color = "#C00000",
             size = 12) + 
 geom_text(aes(mitjana,
                fct_reorder(categoria, 
                            mitjana),
                label = point(mitjana)), 
            hjust = 0.5,
            fontface = "bold",
            color = "white",
            family = "open_sans", 
            size = 5) +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,10)) + 
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0,0,-0.5,0, "cm"),
        text = element_text(size = 15, 
                            family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
CONFI_INST

ggsave(file.path(INST_IMG_FOLDER, "CONFI_INST.png"),
       plot = CONFI_INST,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Grau de confiança en les institucions (%)

```{r}
CONFI_INST_PROP <- data |> 
  select(starts_with("CONFI"),
         PONDERA) |>
  pivot_longer(starts_with("CONFI"), 
               names_to = "categoria", 
               values_to = "resposta") |>
  mutate(categoria = case_when(
  categoria == "CONFI_TRIBUNALS" ~ "Els tribunals de justícia",
  categoria == "CONFI_PARTITS" ~ "Els partits polítics",
  categoria == "CONFI_AJUNTAMENT" ~ "El seu ajuntament",
  categoria == "CONFI_GOV_ESP" ~ "El Govern espanyol/central",
  categoria == "CONFI_GOV_CAT" ~ "El Govern de la Generalitat",
  categoria == "CONFI_CONGRES" ~ "El Congrés dels Diputats",
  categoria == "CONFI_PARLAMENT" ~ "El Parlament de Catalunya",
  categoria == "CONFI_UE" ~ "La Unió Europea",
  categoria == "CONFI_MONARQUIA" ~ "La monarquia espanyola"),
  resposta = case_when(
    resposta < 3 ~ "0-2",
    resposta > 2 & resposta < 5 ~ "3-4",
    resposta > 4 & resposta < 6 ~ "5",
    resposta > 5 & resposta < 8 ~ "6-7",
    resposta > 7 & resposta < 98 ~ "8-10",
    resposta > 10 & resposta < 100 ~ "NS/NC")) |> 
  group_by(categoria, resposta) |> 
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  group_by(categoria) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(proportion,
               fct_relevel(categoria,
                           c("La monarquia espanyola",
                             "Els partits polítics",
                             "El Congrés dels Diputats",
                             "El Govern espanyol/central",
                             "Els tribunals de justícia",
                             "El Parlament de Catalunya",
                             "El Govern de la Generalitat",
                             "La Unió Europea",
                             "El seu ajuntament")),
               group = rev(resposta),
               fill = resposta), 
           width = 0.5) +
  geom_text(aes(proportion,
               fct_relevel(categoria,
                           c("La monarquia espanyola",
                             "Els partits polítics",
                             "El Congrés dels Diputats",
                             "El Govern espanyol/central",
                             "Els tribunals de justícia",
                             "El Parlament de Catalunya",
                             "El Govern de la Generalitat",
                             "La Unió Europea",
                             "El seu ajuntament")),
                group = rev(resposta),
                label = ifelse(proportion > 1, proportion, ""),
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  geom_text(aes(x = 0, 
                label = categoria, 
                y = categoria), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = c("#E66060", 
                               "#EE9595",
                               "#F9DA72",
                               "#BAE390", 
                               "#7EC23E",
                               "#C6C6C6")) +
  scale_color_manual(values = pos_neg_5_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
CONFI_INST_PROP

ggsave(file.path(INST_IMG_FOLDER, "CONFI_INST_PROP.png"),
       plot = CONFI_INST_PROP,
       width = 18,
       height = 16,
       dpi = 300,
       units = "cm")
```

## Grau de confiança en les institucions, segons simpatia de partit

```{r}
mitjana <- data |> 
  select(starts_with("CONFI"),
         PONDERA) |>
  pivot_longer(starts_with("CONFI"), 
               names_to = "categoria", 
               values_to = "resposta") |>
  mutate(categoria = case_when(
  categoria == "CONFI_TRIBUNALS" ~ "Els tribunals de justícia",
  categoria == "CONFI_PARTITS" ~ "Els partits polítics",
  categoria == "CONFI_AJUNTAMENT" ~ "El seu ajuntament",
  categoria == "CONFI_GOV_ESP" ~ "El Govern espanyol/central",
  categoria == "CONFI_GOV_CAT" ~ "El Govern de la Generalitat",
  categoria == "CONFI_CONGRES" ~ "El Congrés dels Diputats",
  categoria == "CONFI_PARLAMENT" ~ "El Parlament de Catalunya",
  categoria == "CONFI_UE" ~ "La Unió Europea",
  categoria == "CONFI_MONARQUIA" ~ "La monarquia espanyola"),
  grup = "Població general") |> 
  group_by(grup, categoria) |>
  replace_with_na(list(resposta = c(98,99))) |> 
  summarise(mitjana = round(weighted.mean(resposta, w = PONDERA, na.rm = T), digits = 1)) |> 
  mutate(color = case_when(
    mitjana < 3 ~ "0-2",
    mitjana >= 3 & mitjana < 4 ~ "3-4",
    mitjana >= 4  & mitjana < 5 ~ "4-5",
    mitjana >= 5 & mitjana < 7 ~ "5-7",
    mitjana >= 7 & mitjana < 98 ~ "7-10")) 

confi_partit <- data |> 
  select(starts_with("CONFI"),
         PONDERA,
         grup = SIMPATIA_PARTIT_R) |>
  filter(!grup %in% c(80, 98,99)) |>
  pivot_longer(cols = starts_with("CONFI"), 
               names_to = "categoria", 
               values_to = "resposta") |>
  mutate(categoria = case_when(
  categoria == "CONFI_TRIBUNALS" ~ "Els tribunals de justícia",
  categoria == "CONFI_PARTITS" ~ "Els partits polítics",
  categoria == "CONFI_AJUNTAMENT" ~ "El seu ajuntament",
  categoria == "CONFI_GOV_ESP" ~ "El Govern espanyol/central",
  categoria == "CONFI_GOV_CAT" ~ "El Govern de la Generalitat",
  categoria == "CONFI_CONGRES" ~ "El Congrés dels Diputats",
  categoria == "CONFI_PARLAMENT" ~ "El Parlament de Catalunya",
  categoria == "CONFI_UE" ~ "La Unió Europea",
  categoria == "CONFI_MONARQUIA" ~ "La monarquia espanyola")) |> 
  mutate(grup = as_label(grup), 
         grup = clean_party_name(grup),
         grup = prettify_party_names(grup)) |> 
  group_by(categoria, grup) |>
  replace_with_na(list(resposta = c(98,99))) |> 
  as_label(grup) |> 
  summarise(mitjana = round(weighted.mean(resposta, w = PONDERA, na.rm = T), digits = 1)) |> 
  filter(grup != "Altres") |> 
  mutate(color = case_when(
    mitjana < 3 ~ "0-2",
    mitjana >= 3 & mitjana < 4 ~ "3-4",
    mitjana >= 4  & mitjana < 5 ~ "4-5",
    mitjana >= 5 & mitjana < 7 ~ "5-7",
    mitjana >= 7 & mitjana < 98 ~ "7-10")) 

confi_simp <- rbind(mitjana, confi_partit)

CONFI_SIMP <- confi_simp |> 
  ggplot() +
geom_tile(aes(fct_relevel(grup,
                  c("PSC",
                    "ERC",
                    "Junts per Catalunya",
                    "Vox",
                    "En Comú Podem",
                    "CUP",
                    "Ciudadanos*",
                    "PP",
                    "Cap",
                    "Població general")),
                fct_relevel(categoria,
                            c("El seu ajuntament",
                              "La Unió Europea",
                              "El Parlament de Catalunya",
                              "El Govern de la Generalitat",
                              "Els tribunals de justícia",
                              "El Govern espanyol/central",
                              "El Congrés dels Diputats",
                              "Els partits polítics",
                               "La monarquia espanyola")),
                fill=color),
            color="white",
            size=1) +
  geom_text(aes(fct_relevel(grup,
                  c("PSC",
                    "ERC",
                    "Junts per Catalunya",
                    "Vox",
                    "En Comú Podem",
                    "CUP",
                    "Ciudadanos*",
                    "PP",
                    "Cap",
                    "Població general")),
                fct_relevel(categoria,
                            c("El seu ajuntament",
                              "La Unió Europea",
                              "El Parlament de Catalunya",
                              "El Govern de la Generalitat",
                              "Els tribunals de justícia",
                              "El Govern espanyol/central",
                              "El Congrés dels Diputats",
                              "Els partits polítics",
                               "La monarquia espanyola")),
                label=point(mitjana)),
            color="white",
            size=6,
            fontface="bold") +
  scale_y_discrete(limits=rev) +
  scale_x_discrete(position="top", 
  labels = scales::label_wrap(10)) +
scale_fill_manual(values = c("0-2" = "#E66060", 
                             "3-4" = "#EE9595",
                             "4-5" = "#F8D256",
                             "5-7" = "#BAE390", 
                             "7-10" = "#7EC23E")) +
  theme_minimal() +
  theme(legend.position="none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.margin = margin(0,1,0,0, "cm"),
        text = element_text(size = 15, 
                            family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
CONFI_SIMP

ggsave(file.path(INST_IMG_FOLDER, "CONFI_SIMP.png"),
       plot = CONFI_SIMP,
       width = 30,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Preferència sobre la forma de govern

```{r}
MONARQUIA_REPUBLICA <- data |> 
  mutate(MONARQUIA_REPUBLICA = case_when(
    MONARQUIA_REPUBLICA == 1 ~ "Monarquia",
    MONARQUIA_REPUBLICA == 2 ~ "República",
    MONARQUIA_REPUBLICA == 3 ~ "Una altra",
    TRUE ~ "NS/NC"),
    MONARQUIA_REPUBLICA = factor(MONARQUIA_REPUBLICA,
                                   levels = c("Monarquia", 
                                              "República", 
                                              "Una altra", 
                                              "NS/NC"))) |> 
  group_by(MONARQUIA_REPUBLICA) |> 
  count(MONARQUIA_REPUBLICA, wt = PONDERA) |> 
  ungroup() |>  
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ungroup() |> 
  mutate(ymax = cumsum(proportion),
         ymin = c(0, head(ymax, n=-1)),
         labelPosition = (ymax + ymin) / 2) |> 
  ggplot() +
  geom_rect(aes(ymax = ymax, 
                ymin = ymin, 
                xmax = 4, 
                xmin = 3, 
                fill= MONARQUIA_REPUBLICA)) +
  geom_text(aes(y=labelPosition,
                label=proportion, 
                color = MONARQUIA_REPUBLICA),
            show.legend  = FALSE,
            fontface = "bold",
            family = "open_sans",
            x = 3.5,
            size = 7) +
  scale_fill_manual(values = categ_3_colors) +
  scale_color_manual(values = categ_3_text) + 
  xlim(c(1, 4)) +
  coord_polar(theta="y")  +
  theme_void() +
  theme(legend.position = "bottom",
        plot.margin = margin(0,0,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black",
                            size = 16)) +
  labs(x = "",
       y = "",
       color = "",
       fill = "")
MONARQUIA_REPUBLICA

ggsave(file.path(INST_IMG_FOLDER, "MONARQUIA_REPUBLICA.png"),
       plot = MONARQUIA_REPUBLICA,
       width = 14,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Preferència sobre la forma de govern, segons simpatia de partit

```{r}
MONARQUIA_REPUBLICA_SIMP <- data |> 
  filter(!SIMPATIA_PARTIT_R %in% c(80, 98,99)) |>
  mutate(MONARQUIA_REPUBLICA = case_when(
    MONARQUIA_REPUBLICA == 1 ~ "Monarquia",
    MONARQUIA_REPUBLICA == 2 ~ "República",
    MONARQUIA_REPUBLICA == 3 ~ "Una altra",
    TRUE ~ "NS/NC"),
    MONARQUIA_REPUBLICA = factor(MONARQUIA_REPUBLICA,
                                   levels = c("Monarquia", 
                                              "República", 
                                              "Una altra", 
                                              "NS/NC"))) |> 
  mutate(SIMPATIA_PARTIT_R = as_label(SIMPATIA_PARTIT_R), 
         SIMPATIA_PARTIT_R = clean_party_name(SIMPATIA_PARTIT_R),
         SIMPATIA_PARTIT_R = prettify_party_names(SIMPATIA_PARTIT_R)) |> 
  group_by(SIMPATIA_PARTIT_R, MONARQUIA_REPUBLICA) |> 
  count(MONARQUIA_REPUBLICA, wt = PONDERA) |> 
  ungroup() |>  
  group_by(SIMPATIA_PARTIT_R) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |>
  complete(MONARQUIA_REPUBLICA, 
           fill = list(proportion = 0)) |> 
      ggplot() +
  geom_col(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                  c("CUP",
                    "Junts per Catalunya",
                    "En Comú Podem",
                    "ERC",
                    "PSC",
                    "Vox",
                    "PP",                    
                    "Ciudadanos*",
                    "Cap")),
               group = rev(MONARQUIA_REPUBLICA),
               fill = MONARQUIA_REPUBLICA),
           width = 0.8) +
  geom_text(aes(proportion,
             fct_relevel(SIMPATIA_PARTIT_R,
                  c("CUP",
                    "Junts per Catalunya",
                    "En Comú Podem",
                    "ERC",
                    "PSC",
                    "Vox",
                    "PP",                    
                    "Ciudadanos*",
                    "Cap")),
                group = rev(MONARQUIA_REPUBLICA),
                label =  ifelse(proportion > 1, proportion, ""),
                color = MONARQUIA_REPUBLICA), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = categ_3_colors) +
  scale_color_manual(values = categ_3_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
MONARQUIA_REPUBLICA_SIMP

ggsave(file.path(INST_IMG_FOLDER, "MONARQUIA_REPUBLICA_SIMP.png"),
       plot = MONARQUIA_REPUBLICA_SIMP,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Grau de satisfacció amb el funcionament de la nostra democràcia

```{r}
SATIS_DEMOCRACIA <- data |> 
  select(SATIS_DEMOCRACIA,
         PONDERA) |>
  mutate(SATIS_DEMOCRACIA = case_when(
    SATIS_DEMOCRACIA == 1 ~ "Molt satisfet/a",
    SATIS_DEMOCRACIA == 2 ~ "Bastant satisfet/a",
    SATIS_DEMOCRACIA == 3 ~ "Poc satisfet/a",
    SATIS_DEMOCRACIA == 4 ~ "Gens satisfet/a",
    TRUE ~ "NS/NC"),
    SATIS_DEMOCRACIA = factor(SATIS_DEMOCRACIA, levels = c("Molt satisfet/a",
                                                 "Bastant satisfet/a",
                                                 "Poc satisfet/a",
                                                 "Gens satisfet/a",
                                                 "NS/NC"))) |> 
  count(SATIS_DEMOCRACIA, wt = PONDERA) |> 
  ungroup() |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(proportion,
               SATIS_DEMOCRACIA,
               fill = SATIS_DEMOCRACIA), 
           width = 0.5) +
  geom_text(aes(proportion,
                SATIS_DEMOCRACIA,
                label = proportion,
                color = SATIS_DEMOCRACIA), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  geom_text(aes(x = 0, 
                label = SATIS_DEMOCRACIA, 
                y = SATIS_DEMOCRACIA), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = pos_neg_4_colors) +
  scale_color_manual(values = pos_neg_4_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,-1,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
SATIS_DEMOCRACIA

ggsave(file.path(INST_IMG_FOLDER, "SATIS_DEMOCRACIA.png"),
       plot = SATIS_DEMOCRACIA,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Grau de satisfacció amb el funcionament de la nostra democràcia, segons suport a la independència

```{r}
SATIS_DEMOCRACIA_INDEP <- data |> 
  select(ACTITUD_INDEPENDENCIA,
         SATIS_DEMOCRACIA,
         PONDERA) |>
  mutate(ACTITUD_INDEPENDENCIA = case_when(
    ACTITUD_INDEPENDENCIA == 1 ~ "Partidaris de la independència",
    ACTITUD_INDEPENDENCIA == 2 ~ "Contraris a la independència",
    ACTITUD_INDEPENDENCIA > 2 ~ "NS/NC"),
    ACTITUD_INDEPENDENCIA = factor(ACTITUD_INDEPENDENCIA,
                                   levels = c("Partidaris de la independència", 
                                              "Contraris a la independència", 
                                              "NS/NC")),
    SATIS_DEMOCRACIA = case_when(
    SATIS_DEMOCRACIA == 1 ~ "Molt satisfet/a",
    SATIS_DEMOCRACIA == 2 ~ "Bastant satisfet/a",
    SATIS_DEMOCRACIA == 3 ~ "Poc satisfet/a",
    SATIS_DEMOCRACIA == 4 ~ "Gens satisfet/a",
    TRUE ~ "NS/NC"),
    SATIS_DEMOCRACIA = factor(SATIS_DEMOCRACIA, levels = c("Molt satisfet/a",
                                                 "Bastant satisfet/a",
                                                 "Poc satisfet/a",
                                                 "Gens satisfet/a",
                                                 "NS/NC"))) |> 
  as_label(ACTITUD_INDEPENDENCIA, drop.levels = F) |> 
  group_by(ACTITUD_INDEPENDENCIA, SATIS_DEMOCRACIA) |> 
  count(SATIS_DEMOCRACIA, wt = PONDERA) |> 
  ungroup() |> 
  group_by(ACTITUD_INDEPENDENCIA) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(proportion,
               ACTITUD_INDEPENDENCIA,
               group = rev(SATIS_DEMOCRACIA),
               fill = SATIS_DEMOCRACIA), 
           width = 0.5) +
  geom_text(aes(proportion,
                ACTITUD_INDEPENDENCIA,
                group = rev(SATIS_DEMOCRACIA),
                label = ifelse(proportion > 1, proportion, ""),
                color = SATIS_DEMOCRACIA), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
   geom_text(aes(x = 0, 
                label = ACTITUD_INDEPENDENCIA, 
                y = ACTITUD_INDEPENDENCIA), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = pos_neg_4_colors) +
  scale_color_manual(values = pos_neg_4_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
SATIS_DEMOCRACIA_INDEP

ggsave(file.path(INST_IMG_FOLDER, "SATIS_DEMOCRACIA_INDEP.png"),
       plot = SATIS_DEMOCRACIA_INDEP,
       width = 17,
       height = 12,
       dpi = 300,
       units = "cm")
```

## Grau de satisfacció amb el funcionament de la nostra democràcia, segons simpatia de partit

```{r}
SATIS_DEMOCRACIA_SIMP <- data |> 
  select(SIMPATIA_PARTIT_R,
         SATIS_DEMOCRACIA,
         PONDERA) |>
  filter(!SIMPATIA_PARTIT_R %in% c(80, 98,99)) |>
  mutate(SATIS_DEMOCRACIA = case_when(
    SATIS_DEMOCRACIA == 1 ~ "Molt satisfet/a",
    SATIS_DEMOCRACIA == 2 ~ "Bastant satisfet/a",
    SATIS_DEMOCRACIA == 3 ~ "Poc satisfet/a",
    SATIS_DEMOCRACIA == 4 ~ "Gens satisfet/a",
    TRUE ~ "NS/NC"),
    SATIS_DEMOCRACIA = factor(SATIS_DEMOCRACIA, levels = c("Molt satisfet/a",
                                                 "Bastant satisfet/a",
                                                 "Poc satisfet/a",
                                                 "Gens satisfet/a",
                                                 "NS/NC"))) |> 
  mutate(SIMPATIA_PARTIT_R = as_label(SIMPATIA_PARTIT_R), 
         SIMPATIA_PARTIT_R = clean_party_name(SIMPATIA_PARTIT_R),
         SIMPATIA_PARTIT_R = prettify_party_names(SIMPATIA_PARTIT_R)) |> 
  group_by(SIMPATIA_PARTIT_R, SATIS_DEMOCRACIA) |> 
  count(SATIS_DEMOCRACIA, wt = PONDERA) |> 
  ungroup() |> 
  group_by(SIMPATIA_PARTIT_R) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |>
  complete(SATIS_DEMOCRACIA, 
           fill = list(proportion = 0))  |> 
  ggplot() +
  geom_col(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("Ciudadanos*",
                             "PSC",
                             "PP",  
                             "En Comú Podem",
                             "ERC",
                             "Vox",
                             "Junts per Catalunya",
                             "CUP",
                             "Cap")),
               group = rev(SATIS_DEMOCRACIA),
               fill = SATIS_DEMOCRACIA), 
           width = 0.8) +
  geom_text(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("Ciudadanos*",
                             "PSC",
                             "PP",  
                             "En Comú Podem",
                             "ERC",
                             "Vox",
                             "Junts per Catalunya",
                             "CUP",
                             "Cap")),
                group = rev(SATIS_DEMOCRACIA),
                label = ifelse(proportion > 2, proportion, ""),
                color = SATIS_DEMOCRACIA), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  scale_fill_manual(values = pos_neg_4_colors) +
  scale_color_manual(values = pos_neg_4_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
SATIS_DEMOCRACIA_SIMP

ggsave(file.path(INST_IMG_FOLDER, "SATIS_DEMOCRACIA_SIMP.png"),
       plot = SATIS_DEMOCRACIA_SIMP,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

# ------------------------------------------------------------------------------

# Política municipal

## Què saben de política municipal els catalans i les catalanes

```{r}
INF_POL_OBJ_MUNI <- data |> 
  select(INF_POL_OBJ_COMICIS,
         INF_POL_OBJ_ALCALDE,
         INF_POL_OBJ_PARTIT_ALCALDE,
         PONDERA) |>
  pivot_longer(starts_with("INF_POL_OBJ_"), 
               names_to = "categoria", 
               values_to = "resposta") |>
  mutate(categoria = case_when(
  categoria == "INF_POL_OBJ_COMICIS" ~ "Què s’escollirà el 28 de maig",
  categoria == "INF_POL_OBJ_ALCALDE" ~ "El nom de l’alcalde o alcaldessa",
  categoria == "INF_POL_OBJ_PARTIT_ALCALDE" ~ "El partit polític al qual pertany l’alcalde o alcaldessa del municipi"),
  resposta = case_when(
    resposta == 1 ~ "Correcte",
    resposta == 2 ~ "Aproximat",
    resposta == 3 ~ "Incorrecte",
    resposta > 3 ~ "NS/NC"),
    resposta = factor(resposta,
                                   levels = c("Correcte", "Aproximat", "Incorrecte", "NS/NC"))) |>
  group_by(categoria, resposta) |>
  count(categoria, wt = PONDERA) |> 
  ungroup() |>
  group_by(categoria) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(proportion,
               categoria,
               group = rev(resposta),
               fill = resposta),
           width = 0.5) +
  geom_text(aes(proportion,
                categoria,
                group = rev(resposta),
                label = ifelse(proportion > 1, proportion, ""),
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  geom_text(aes(x = 0, 
                label = categoria, 
                y = categoria), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = pos_neg_3_colors) +
  scale_color_manual(values = pos_neg_3_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
INF_POL_OBJ_MUNI

ggsave(file.path(MUNICIPAL_IMG_FOLDER, "INF_POL_OBJ_MUNI.png"),
       plot = INF_POL_OBJ_MUNI,
       width = 17,
       height = 12,
       dpi = 300,
       units = "cm")
```

## Què saben de política municipal els catalans i les catalanes, segons mida de municipi

```{r}
INF_POL_OBJ_MUNI_HABITAT <- data |> 
  select(INF_POL_OBJ_COMICIS,
         INF_POL_OBJ_ALCALDE,
         INF_POL_OBJ_PARTIT_ALCALDE,
         HABITAT,
         PONDERA) |>
  pivot_longer(starts_with("INF_POL_OBJ_"), 
               names_to = "categoria", 
               values_to = "resposta") |>
  mutate(categoria = case_when(
  categoria == "INF_POL_OBJ_COMICIS" ~ "Què s’escollirà el 28 de maig",
  categoria == "INF_POL_OBJ_ALCALDE" ~ "El nom de l’alcalde o alcaldessa",
  categoria == "INF_POL_OBJ_PARTIT_ALCALDE" ~ "El partit polític al qual pertany l’alcalde o alcaldessa del municipi"),
  resposta = case_when(
    resposta == 1 ~ "Correcte",
    resposta == 2 ~ "Aproximat",
    resposta == 3 ~ "Incorrecte",
    resposta > 3 ~ "NS/NC"),
    resposta = factor(resposta,
                                   levels = c("Correcte", "Aproximat", "Incorrecte", "NS/NC"))) |>
  as_label(HABITAT, drop.levels = F) |> 
  filter(!is.na(resposta)) |> 
  group_by(HABITAT, categoria, resposta) |>
  count(categoria, wt = PONDERA) |> 
  ungroup() |>
  group_by(HABITAT, categoria) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |>
  complete(resposta, 
           fill = list(proportion = 0)) |>
  ggplot() +
  geom_col(aes(proportion,
               HABITAT,
               group = rev(resposta),
               fill = resposta),
           width = 0.8) +
  geom_text(aes(proportion,
                HABITAT,
                group = rev(resposta),
                label = ifelse(proportion > 3, proportion, ""),
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = pos_neg_3_colors) +
  scale_color_manual(values = pos_neg_3_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")+
  facet_wrap(vars(categoria),
             nrow = 1, 
             labeller = label_wrap_gen(width = 25,
                                       multi_line = TRUE))
INF_POL_OBJ_MUNI_HABITAT

ggsave(file.path(MUNICIPAL_IMG_FOLDER, "INF_POL_OBJ_MUNI_HABITAT.png"),
       plot = INF_POL_OBJ_MUNI_HABITAT,
       width = 22,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Vot en les eleccions municipals

```{r}
VOT_ELECCIONS <- data |> 
  mutate(VOT_ELECCIONS = case_when(
    VOT_ELECCIONS == 1 ~ "Vota un partit a les eleccions municipals i un altre a les del \nParlament de Catalunya",
    VOT_ELECCIONS == 2 ~ "Vota sempre el mateix partit al marge del tipus d’eleccions",
    VOT_ELECCIONS > 3 ~ "NS/NC"),
    VOT_ELECCIONS = factor(VOT_ELECCIONS,
                                   levels = c("Vota un partit a les eleccions municipals i un altre a les del \nParlament de Catalunya", "Vota sempre el mateix partit al marge del tipus d’eleccions", "NS/NC"))) |> 
  as_label(drop.levels = FALSE) |> 
  group_by(VOT_ELECCIONS) |> 
  count(VOT_ELECCIONS, wt = PONDERA) |> 
  ungroup() |>  
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ungroup() |> 
  mutate(ymax = cumsum(proportion),
         ymin = c(0, head(ymax, n=-1)),
         labelPosition = (ymax + ymin) / 2) |> 
  ggplot() +
  geom_rect(aes(ymax = ymax, 
                ymin = ymin, 
                xmax = 4, 
                xmin = 3, 
                fill= VOT_ELECCIONS)) +
  geom_text(aes(y=labelPosition,
                label=proportion, 
                color = VOT_ELECCIONS),
            show.legend  = FALSE,
            fontface = "bold",
            family = "open_sans",
            x = 3.5,
            size = 7) +
  scale_fill_manual(values = categ_2_colors) +
  scale_color_manual(values = categ_2_text) + 
  guides(fill = guide_legend(nrow = 3)) +
  xlim(c(1, 4)) +
  coord_polar(theta="y")  +
  theme_void() +
  theme(legend.position = "bottom",
        plot.margin = margin(0,0,0.5,0, "cm"),
        legend.margin = margin(-0.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black",
                            size = 16)) +
  labs(x = "",
       y = "",
       color = "",
       fill = "")
VOT_ELECCIONS

ggsave(file.path(MUNICIPAL_IMG_FOLDER, "VOT_ELECCIONS.png"),
       plot = VOT_ELECCIONS,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Vot en les eleccions municipals, segons franges d’edat

```{r}
VOT_ELECCIONS_EDAT <- data |> 
  mutate(VOT_ELECCIONS = case_when(
    VOT_ELECCIONS == 1 ~ "Vota un partit a les eleccions municipals i un altre a les del \nParlament de Catalunya",
    VOT_ELECCIONS == 2 ~ "Vota sempre el mateix partit al marge del tipus d’eleccions",
    VOT_ELECCIONS > 3 ~ "NS/NC"),
    VOT_ELECCIONS = factor(VOT_ELECCIONS,
                                   levels = c("Vota un partit a les eleccions municipals i un altre a les del \nParlament de Catalunya", "Vota sempre el mateix partit al marge del tipus d’eleccions", "NS/NC"))) |> 
  as_label(drop.levels = FALSE) |> 
  group_by(EDAT_GR, VOT_ELECCIONS) |> 
  count(VOT_ELECCIONS, wt = PONDERA) |> 
  ungroup() |>
  group_by(EDAT_GR) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
   ggplot() +
  geom_col(aes(proportion,
               EDAT_GR,
               group = rev(VOT_ELECCIONS),
               fill = VOT_ELECCIONS),
           width = 0.8) +
  geom_text(aes(proportion,
                EDAT_GR,
                group = rev(VOT_ELECCIONS),
                label =  ifelse(proportion > 4, proportion, ""),
                color = VOT_ELECCIONS), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = categ_2_colors) +
  scale_color_manual(values = categ_2_text,
                     guide = 'none') + 
  guides(fill = guide_legend(nrow = 3)) +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
VOT_ELECCIONS_EDAT

ggsave(file.path(MUNICIPAL_IMG_FOLDER, "VOT_ELECCIONS_EDAT.png"),
       plot = VOT_ELECCIONS_EDAT,
       width = 17,
       height = 12,
       dpi = 300,
       units = "cm")
```

## Vot en les eleccions municipals, segons mida de municipi

```{r}
VOT_ELECCIONS_HABITAT <- data |> 
  mutate(VOT_ELECCIONS = case_when(
    VOT_ELECCIONS == 1 ~ "Vota un partit a les eleccions municipals i un altre \na les del Parlament de Catalunya",
    VOT_ELECCIONS == 2 ~ "Vota sempre el mateix partit al marge del tipus \nd’eleccions",
    VOT_ELECCIONS > 3 ~ "NS/NC"),
    VOT_ELECCIONS = factor(VOT_ELECCIONS,
                                   levels = c("Vota un partit a les eleccions municipals i un altre \na les del Parlament de Catalunya", "Vota sempre el mateix partit al marge del tipus \nd’eleccions", "NS/NC"))) |> 
  as_label(drop.levels = FALSE) |> 
  group_by(HABITAT, VOT_ELECCIONS) |> 
  count(VOT_ELECCIONS, wt = PONDERA) |> 
  ungroup() |>
  group_by(HABITAT) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
   ggplot() +
  geom_col(aes(proportion,
               HABITAT,
               group = rev(VOT_ELECCIONS),
               fill = VOT_ELECCIONS),
           width = 0.8) +
  geom_text(aes(proportion,
                HABITAT,
                group = rev(VOT_ELECCIONS),
                label =  ifelse(proportion > 4, proportion, ""),
                color = VOT_ELECCIONS), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = categ_2_colors) +
  scale_color_manual(values = categ_2_text,
                     guide = 'none') + 
  guides(fill = guide_legend(nrow = 3)) +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
VOT_ELECCIONS_HABITAT

ggsave(file.path(MUNICIPAL_IMG_FOLDER, "VOT_ELECCIONS_HABITAT.png"),
       plot = VOT_ELECCIONS_HABITAT,
       width = 17,
       height = 12,
       dpi = 300,
       units = "cm")
```

## Vot en les eleccions municipals, segons simpatia de partit

```{r}
VOT_ELECCIONS_SIMP <- data |> 
  filter(!SIMPATIA_PARTIT_R %in% c(80, 98,99)) |>
  mutate(VOT_ELECCIONS = case_when(
    VOT_ELECCIONS == 1 ~ "Vota un partit a les eleccions municipals i un altre a \nles del Parlament de Catalunya",
    VOT_ELECCIONS == 2 ~ "Vota sempre el mateix partit al marge del tipus d’eleccions",
    VOT_ELECCIONS > 3 ~ "NS/NC"),
    VOT_ELECCIONS = factor(VOT_ELECCIONS,
                                   levels = c("Vota un partit a les eleccions municipals i un altre a \nles del Parlament de Catalunya", "Vota sempre el mateix partit al marge del tipus d’eleccions", "NS/NC"))) |> 
  mutate(SIMPATIA_PARTIT_R = as_label(SIMPATIA_PARTIT_R), 
         SIMPATIA_PARTIT_R = clean_party_name(SIMPATIA_PARTIT_R),
         SIMPATIA_PARTIT_R = prettify_party_names(SIMPATIA_PARTIT_R)) |> 
  group_by(SIMPATIA_PARTIT_R, VOT_ELECCIONS) |> 
  count(VOT_ELECCIONS, wt = PONDERA) |> 
  ungroup() |>
  group_by(SIMPATIA_PARTIT_R) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
   ggplot() +
  geom_col(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("PSC",
                             "Junts per Catalunya",
                             "PP",
                             "Vox",
                             "En Comú Podem",
                             "ERC",
                             "Ciudadanos*",
                             "CUP", 
                             "Cap")),
               group = rev(VOT_ELECCIONS),
               fill = VOT_ELECCIONS),
           width = 0.8) +
  geom_text(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("PSC",
                             "Junts per Catalunya",
                             "PP",
                             "Vox",
                             "En Comú Podem",
                             "ERC",
                             "Ciudadanos*",
                             "CUP", 
                             "Cap")),
                group = rev(VOT_ELECCIONS),
                label =  ifelse(proportion > 2, proportion, ""),
                color = VOT_ELECCIONS), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = categ_2_colors) +
  scale_color_manual(values = categ_2_text,
                     guide = 'none') + 
  guides(fill = guide_legend(nrow = 3)) +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
VOT_ELECCIONS_SIMP

ggsave(file.path(MUNICIPAL_IMG_FOLDER, "VOT_ELECCIONS_SIMP.png"),
       plot = VOT_ELECCIONS_SIMP,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Decisió de vot en les eleccions municipals

```{r}
VOT_PARTIT_VS_CANDIDAT <- data |> 
  mutate(VOT_PARTIT_VS_CANDIDAT = case_when(
    VOT_PARTIT_VS_CANDIDAT == 1 ~ "Votaria aquell candidat, malgrat pertànyer a un partit que no li agrada",
    VOT_PARTIT_VS_CANDIDAT == 2 ~ "Votaria el partit que més li agrada, encara que presentés com a \ncandidat una persona que no li agrada",
    VOT_PARTIT_VS_CANDIDAT == 3 ~ "No votaria",
    VOT_PARTIT_VS_CANDIDAT > 4 ~ "NS/NC"),
    VOT_PARTIT_VS_CANDIDAT = factor(VOT_PARTIT_VS_CANDIDAT,
                                   levels = c("Votaria aquell candidat, malgrat pertànyer a un partit que no li agrada", 
                                              "Votaria el partit que més li agrada, encara que presentés com a \ncandidat una persona que no li agrada", 
                                              "No votaria",
                                              "NS/NC"))) |> 
  as_label(drop.levels = FALSE) |> 
  group_by(VOT_PARTIT_VS_CANDIDAT) |> 
  count(VOT_PARTIT_VS_CANDIDAT, wt = PONDERA) |> 
  ungroup() |>  
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ungroup() |> 
  mutate(ymax = cumsum(proportion),
         ymin = c(0, head(ymax, n=-1)),
         labelPosition = (ymax + ymin) / 2) |> 
  ggplot() +
  geom_rect(aes(ymax = ymax, 
                ymin = ymin, 
                xmax = 4, 
                xmin = 3, 
                fill= VOT_PARTIT_VS_CANDIDAT)) +
  geom_text(aes(y=labelPosition,
                label=proportion, 
                color = VOT_PARTIT_VS_CANDIDAT),
            show.legend  = FALSE,
            family = "open_sans",
            fontface = "bold",
            x = 3.5,
            size = 7) +
  scale_fill_manual(values = categ_3_colors) +
  scale_color_manual(values = categ_3_text) + 
  guides(fill = guide_legend(nrow = 4)) +
  xlim(c(1, 4)) +
  coord_polar(theta="y")  +
  theme_void() +
  theme(legend.position = "bottom",
        plot.margin = margin(0,0,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black",
                            size = 16)) +
  labs(x = "",
       y = "",
       color = "",
       fill = "")
VOT_PARTIT_VS_CANDIDAT

ggsave(file.path(MUNICIPAL_IMG_FOLDER, "VOT_PARTIT_VS_CANDIDAT.png"),
       plot = VOT_PARTIT_VS_CANDIDAT,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Decisió de vot en les eleccions municipals, segons franges d’edat

```{r}
VOT_PARTIT_VS_CANDIDAT_EDAT <- data |> 
  mutate(VOT_PARTIT_VS_CANDIDAT = case_when(
    VOT_PARTIT_VS_CANDIDAT == 1 ~ "Votaria aquell candidat, malgrat pertànyer a un partit que \nno li agrada",
    VOT_PARTIT_VS_CANDIDAT == 2 ~ "Votaria el partit que més li agrada, encara que presentés com a \ncandidat una persona que no li agrada",
    VOT_PARTIT_VS_CANDIDAT == 3 ~ "No votaria",
    VOT_PARTIT_VS_CANDIDAT > 4 ~ "NS/NC"),
    VOT_PARTIT_VS_CANDIDAT = factor(VOT_PARTIT_VS_CANDIDAT,
                                   levels = c("Votaria aquell candidat, malgrat pertànyer a un partit que \nno li agrada", 
                                              "Votaria el partit que més li agrada, encara que presentés com a \ncandidat una persona que no li agrada", 
                                              "No votaria",
                                              "NS/NC"))) |> 
  as_label(drop.levels = FALSE) |> 
  group_by(EDAT_GR, VOT_PARTIT_VS_CANDIDAT) |> 
  count(VOT_PARTIT_VS_CANDIDAT, wt = PONDERA) |> 
  ungroup() |>
  group_by(EDAT_GR) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
   ggplot() +
  geom_col(aes(proportion,
               EDAT_GR,
               group = rev(VOT_PARTIT_VS_CANDIDAT),
               fill = VOT_PARTIT_VS_CANDIDAT),
           width = 0.8) +
  geom_text(aes(proportion,
                EDAT_GR,
                group = rev(VOT_PARTIT_VS_CANDIDAT),
                label =  ifelse(proportion > 4, proportion, ""),
                color = VOT_PARTIT_VS_CANDIDAT), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = categ_3_colors) +
  scale_color_manual(values = categ_3_text,
                     guide = 'none') + 
  guides(fill = guide_legend(nrow = 4)) +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
VOT_PARTIT_VS_CANDIDAT_EDAT

ggsave(file.path(MUNICIPAL_IMG_FOLDER, "VOT_PARTIT_VS_CANDIDAT_EDAT.png"),
       plot = VOT_PARTIT_VS_CANDIDAT_EDAT,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Decisió de vot en les eleccions municipals, segons mida de municipi

```{r}
VOT_PARTIT_VS_CANDIDAT_HABITAT <- data |> 
  mutate(VOT_PARTIT_VS_CANDIDAT = case_when(
    VOT_PARTIT_VS_CANDIDAT == 1 ~ "Votaria aquell candidat, malgrat pertànyer a un partit que \nno li agrada",
    VOT_PARTIT_VS_CANDIDAT == 2 ~ "Votaria el partit que més li agrada, encara que presentés com a \ncandidat una persona que no li agrada",
    VOT_PARTIT_VS_CANDIDAT == 3 ~ "No votaria",
    VOT_PARTIT_VS_CANDIDAT > 4 ~ "NS/NC"),
    VOT_PARTIT_VS_CANDIDAT = factor(VOT_PARTIT_VS_CANDIDAT,
                                   levels = c("Votaria aquell candidat, malgrat pertànyer a un partit que \nno li agrada", 
                                              "Votaria el partit que més li agrada, encara que presentés com a \ncandidat una persona que no li agrada", 
                                              "No votaria",
                                              "NS/NC"))) |> 
  as_label(drop.levels = FALSE) |> 
  group_by(HABITAT, VOT_PARTIT_VS_CANDIDAT) |> 
  count(VOT_PARTIT_VS_CANDIDAT, wt = PONDERA) |> 
  ungroup() |>
  group_by(HABITAT) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
   ggplot() +
  geom_col(aes(proportion,
               HABITAT,
               group = rev(VOT_PARTIT_VS_CANDIDAT),
               fill = VOT_PARTIT_VS_CANDIDAT),
           width = 0.8) +
  geom_text(aes(proportion,
                HABITAT,
                group = rev(VOT_PARTIT_VS_CANDIDAT),
                label =  ifelse(proportion > 4, proportion, ""),
                color = VOT_PARTIT_VS_CANDIDAT), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = categ_3_colors) +
  scale_color_manual(values = categ_3_text,
                     guide = 'none') + 
  guides(fill = guide_legend(nrow = 3)) +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
VOT_PARTIT_VS_CANDIDAT_HABITAT

ggsave(file.path(MUNICIPAL_IMG_FOLDER, "VOT_PARTIT_VS_CANDIDAT_HABITAT.png"),
       plot = VOT_PARTIT_VS_CANDIDAT_HABITAT,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Decisió de vot en les eleccions municipals, segons simpatia de partit

```{r}
VOT_PARTIT_VS_CANDIDAT_SIMP <- data |>
   filter(!SIMPATIA_PARTIT_R %in% c(80, 98,99)) |>
  mutate(VOT_PARTIT_VS_CANDIDAT = case_when(
    VOT_PARTIT_VS_CANDIDAT == 1 ~ "Votaria aquell candidat, malgrat pertànyer a un partit que \nno li agrada",
    VOT_PARTIT_VS_CANDIDAT == 2 ~ "Votaria el partit que més li agrada, encara que presentés com a \ncandidat una persona que no li agrada",
    VOT_PARTIT_VS_CANDIDAT == 3 ~ "No votaria",
    VOT_PARTIT_VS_CANDIDAT > 4 ~ "NS/NC"),
    VOT_PARTIT_VS_CANDIDAT = factor(VOT_PARTIT_VS_CANDIDAT,
                                   levels = c("Votaria aquell candidat, malgrat pertànyer a un partit que \nno li agrada", 
                                              "Votaria el partit que més li agrada, encara que presentés com a \ncandidat una persona que no li agrada", 
                                              "No votaria",
                                              "NS/NC"))) |> 
  mutate(SIMPATIA_PARTIT_R = as_label(SIMPATIA_PARTIT_R), 
         SIMPATIA_PARTIT_R = clean_party_name(SIMPATIA_PARTIT_R),
         SIMPATIA_PARTIT_R = prettify_party_names(SIMPATIA_PARTIT_R)) |> 
  group_by(SIMPATIA_PARTIT_R, VOT_PARTIT_VS_CANDIDAT) |> 
  count(VOT_PARTIT_VS_CANDIDAT, wt = PONDERA) |> 
  ungroup() |>
  group_by(SIMPATIA_PARTIT_R) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |>
  complete(VOT_PARTIT_VS_CANDIDAT, 
           fill = list(proportion = 0)) |> 
   ggplot() +
  geom_col(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("Ciudadanos*",
                             "Vox",
                             "PP",
                             "PSC",
                             "Junts per Catalunya",
                             "ERC",
                             "CUP",  
                             "En Comú Podem",
                             "Cap")),
               group = rev(VOT_PARTIT_VS_CANDIDAT),
               fill = VOT_PARTIT_VS_CANDIDAT),
           width = 0.8) +
  geom_text(aes(proportion,
                fct_relevel(SIMPATIA_PARTIT_R,
                           c("Ciudadanos*",
                             "Vox",
                             "PP",
                             "PSC",
                             "Junts per Catalunya",
                             "ERC",
                             "CUP",  
                             "En Comú Podem",
                             "Cap")),
                group = rev(VOT_PARTIT_VS_CANDIDAT),
                label =  ifelse(proportion > 2, proportion, ""),
                color = VOT_PARTIT_VS_CANDIDAT), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = categ_3_colors) +
  scale_color_manual(values = categ_3_text,
                     guide = 'none') + 
  guides(fill = guide_legend(nrow = 4)) +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
VOT_PARTIT_VS_CANDIDAT_SIMP

ggsave(file.path(MUNICIPAL_IMG_FOLDER, "VOT_PARTIT_VS_CANDIDAT_SIMP.png"),
       plot = VOT_PARTIT_VS_CANDIDAT_SIMP,
       width = 18,
       height = 14,
       dpi = 300,
       units = "cm")
```

# ------------------------------------------------------------------------------

# Qüestions socials

## Personalitat

```{r}
PERSONALITAT <- data |> 
  select(EXTRAVERSIO,
         AFABILITAT,
         RESPONSABILITAT,
         ESTABILITAT_EMOCIONAL,
         OBERTA,
         PONDERA) |>
  pivot_longer(c(EXTRAVERSIO,
                 AFABILITAT,
                 RESPONSABILITAT,
                 ESTABILITAT_EMOCIONAL,
                 OBERTA), 
               names_to = "categoria", 
               values_to = "resposta") |>
  mutate(categoria = case_when(
  categoria == "EXTRAVERSIO" ~ "Extraversió",
  categoria == "AFABILITAT" ~ "Afabilitat",
  categoria == "RESPONSABILITAT" ~ "Responsabilitat",
  categoria == "ESTABILITAT_EMOCIONAL" ~ "Estabilitat emocional",
  categoria == "OBERTA" ~ "Obertura a l'experiència")) |> 
  group_by(categoria) |>
  replace_with_na(list(resposta = c(98,99))) |> 
  summarise(mitjana = round(weighted.mean(resposta, w = PONDERA, na.rm = T), digits = 1)) |> 
  ggplot() +
  geom_linerange(aes(xmin = 0,
                     xmax = mitjana,
                     y = fct_reorder(categoria, mitjana),
                     group = categoria,
                     color = categoria),
                 linewidth = 1) + 
  geom_point(aes(mitjana, 
                 fct_reorder(categoria, mitjana),
                     color = categoria),
             size = 12) + 
 geom_text(aes(mitjana,
                fct_reorder(categoria, 
                            mitjana),
                label = point(mitjana)), 
            hjust = 0.5,
            fontface = "bold",
            color = "white",
            family = "open_sans", 
            size = 5) +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,10)) + 
  scale_color_manual(values = categ_5_colors) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0,0,-0.5,0, "cm"),
        text = element_text(size = 15, 
                            family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
PERSONALITAT

ggsave(file.path(SOCIALS_IMG_FOLDER, "PERSONALITAT.png"),
       plot = PERSONALITAT,
       width = 17,
       height = 12,
       dpi = 300,
       units = "cm")
```

## Personalitat, per franges d'edat

```{r}
PERSONALITAT_EDAT <- data |> 
  select(EXTRAVERSIO,
         AFABILITAT,
         RESPONSABILITAT,
         ESTABILITAT_EMOCIONAL,
         OBERTA,
         EDAT_GR,
         PONDERA) |>
  pivot_longer(c(EXTRAVERSIO,
                 AFABILITAT,
                 RESPONSABILITAT,
                 ESTABILITAT_EMOCIONAL,
                 OBERTA), 
               names_to = "categoria", 
               values_to = "resposta") |>
  mutate(categoria = case_when(
  categoria == "EXTRAVERSIO" ~ "Extraversió",
  categoria == "AFABILITAT" ~ "Afabilitat",
  categoria == "RESPONSABILITAT" ~ "Responsabilitat",
  categoria == "ESTABILITAT_EMOCIONAL" ~ "Estabilitat emocional",
  categoria == "OBERTA" ~ "Obertura")) |> 
  as_label(EDAT_GR, drop.levels = F) |> 
  group_by(EDAT_GR, categoria) |>
  replace_with_na(list(resposta = c(98,99))) |> 
  summarise(mitjana = round(weighted.mean(resposta, w = PONDERA, na.rm = T), digits = 1)) |> 
  ggplot() +
  geom_linerange(aes(xmin = 0,
                     xmax = mitjana,
                     y = reorder_within(categoria, mitjana, EDAT_GR), 
                     group = categoria,
                     color = categoria),
                 linewidth = 1) + 
  geom_point(aes(mitjana, 
                 reorder_within(categoria, mitjana, EDAT_GR), 
                 group = categoria,
                 color = categoria),
             size = 12) + 
 geom_text(aes(mitjana,
                reorder_within(categoria, mitjana, EDAT_GR), 
                group = categoria,
                label = point(mitjana)), 
            hjust = 0.5,
            fontface = "bold",
            color = "white",
            family = "open_sans", 
            size = 5) +
  scale_y_reordered() +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,10)) + 
  scale_color_manual(values = categ_5_colors) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0,0,-0.5,0, "cm"),
        text = element_text(size = 15, 
                            family = "open_sans", 
                            color  = "black"),
        strip.text.x = element_text(hjust=0)) +
  labs(x = "",
       y = "") +
facet_wrap(vars(EDAT_GR), 
             nrow=2,
             scales = "free_y")
PERSONALITAT_EDAT

ggsave(file.path(SOCIALS_IMG_FOLDER, "PERSONALITAT_EDAT.png"),
       plot = PERSONALITAT_EDAT,
       width = 23,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Valors socials i morals

```{r}
ACTITUD <- data |> 
  select(ACTITUD_ECONOMIA,
         ACTITUD_IMPOSTOS,
         ACTITUD_AUTORITAT,
         ACTITUD_OBEIR,
         ACTITUD_IMMIGRACIO,
         PONDERA) |>
  pivot_longer(starts_with("ACTITUD"), 
               names_to = "categoria", 
               values_to = "resposta") |>
  mutate(categoria = case_when(
  categoria == "ACTITUD_ECONOMIA" ~ "Com menys intervingui el Govern en l’economia, millor serà per al país",
  categoria == "ACTITUD_IMPOSTOS" ~ "Cal abaixar els impostos, encara que això impliqui reduir els serveis i les prestacions públiques",
  categoria == "ACTITUD_AUTORITAT" ~ "L’escola ha d’ensenyar els nens a obeir l’autoritat",
  categoria == "ACTITUD_OBEIR" ~ "En qualsevol circumstància, la llei sempre ha de ser obeïda",
  categoria == "ACTITUD_IMMIGRACIO" ~ "Amb tanta immigració, un ja no se sent com a casa"),
  resposta = case_when(
    resposta == 1 ~ "Molt d’acord",
    resposta == 2 ~ "D’acord",
    resposta == 3 ~ "Ni d’acord ni en desacord",
    resposta == 4 ~ "En desacord",
    resposta == 5 ~ "Molt en desacord",
    TRUE ~ "NS/NC"),
    resposta = factor(resposta, levels = c("Molt d’acord",
                                           "D’acord",
                                           "Ni d’acord ni en desacord",
                                           "En desacord",
                                           "Molt en desacord",
                                           "NS/NC"))) |>
  filter(!is.na(resposta)) |> 
  group_by(categoria, resposta) |>
  count(categoria, wt = PONDERA) |> 
  ungroup() |>
  group_by(categoria) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(proportion,
               fct_relevel(categoria,
                           c("En qualsevol circumstància, la llei sempre ha de ser obeïda",
                             "L’escola ha d’ensenyar els nens a obeir l’autoritat",
                             "Com menys intervingui el Govern en l’economia, millor serà per al país",
                             "Amb tanta immigració, un ja no se sent com a casa",
                             "Cal abaixar els impostos, encara que això impliqui reduir els serveis i les prestacions públiques")),
               group = rev(resposta),
               fill = resposta),
           width = 0.5) +
  geom_text(aes(proportion,
                fct_relevel(categoria,
                           c("En qualsevol circumstància, la llei sempre ha de ser obeïda",
                             "L’escola ha d’ensenyar els nens a obeir l’autoritat",
                             "Com menys intervingui el Govern en l’economia, millor serà per al país",
                             "Amb tanta immigració, un ja no se sent com a casa",
                             "Cal abaixar els impostos, encara que això impliqui reduir els serveis i les prestacions públiques")),
                group = rev(resposta),
                label = proportion,
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  geom_text(aes(x = 0, 
                label = categoria, 
                y = categoria), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = pos_neg_5_colors) +
  scale_color_manual(values = pos_neg_5_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
ACTITUD

ggsave(file.path(SOCIALS_IMG_FOLDER, "ACTITUD.png"),
       plot = ACTITUD,
       width = 23,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Valors socials i morals, franges d'edat

```{r}
ACTITUD_EDAT <- data |> 
  select(ACTITUD_ECONOMIA,
         ACTITUD_IMPOSTOS,
         ACTITUD_AUTORITAT,
         ACTITUD_OBEIR,
         ACTITUD_IMMIGRACIO,
         EDAT_GR,
         PONDERA) |>
  pivot_longer(starts_with("ACTITUD"), 
               names_to = "categoria", 
               values_to = "resposta") |>
  mutate(categoria = case_when(
  categoria == "ACTITUD_ECONOMIA" ~ "Com menys intervingui el Govern en l’economia, millor serà per al país",
  categoria == "ACTITUD_IMPOSTOS" ~ "Cal abaixar els impostos, encara que això impliqui reduir els serveis i les prestacions públiques",
  categoria == "ACTITUD_AUTORITAT" ~ "L’escola ha d’ensenyar els nens a obeir l’autoritat",
  categoria == "ACTITUD_OBEIR" ~ "En qualsevol circumstància, la llei sempre ha de ser obeïda",
  categoria == "ACTITUD_IMMIGRACIO" ~ "Amb tanta immigració, un ja no se sent com a casa"),
  resposta = case_when(
    resposta == 1 ~ "Molt + d’acord",
    resposta == 2 ~ "Molt + d’acord",
    resposta == 3 ~ "Ni d’acord ni en desacord",
    resposta == 4 ~ "Molt + en desacord",
    resposta == 5 ~ "Molt + en desacord",
    TRUE ~ "NS/NC"),
    resposta = factor(resposta, levels = c("Molt + d’acord",
                                           "Ni d’acord ni en desacord",
                                           "Molt + en desacord",
                                           "NS/NC"))) |>
  as_label(EDAT_GR, drop.levels = F) |> 
  filter(!is.na(resposta)) |> 
  group_by(EDAT_GR, categoria, resposta) |>
  count(categoria, wt = PONDERA) |> 
  ungroup() |>
  group_by(EDAT_GR, categoria) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |>
  complete(resposta, 
           fill = list(proportion = 0)) |>
  ggplot() +
  geom_col(aes(proportion,
               EDAT_GR,
               group = rev(resposta),
               fill = resposta),
           width = 0.8) +
  geom_text(aes(proportion,
                EDAT_GR,
                group = rev(resposta),
                label = ifelse(proportion > 2, proportion, ""),
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = pos_neg_3_colors) +
  scale_color_manual(values = pos_neg_3_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")+
  facet_wrap(vars(categoria),
             nrow = 1, 
             labeller = label_wrap_gen(width = 25,
                                       multi_line = TRUE))
ACTITUD_EDAT

ggsave(file.path(SOCIALS_IMG_FOLDER, "ACTITUD_EDAT.png"),
       plot = ACTITUD_EDAT,
       width = 32,
       height = 12,
       dpi = 300,
       units = "cm")
```

## Valors socials i morals, simpatia de partit

```{r}
ACTITUD_SIMP <- data |> 
  select(ACTITUD_ECONOMIA,
         ACTITUD_IMPOSTOS,
         ACTITUD_AUTORITAT,
         ACTITUD_OBEIR,
         ACTITUD_IMMIGRACIO,
         SIMPATIA_PARTIT_R,
         PONDERA) |>
  filter(!SIMPATIA_PARTIT_R %in% c(80, 98,99)) |>
  pivot_longer(starts_with("ACTITUD"), 
               names_to = "categoria", 
               values_to = "resposta") |>
  mutate(categoria = case_when(
  categoria == "ACTITUD_ECONOMIA" ~ "Com menys intervingui el Govern en l’economia, millor serà per al país",
  categoria == "ACTITUD_IMPOSTOS" ~ "Cal abaixar els impostos, encara que això impliqui reduir els serveis i les prestacions públiques",
  categoria == "ACTITUD_AUTORITAT" ~ "L’escola ha d’ensenyar els nens a obeir l’autoritat",
  categoria == "ACTITUD_OBEIR" ~ "En qualsevol circumstància, la llei sempre ha de ser obeïda",
  categoria == "ACTITUD_IMMIGRACIO" ~ "Amb tanta immigració, un ja no se sent com a casa"),
  resposta = case_when(
    resposta == 1 ~ "Molt + d’acord",
    resposta == 2 ~ "Molt + d’acord",
    resposta == 3 ~ "Ni d’acord ni en desacord",
    resposta == 4 ~ "Molt + en desacord",
    resposta == 5 ~ "Molt + en desacord",
    TRUE ~ "NS/NC"),
    resposta = factor(resposta, levels = c("Molt + d’acord",
                                           "Ni d’acord ni en desacord",
                                           "Molt + en desacord",
                                           "NS/NC"))) |>
    mutate(SIMPATIA_PARTIT_R = as_label(SIMPATIA_PARTIT_R), 
         SIMPATIA_PARTIT_R = clean_party_name(SIMPATIA_PARTIT_R),
         SIMPATIA_PARTIT_R = prettify_party_names(SIMPATIA_PARTIT_R)) |> 
  filter(!is.na(resposta)) |> 
  group_by(SIMPATIA_PARTIT_R, categoria, resposta) |>
  count(categoria, wt = PONDERA) |> 
  ungroup() |>
  group_by(SIMPATIA_PARTIT_R, categoria) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |>
  complete(resposta, 
           fill = list(proportion = 0)) |>
  ggplot() +
  geom_col(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("CUP",
                             "En Comú Podem",
                             "ERC",
                             "Junts per Catalunya",
                             "PSC",
                             "Ciudadanos*",
                             "PP", 
                             "Vox",
                             "Cap")),
               group = rev(resposta),
               fill = resposta),
           width = 0.8) +
  geom_text(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("CUP",
                             "En Comú Podem",
                             "ERC",
                             "Junts per Catalunya",
                             "PSC",
                             "Ciudadanos*",
                             "PP", 
                             "Vox",
                             "Cap")),
                group = rev(resposta),
                label = ifelse(proportion > 3, proportion, ""),
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = pos_neg_3_colors) +
  scale_color_manual(values = pos_neg_3_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")+
  facet_wrap(vars(categoria),
             nrow = 1, 
             labeller = label_wrap_gen(width = 25,
                                       multi_line = TRUE))
ACTITUD_SIMP

ggsave(file.path(SOCIALS_IMG_FOLDER, "ACTITUD_SIMP.png"),
       plot = ACTITUD_SIMP,
       width = 35,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Valors o qualitats a transmetre als fills

```{r}
VALORS_FILLS <- data |>
  select(PONDERA,
         resposta = VALORS_FILLS_1) |>
    mutate(resposta = case_when(
    resposta == 1 ~ "Independència de criteri",
    resposta == 2 ~ "Esforç/treball dur",
    resposta == 3 ~ "Imaginació/creativitat",
    resposta == 4 ~ "Obediència",
    TRUE ~ "NS/NC"),
    resposta = factor(resposta, levels = c("Imaginació/creativitat",
                                           "Independència de criteri",
                                           "Esforç/treball dur",
                                           "Obediència",
                                           "NS/NC"))) |>
  group_by(resposta) |>
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(proportion,
               fct_reorder(resposta, proportion),
               fill = resposta), 
           width = 0.5) +
  geom_text(aes(proportion,
                fct_reorder(resposta, proportion),
                label = proportion,
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  geom_text(aes(x = 0, 
                label = resposta, 
                y = resposta), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = categ_4_colors) +
  scale_color_manual(values = categ_4_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,-1,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
VALORS_FILLS

ggsave(file.path(SOCIALS_IMG_FOLDER, "VALORS_FILLS.png"),
       plot = VALORS_FILLS,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Valors o qualitats a transmetre als fills, segons ideologia

```{r}
VALORS_FILLS_IDEOL <- data |>
  select(PONDERA,
         ideologia = IDEOL_0_10,
         resposta = VALORS_FILLS_1) |>
  filter(!ideologia > 10)|>
    mutate(resposta = case_when(
    resposta == 1 ~ "Independència de criteri",
    resposta == 2 ~ "Esforç/treball dur",
    resposta == 3 ~ "Imaginació/creativitat",
    resposta == 4 ~ "Obediència",
    TRUE ~ "NS/NC"),
    resposta = factor(resposta, levels = c("Imaginació/creativitat",
                                           "Independència de criteri",
                                           "Esforç/treball dur",
                                           "Obediència",
                                           "NS/NC")),
    ideologia = case_when(
    ideologia < 3 ~ "Esquerra (0-2)",
    ideologia > 2 & ideologia < 5 ~ "Centre-esquerra (3-4)",
    ideologia == 5 ~ "Centre (5)",
    ideologia > 5 & ideologia < 8 ~ "Centre-dreta (6-7)",
    ideologia > 7 & ideologia <= 10 ~ "Dreta (8-10)"),
    ideologia = factor(ideologia, levels = c("Esquerra (0-2)",
                                             "Centre-esquerra (3-4)",
                                             "Centre (5)",
                                             "Centre-dreta (6-7)",
                                             "Dreta (8-10)"))) |>
  group_by(ideologia, resposta) |>
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  group_by(ideologia) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion)) |>
  complete(resposta, 
           fill = list(proportion = 0)) |> 
  ggplot() +
  geom_col(aes(proportion,
               ideologia,
               group = rev(resposta),
               fill = resposta),
           width = 0.8) +
  geom_text(aes(proportion,
                ideologia,
                group = rev(resposta),
                label = ifelse(proportion > 2, proportion, ""),
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = categ_4_colors) +
  scale_color_manual(values = categ_4_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
VALORS_FILLS_IDEOL

ggsave(file.path(SOCIALS_IMG_FOLDER, "VALORS_FILLS_IDEOL.png"),
       plot = VALORS_FILLS_IDEOL,
       width = 18,
       height = 12,
       dpi = 300,
       units = "cm")
```

## Valors o qualitats a transmetre als fills, segons simpatia de partit

```{r}
VALORS_FILLS_SIMP <- data |>
  select(PONDERA,
         SIMPATIA_PARTIT_R,
         resposta = VALORS_FILLS_1) |>
  filter(!SIMPATIA_PARTIT_R %in% c(80, 98,99)) |>
    mutate(resposta = case_when(
    resposta == 1 ~ "Independència de criteri",
    resposta == 2 ~ "Esforç/treball dur",
    resposta == 3 ~ "Imaginació/creativitat",
    resposta == 4 ~ "Obediència",
    TRUE ~ "NS/NC"),
    resposta = factor(resposta, levels = c("Imaginació/creativitat",
                                           "Independència de criteri",
                                           "Esforç/treball dur",
                                           "Obediència",
                                           "NS/NC"))) |>
    mutate(SIMPATIA_PARTIT_R = as_label(SIMPATIA_PARTIT_R), 
         SIMPATIA_PARTIT_R = clean_party_name(SIMPATIA_PARTIT_R),
         SIMPATIA_PARTIT_R = prettify_party_names(SIMPATIA_PARTIT_R)) |> 
  group_by(SIMPATIA_PARTIT_R, resposta) |>
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  group_by(SIMPATIA_PARTIT_R) |>
  mutate(proportion = (n / sum(n))*100) |>
  mutate(proportion = round_percent(proportion))  |> 
  complete(resposta, 
           fill = list(proportion = 0)) |> 
  ggplot() +
  geom_col(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("CUP",  
                             "En Comú Podem",
                             "Junts per Catalunya",
                             "ERC",
                             "PSC",
                             "Vox",
                             "PP", 
                             "Ciudadanos*",
                             "Cap")),
               group = rev(resposta),
               fill = resposta),
           width = 0.8) +
  geom_text(aes(proportion,
                  fct_relevel(SIMPATIA_PARTIT_R,
                           c("CUP",  
                             "En Comú Podem",
                             "Junts per Catalunya",
                             "ERC",
                             "PSC",
                             "Vox",
                             "PP", 
                             "Ciudadanos*",
                             "Cap")),
                group = rev(resposta),
                label = ifelse(proportion > 2, proportion, ""),
                color = resposta), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = categ_4_colors) +
  scale_color_manual(values = categ_4_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
VALORS_FILLS_SIMP

ggsave(file.path(SOCIALS_IMG_FOLDER, "VALORS_FILLS_SIMP.png"),
       plot = VALORS_FILLS_SIMP,
       width = 18,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Segona opció de valors o qualitats a transmetre als fills, per primera opció

```{r}
VALORS_FILLS_2 <- data |> 
  mutate(VALORS_FILLS_1 = case_when(
    VALORS_FILLS_1 == 1 ~ "Independència de criteri",
    VALORS_FILLS_1 == 2 ~ "Esforç/treball dur",
    VALORS_FILLS_1 == 3 ~ "Imaginació/creativitat",
    VALORS_FILLS_1 == 4 ~ "Obediència",
    TRUE ~ "NS/NC"),
    VALORS_FILLS_1 = factor(VALORS_FILLS_1, levels = c("Imaginació/creativitat",
                                           "Independència de criteri",
                                           "Esforç/treball dur",
                                           "Obediència",
                                           "NS/NC")),
    VALORS_FILLS_2 = case_when(
    VALORS_FILLS_2 == 1 ~ "Independència de criteri",
    VALORS_FILLS_2 == 2 ~ "Esforç/treball dur",
    VALORS_FILLS_2 == 3 ~ "Imaginació/creativitat",
    VALORS_FILLS_2 == 4 ~ "Obediència",
    TRUE ~ "NS/NC/Cap Altre"),
    VALORS_FILLS_2 = factor(VALORS_FILLS_2, levels = c("Imaginació/creativitat",
                                           "Independència de criteri",
                                           "Esforç/treball dur",
                                           "Obediència",
                                           "NS/NC/Cap Altre"))) |> 
  group_by(VALORS_FILLS_1, VALORS_FILLS_2) |> 
  summarize(n = length(VALORS_FILLS_1)) |>  
  ungroup() |>  
  group_by(VALORS_FILLS_1) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(VALORS_FILLS_1 != "NS/NC") |> 
  ggplot() + 
  geom_col(aes(proportion, 
               reorder_within(VALORS_FILLS_2, proportion, VALORS_FILLS_1), 
               fill = VALORS_FILLS_2)) +
  geom_vline(aes(xintercept = 0)) +
  geom_text(aes(x = proportion,
                y = reorder_within(VALORS_FILLS_2, proportion, VALORS_FILLS_1), 
                label = proportion),
            fontface = "bold",
            size = 5,
            hjust = -0.3) +
  scale_y_reordered() +
  scale_x_continuous(limits = c(0,75),
                     expand = c(0,0)) +
  scale_fill_manual(values = categ_4_colors) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        text = element_text(family = "open_sans",
                            size = 15,
                            color  = "black"),
        strip.text.x = element_text(hjust=0)) +
  labs(x = "",
       y = "") +
facet_wrap(vars(VALORS_FILLS_1), 
             nrow=3,
             scales = "free_y")
VALORS_FILLS_2

ggsave(file.path(SOCIALS_IMG_FOLDER, "VALORS_FILLS_2.png"),
       plot = VALORS_FILLS_2,
       width = 22,
       height = 12,
       dpi = 300,
       units = "cm")
```
## Grau d’acord amb la implementació de la RBU

```{r}
RBU_0_10 <- data |> 
  filter(RBU_0_10 < 100) |> 
  select(valoracio = RBU_0_10,
         PONDERA) |>
  mutate(distribucio = case_when(
    valoracio < 3 ~ "Totalment en desacord (0-2)",
    valoracio > 2 & valoracio < 5 ~ "3-4",
    valoracio > 4 & valoracio < 6 ~ "5",
    valoracio > 5 & valoracio < 8 ~ "6-7",
    valoracio > 7 & valoracio < 98 ~ "Totalment d'acord (8-10)",
    valoracio > 10 & valoracio < 100 ~ "NS/NC"),
    distribucio = factor(distribucio,
                         levels = c("Totalment en desacord (0-2)",
                                    "3-4",
                                    "5",
                                    "6-7",
                                    "Totalment d'acord (8-10)",
                                    "NS/NC"))) |> 
  count(distribucio, wt = PONDERA) |> 
  ungroup() |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(proportion,
               distribucio,
               fill = distribucio), 
           width = 0.5) +
  geom_text(aes(proportion,
                distribucio,
                label = proportion,
                color = distribucio), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  geom_text(aes(x = 0, 
                label = distribucio, 
                y = distribucio), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = c("#E66060", 
                               "#EE9595",
                               "#F9DA72",
                               "#BAE390", 
                               "#7EC23E",
                               "#C6C6C6")) +
  scale_color_manual(values = pos_neg_5_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,-1,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
RBU_0_10

ggsave(file.path(SOCIALS_IMG_FOLDER, "RBU_0_10.png"),
       plot = RBU_0_10,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Grau d’acord amb la implementació de la RGC

```{r}
RGC_0_10 <- data |> 
  filter(RGC_0_10 < 100) |> 
  select(valoracio = RGC_0_10,
         PONDERA) |>
  mutate(distribucio = case_when(
    valoracio < 3 ~ "Totalment en desacord (0-2)",
    valoracio > 2 & valoracio < 5 ~ "3-4",
    valoracio > 4 & valoracio < 6 ~ "5",
    valoracio > 5 & valoracio < 8 ~ "6-7",
    valoracio > 7 & valoracio < 98 ~ "Totalment d'acord (8-10)",
    valoracio > 10 & valoracio < 100 ~ "NS/NC"),
    distribucio = factor(distribucio,
                         levels = c("Totalment en desacord (0-2)",
                                    "3-4",
                                    "5",
                                    "6-7",
                                    "Totalment d'acord (8-10)",
                                    "NS/NC"))) |> 
  count(distribucio, wt = PONDERA) |> 
  ungroup() |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(proportion,
               distribucio,
               fill = distribucio), 
           width = 0.5) +
  geom_text(aes(proportion,
                distribucio,
                label = proportion,
                color = distribucio), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  geom_text(aes(x = 0, 
                label = distribucio, 
                y = distribucio), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = c("#E66060", 
                               "#EE9595",
                               "#F9DA72",
                               "#BAE390", 
                               "#7EC23E",
                               "#C6C6C6")) +
  scale_color_manual(values = pos_neg_5_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,-1,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
RGC_0_10

ggsave(file.path(SOCIALS_IMG_FOLDER, "RGC_0_10.png"),
       plot = RGC_0_10,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Grau d’acord amb la implementació de la RBU, segons simpatia de partit

```{r}
RBU_0_10_SIMP <- data |> 
  filter(RBU_0_10 < 100) |> 
  select(valoracio = RBU_0_10,
         SIMPATIA_PARTIT_R,
         PONDERA) |>
  filter(!SIMPATIA_PARTIT_R %in% c(80, 98,99)) |>
  mutate(distribucio = case_when(
    valoracio < 3 ~ "0-2",
    valoracio > 2 & valoracio < 5 ~ "3-4",
    valoracio > 4 & valoracio < 6 ~ "5",
    valoracio > 5 & valoracio < 8 ~ "6-7",
    valoracio > 7 & valoracio < 98 ~ "8-10",
    valoracio > 10 & valoracio < 100 ~ "NS/NC")) |> 
    mutate(SIMPATIA_PARTIT_R = as_label(SIMPATIA_PARTIT_R), 
         SIMPATIA_PARTIT_R = clean_party_name(SIMPATIA_PARTIT_R),
         SIMPATIA_PARTIT_R = prettify_party_names(SIMPATIA_PARTIT_R)) |> 
  group_by(SIMPATIA_PARTIT_R, distribucio) |> 
  count(distribucio, wt = PONDERA) |> 
  ungroup() |> 
  group_by(SIMPATIA_PARTIT_R) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |>
  ungroup() |> 
  complete(distribucio, 
           fill = list(proportion = 0)) |> 
  ggplot() +
  geom_col(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("CUP",
                             "Ciudadanos*",
                             "En Comú Podem",
                             "Junts per Catalunya",
                             "ERC",
                             "PP",
                             "PSC",
                             "Vox",
                             "Cap")),
               group = rev(distribucio),
               fill = distribucio), 
           width = 0.8) +
  geom_text(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("CUP",
                             "Ciudadanos*",
                             "En Comú Podem",
                             "Junts per Catalunya",
                             "ERC",
                             "PP",
                             "PSC",
                             "Vox",
                             "Cap")),
                group = rev(distribucio),
                label = ifelse(proportion > 2, proportion, ""),
                color = distribucio), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = c("#E66060", 
                               "#EE9595",
                               "#F9DA72",
                               "#BAE390", 
                               "#7EC23E",
                               "#C6C6C6")) +
  scale_color_manual(values = pos_neg_5_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
RBU_0_10_SIMP

ggsave(file.path(SOCIALS_IMG_FOLDER, "RBU_0_10_SIMP.png"),
       plot = RBU_0_10_SIMP,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Grau d’acord amb la implementació de la RGC, segons simpatia de partit

```{r}
RGC_0_10_SIMP <- data |> 
  filter(RGC_0_10 < 100) |> 
  select(valoracio = RGC_0_10,
         SIMPATIA_PARTIT_R,
         PONDERA) |>
  filter(!SIMPATIA_PARTIT_R %in% c(80, 98,99)) |>
  mutate(distribucio = case_when(
    valoracio < 3 ~ "0-2",
    valoracio > 2 & valoracio < 5 ~ "3-4",
    valoracio > 4 & valoracio < 6 ~ "5",
    valoracio > 5 & valoracio < 8 ~ "6-7",
    valoracio > 7 & valoracio < 98 ~ "8-10",
    valoracio > 10 & valoracio < 100 ~ "NS/NC")) |> 
   mutate(SIMPATIA_PARTIT_R = as_label(SIMPATIA_PARTIT_R), 
         SIMPATIA_PARTIT_R = clean_party_name(SIMPATIA_PARTIT_R),
         SIMPATIA_PARTIT_R = prettify_party_names(SIMPATIA_PARTIT_R)) |> 
  group_by(SIMPATIA_PARTIT_R, distribucio) |> 
  count(distribucio, wt = PONDERA) |> 
  ungroup() |> 
  group_by(SIMPATIA_PARTIT_R) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |>
  ungroup() |> 
  complete(distribucio, 
           fill = list(proportion = 0)) |> 
  ggplot() +
  geom_col(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("CUP",
                             "En Comú Podem",
                             "Junts per Catalunya",
                             "ERC",
                             "PSC",
                             "Ciudadanos*",
                             "PP",
                             "Vox",
                             "Cap")),
               group = rev(distribucio),
               fill = distribucio), 
           width = 0.8) +
  geom_text(aes(proportion,
               fct_relevel(SIMPATIA_PARTIT_R,
                           c("CUP",
                             "En Comú Podem",
                             "Junts per Catalunya",
                             "ERC",
                             "PSC",
                             "Ciudadanos*",
                             "PP",
                             "Vox",
                             "Cap")),
                group = rev(distribucio),
                label = ifelse(proportion > 2, proportion, ""),
                color = distribucio), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 6) +
  scale_fill_manual(values = c("#E66060", 
                               "#EE9595",
                               "#F9DA72",
                               "#BAE390", 
                               "#7EC23E",
                               "#C6C6C6")) +
  scale_color_manual(values = pos_neg_5_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
RGC_0_10_SIMP

ggsave(file.path(SOCIALS_IMG_FOLDER, "RGC_0_10_SIMP.png"),
       plot = RGC_0_10_SIMP,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Impacte de les noves tecnologies en la feina

```{r}
VAL_NTIC_FEINA_0_10 <- data |> 
  filter(SIT_LAB %in% c(1,3) | SIT_LAB_NO_ACTIU == 2) |> 
  select(valoracio = VAL_NTIC_FEINA_0_10,
         PONDERA) |>
  mutate(distribucio = case_when(
    valoracio < 3 ~ "Tindran un impacte molt negatiu (0-2)",
    valoracio > 2 & valoracio < 5 ~ "3-4",
    valoracio > 4 & valoracio < 6 ~ "5",
    valoracio > 5 & valoracio < 8 ~ "6-7",
    valoracio > 7 & valoracio < 98 ~ "Tindran un impacte molt positiu (8-10)",
    valoracio > 10 & valoracio < 100 ~ "NS/NC"),
    distribucio = factor(distribucio,
                         levels = c("Tindran un impacte molt negatiu (0-2)",
                                    "3-4",
                                    "5",
                                    "6-7",
                                    "Tindran un impacte molt positiu (8-10)",
                                    "NS/NC"))) |> 
  count(distribucio, wt = PONDERA) |> 
  ungroup() |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(proportion,
               distribucio,
               fill = distribucio), 
           width = 0.5) +
  geom_text(aes(proportion,
                distribucio,
                label = proportion,
                color = distribucio), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  geom_text(aes(x = 0, 
                label = distribucio, 
                y = distribucio), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = c("#E66060", 
                               "#EE9595",
                               "#F9DA72",
                               "#BAE390", 
                               "#7EC23E",
                               "#C6C6C6")) +
  scale_color_manual(values = pos_neg_5_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,-1,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
VAL_NTIC_FEINA_0_10

ggsave(file.path(SOCIALS_IMG_FOLDER, "VAL_NTIC_FEINA_0_10.png"),
       plot = VAL_NTIC_FEINA_0_10,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Impacte de les noves tecnologies en la feina, segons nivell d’estudis

```{r}
VAL_NTIC_FEINA_0_10_ESTUD <- data |> 
  filter(SIT_LAB %in% c(1,3) | SIT_LAB_NO_ACTIU == 2) |> 
  mutate(ESTUDIS_1_15 = case_when(
    ESTUDIS_1_15 < 4 ~ "Educació primària o inferior",
    ESTUDIS_1_15 > 3 & ESTUDIS_1_15 < 8 ~ "Educació secundària i similar",
    ESTUDIS_1_15 > 7  ~ "Educació superior")) |> 
  select(valoracio = VAL_NTIC_FEINA_0_10,
         ESTUDIS_1_15,
         PONDERA) |>
  mutate(distribucio = case_when(
    valoracio < 3 ~ "0-2",
    valoracio > 2 & valoracio < 5 ~ "3-4",
    valoracio > 4 & valoracio < 6 ~ "5",
    valoracio > 5 & valoracio < 8 ~ "6-7",
    valoracio > 7 & valoracio < 98 ~ "8-10",
    valoracio > 10 & valoracio < 100 ~ "NS/NC"),
    distribucio = factor(distribucio,
                         levels = c("0-2",
                                    "3-4",
                                    "5",
                                    "6-7",
                                    "8-10",
                                    "NS/NC"))) |> 
  as_label(ESTUDIS_1_15, drop.levels = F) |> 
  group_by(ESTUDIS_1_15, distribucio) |> 
  count(distribucio, wt = PONDERA) |> 
  ungroup() |> 
  group_by(ESTUDIS_1_15) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(proportion,
               ESTUDIS_1_15,
               group = rev(distribucio),
               fill = distribucio), 
           width = 0.5) +
  geom_text(aes(proportion,
                ESTUDIS_1_15,
                group = rev(distribucio),
                label = proportion,
                color = distribucio), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
   geom_text(aes(x = 0, 
                label = ESTUDIS_1_15, 
                y = ESTUDIS_1_15), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = c("#E66060", 
                               "#EE9595",
                               "#F9DA72",
                               "#BAE390", 
                               "#7EC23E",
                               "#C6C6C6")) +
  scale_color_manual(values = pos_neg_5_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
VAL_NTIC_FEINA_0_10_ESTUD

ggsave(file.path(SOCIALS_IMG_FOLDER, "VAL_NTIC_FEINA_0_10_ESTUD.png"),
       plot = VAL_NTIC_FEINA_0_10_ESTUD,
       width = 17,
       height = 12,
       dpi = 300,
       units = "cm")
```

## Impacte de les noves tecnologies en la feina, segons % d’automatització de tasques 

```{r}
VAL_NTIC_FEINA_0_10_AUTOM <- data |> 
  filter(SIT_LAB %in% c(1,3) | SIT_LAB_NO_ACTIU == 2) |> 
  select(valoracio = VAL_NTIC_FEINA_0_10,
         AUTOMATITZACIO_FEINA_0_100,
         PONDERA) |>
  mutate(AUTOMATITZACIO_FEINA_0_100 = case_when(
    AUTOMATITZACIO_FEINA_0_100 < 26 ~ "0%-25%",
    AUTOMATITZACIO_FEINA_0_100 > 25 & AUTOMATITZACIO_FEINA_0_100 < 51 ~ "26%-50%",
    AUTOMATITZACIO_FEINA_0_100 > 50 & AUTOMATITZACIO_FEINA_0_100 < 76 ~ "51%-75%",
    AUTOMATITZACIO_FEINA_0_100 > 75 & AUTOMATITZACIO_FEINA_0_100 < 998 ~ "76%-100%"),
    distribucio = case_when(
    valoracio < 3 ~ "0-2",
    valoracio > 2 & valoracio < 5 ~ "3-4",
    valoracio > 4 & valoracio < 6 ~ "5",
    valoracio > 5 & valoracio < 8 ~ "6-7",
    valoracio > 7 & valoracio < 98 ~ "8-10",
    valoracio > 10 & valoracio < 100 ~ "NS/NC"),
    distribucio = factor(distribucio,
                         levels = c("0-2",
                                    "3-4",
                                    "5",
                                    "6-7",
                                    "8-10",
                                    "NS/NC"))) |> 
  filter(!is.na(AUTOMATITZACIO_FEINA_0_100)) |> 
  group_by(AUTOMATITZACIO_FEINA_0_100, distribucio) |> 
  count(distribucio, wt = PONDERA) |> 
  ungroup() |> 
  group_by(AUTOMATITZACIO_FEINA_0_100) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |>
  complete(distribucio, 
           fill = list(proportion = 0)) |> 
  ggplot() +
  geom_col(aes(proportion,
               AUTOMATITZACIO_FEINA_0_100,
               group = rev(distribucio),
               fill = distribucio), 
           width = 0.5) +
  geom_text(aes(proportion,
                AUTOMATITZACIO_FEINA_0_100,
                group = rev(distribucio),
                label = ifelse(proportion > 2, proportion, ""),
                color = distribucio), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
   geom_text(aes(x = 0, 
                label = AUTOMATITZACIO_FEINA_0_100, 
                y = AUTOMATITZACIO_FEINA_0_100), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = c("#E66060", 
                               "#EE9595",
                               "#F9DA72",
                               "#BAE390", 
                               "#7EC23E",
                               "#C6C6C6")) +
  scale_color_manual(values = pos_neg_5_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
VAL_NTIC_FEINA_0_10_AUTOM

ggsave(file.path(SOCIALS_IMG_FOLDER, "VAL_NTIC_FEINA_0_10_AUTOM.png"),
       plot = VAL_NTIC_FEINA_0_10_AUTOM,
       width = 17,
       height = 12,
       dpi = 300,
       units = "cm")
```

## Preocupació de l’impacte de les tecnologies en la feina

```{r}
TECNOESTRES <- data |> 
  filter(SIT_LAB %in% c(1,3) | SIT_LAB_NO_ACTIU == 2) |> 
  select(TECNOESTRES,
         PONDERA) |>
  mutate(TECNOESTRES = case_when(
    TECNOESTRES == 1 ~ "Molt",
    TECNOESTRES == 2 ~ "Bastant",
    TECNOESTRES == 3 ~ "Poc",
    TECNOESTRES == 4 ~ "Gens",
    TRUE ~ "NS/NC"),
    TECNOESTRES = factor(TECNOESTRES, levels = c("Molt",
                                                 "Bastant",
                                                 "Poc",
                                                 "Gens",
                                                 "NS/NC"))) |> 
  count(TECNOESTRES, wt = PONDERA) |> 
  ungroup() |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(TECNOESTRES != "NS/NC") |> 
  ggplot() +
  geom_col(aes(proportion,
               TECNOESTRES,
               fill = TECNOESTRES), 
           width = 0.5) +
  geom_text(aes(proportion,
                TECNOESTRES,
                label = proportion,
                color = TECNOESTRES), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  geom_text(aes(x = 0, 
                label = TECNOESTRES, 
                y = TECNOESTRES), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = c("#E66060",
                               "#EE9595",
                               "#BAE390",
                               "#7EC23E",
                               "#C6C6C6")) +
  scale_color_manual(values = pos_neg_4_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,-1,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
TECNOESTRES

ggsave(file.path(SOCIALS_IMG_FOLDER, "TECNOESTRES.png"),
       plot = TECNOESTRES,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Preocupació de l’impacte de les tecnologies en la feina, segons nivell d’estudis

```{r}
TECNOESTRES_ESTUD <- data |> 
  filter(SIT_LAB %in% c(1,3) | SIT_LAB_NO_ACTIU == 2) |> 
  select(TECNOESTRES,
         ESTUDIS_1_15,
         PONDERA) |>
  mutate(ESTUDIS_1_15 = case_when(
    ESTUDIS_1_15 < 4 ~ "Educació primària o inferior",
    ESTUDIS_1_15 > 3 & ESTUDIS_1_15 < 8 ~ "Educació secundària i similar",
    ESTUDIS_1_15 > 7  ~ "Educació superior"),
    TECNOESTRES = case_when(
    TECNOESTRES == 1 ~ "Molt",
    TECNOESTRES == 2 ~ "Bastant",
    TECNOESTRES == 3 ~ "Poc",
    TECNOESTRES == 4 ~ "Gens",
    TRUE ~ "NS/NC"),
    TECNOESTRES = factor(TECNOESTRES, levels = c("Molt",
                                                 "Bastant",
                                                 "Poc",
                                                 "Gens",
                                                 "NS/NC"))) |> 
  group_by(ESTUDIS_1_15, TECNOESTRES) |> 
  count(TECNOESTRES, wt = PONDERA) |> 
  ungroup() |> 
  group_by(ESTUDIS_1_15) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(proportion,
               ESTUDIS_1_15,
               group = rev(TECNOESTRES),
               fill = TECNOESTRES), 
           width = 0.5) +
  geom_text(aes(proportion,
                ESTUDIS_1_15,
                group = rev(TECNOESTRES),
                label = ifelse(proportion > 2, proportion, ""),
                color = TECNOESTRES), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
     geom_text(aes(x = 0, 
                label = ESTUDIS_1_15, 
                y = ESTUDIS_1_15), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = c("#E66060",
                               "#EE9595",
                               "#BAE390",
                               "#7EC23E",
                               "#C6C6C6")) +
  scale_color_manual(values = pos_neg_4_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
TECNOESTRES_ESTUD

ggsave(file.path(SOCIALS_IMG_FOLDER, "TECNOESTRES_ESTUD.png"),
       plot = TECNOESTRES_ESTUD,
       width = 17,
       height = 12,
       dpi = 300,
       units = "cm")
```

## Preocupació de l’impacte de les tecnologies en la feina, segons % d’automatització de tasques 

```{r}
TECNOESTRES_AUTO <- data |> 
  filter(SIT_LAB %in% c(1,3) | SIT_LAB_NO_ACTIU == 2) |> 
  select(TECNOESTRES,
         AUTOMATITZACIO_FEINA_0_100,
         PONDERA) |>
  mutate(AUTOMATITZACIO_FEINA_0_100 = case_when(
    AUTOMATITZACIO_FEINA_0_100 < 26 ~ "0%-25%",
    AUTOMATITZACIO_FEINA_0_100 > 25 & AUTOMATITZACIO_FEINA_0_100 < 51 ~ "26%-50%",
    AUTOMATITZACIO_FEINA_0_100 > 50 & AUTOMATITZACIO_FEINA_0_100 < 76 ~ "51%-75%",
    AUTOMATITZACIO_FEINA_0_100 > 75 & AUTOMATITZACIO_FEINA_0_100 < 998 ~ "76%-100%"),
    TECNOESTRES = case_when(
    TECNOESTRES == 1 ~ "Molt",
    TECNOESTRES == 2 ~ "Bastant",
    TECNOESTRES == 3 ~ "Poc",
    TECNOESTRES == 4 ~ "Gens",
    TRUE ~ "NS/NC"),
    TECNOESTRES = factor(TECNOESTRES, levels = c("Molt",
                                                 "Bastant",
                                                 "Poc",
                                                 "Gens",
                                                 "NS/NC"))) |> 
  filter(!is.na(AUTOMATITZACIO_FEINA_0_100)) |> 
  group_by(AUTOMATITZACIO_FEINA_0_100, TECNOESTRES) |> 
  count(TECNOESTRES, wt = PONDERA) |> 
  ungroup() |> 
  group_by(AUTOMATITZACIO_FEINA_0_100) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |>
  complete(TECNOESTRES, 
           fill = list(proportion = 0)) |> 
  ggplot() +
  geom_col(aes(proportion,
               AUTOMATITZACIO_FEINA_0_100,
               group = rev(TECNOESTRES),
               fill = TECNOESTRES), 
           width = 0.5) +
  geom_text(aes(proportion,
                AUTOMATITZACIO_FEINA_0_100,
                group = rev(TECNOESTRES),
                label = ifelse(proportion > 2, proportion, ""),
                color = TECNOESTRES), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
     geom_text(aes(x = 0, 
                label = AUTOMATITZACIO_FEINA_0_100, 
                y = AUTOMATITZACIO_FEINA_0_100), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = c("#E66060",
                               "#EE9595",
                               "#BAE390",
                               "#7EC23E",
                               "#C6C6C6")) +
  scale_color_manual(values = pos_neg_4_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
TECNOESTRES_AUTO

ggsave(file.path(SOCIALS_IMG_FOLDER, "TECNOESTRES_AUTO.png"),
       plot = TECNOESTRES_AUTO,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```
## Ús de xarxes socials

```{r}
UTILITZA_XARXES <- data|> 
  select(starts_with("UTILITZA"),
         PONDERA)|>
    pivot_longer(starts_with("UTILITZA"), 
               names_to = "xarxa", 
               values_to = "resposta")|>
  mutate(xarxa = case_when(
  xarxa == "UTILITZA_FACEBOOK" ~ "Facebook",
  xarxa == "UTILITZA_INSTAGRAM" ~ "Instagram",
  xarxa == "UTILITZA_LINKEDIN" ~ "LinkedIn",
  xarxa == "UTILITZA_TWITTER" ~ "Twitter",
  xarxa == "UTILITZA_TELEGRAM" ~ "Telegram",
  xarxa == "UTILITZA_WHATSAPP_2" ~ "Whatsapp",
  xarxa == "UTILITZA_TIKTOK" ~ "Tik-Tok",
  xarxa == "UTILITZA_TWITCH" ~ "Twitch",
  xarxa == "UTILITZA_YOUTUBE" ~ "YouTube",
  xarxa == "UTILITZA_CAP" ~ "Cap"),
  resposta = case_when(
    resposta == 1 ~ "Sí",
    TRUE ~ "No"
  ))|> 
  group_by(xarxa, resposta)|>
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  group_by(xarxa)|>
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(resposta != "No") |> 
  ggplot() +
  geom_col(aes(x = proportion,
               y = fct_reorder(xarxa, proportion),
               fill = xarxa)) +
    geom_text(aes(x = proportion,
                y = fct_reorder(xarxa, proportion),
                label = proportion), 
            hjust = -0.3,
            family = "open_sans", 
            color = "#646464",
            fontface = "bold",
            size = 6) +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,100)) +
  scale_fill_manual(values = c("Facebook" = "#1176EF",
                               "Instagram" = "#FB2873",
                               "LinkedIn" = "#2C67B1",
                               "Twitter" = "#2399F1",
                               "Telegram" = "#00AAE0",
                               "Whatsapp" = "#29D955",
                               "Tik-Tok" = "#000000",
                               "Twitch" = "#A744FF",
                               "YouTube" = "#FD0304",
                               "Cap" = "#C6C6C6")) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size = 15),
        plot.margin = margin(0.5,1,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
UTILITZA_XARXES

ggsave(file.path(SOCIALS_IMG_FOLDER, "UTILITZA_XARXES.png"),
       plot = UTILITZA_XARXES,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Ús de xarxes socials, per franges d'edat

```{r}
UTILITZA_XARXES_EDAT <- data |> 
  select(EDAT_GR, 
         PONDERA,
         starts_with("UTILITZA")) |>
  pivot_longer(starts_with("UTILITZA"), 
               names_to = "xarxa", 
               values_to = "resposta") |>
  mutate(xarxa = case_when(
  xarxa == "UTILITZA_FACEBOOK" ~ "Facebook",
  xarxa == "UTILITZA_INSTAGRAM" ~ "Instagram",
  xarxa == "UTILITZA_LINKEDIN" ~ "LinkedIn",
  xarxa == "UTILITZA_TWITTER" ~ "Twitter",
  xarxa == "UTILITZA_TELEGRAM" ~ "Telegram",
  xarxa == "UTILITZA_WHATSAPP_2" ~ "Whatsapp",
  xarxa == "UTILITZA_TIKTOK" ~ "Tik-Tok",
  xarxa == "UTILITZA_TWITCH" ~ "Twitch",
  xarxa == "UTILITZA_YOUTUBE" ~ "YouTube",
  xarxa == "UTILITZA_CAP" ~ "Cap"),
  resposta = case_when(
    resposta == 1 ~ "Sí",
    TRUE ~ "No")) |> 
  as_label(EDAT_GR, drop.levels = F) |> 
  group_by(EDAT_GR, xarxa, resposta)|>
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  group_by(EDAT_GR, xarxa)|>
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(resposta != "No") |> 
  ggplot() +
  geom_col(aes(x = proportion,
               y = reorder_within(xarxa, proportion, EDAT_GR),
               fill = xarxa)) +
    geom_text(aes(x = proportion,
                y = reorder_within(xarxa, proportion, EDAT_GR),
                label = proportion), 
            hjust = -0.3,
            family = "open_sans", 
            color = "#646464",
            fontface = "bold",
            size = 5) +
  geom_vline(aes(xintercept = 0)) +
  scale_y_reordered() +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,140)) +
  scale_fill_manual(values = c("Facebook" = "#1176EF",
                               "Instagram" = "#FB2873",
                               "LinkedIn" = "#2C67B1",
                               "Twitter" = "#2399F1",
                               "Telegram" = "#00AAE0",
                               "Whatsapp" = "#29D955",
                               "Tik-Tok" = "#000000",
                               "Twitch" = "#A744FF",
                               "YouTube" = "#FD0304",
                               "Cap" = "#C6C6C6")) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0,0, "cm"),
        text = element_text(size = 15,
                            family = "open_sans", 
                            color  = "black"),
        strip.text.x = element_text(hjust=0)) +
  labs(x = "",
       y = "") +
facet_wrap(vars(EDAT_GR), 
             nrow=2,
             scales = "free_y")
UTILITZA_XARXES_EDAT

ggsave(file.path(SOCIALS_IMG_FOLDER, "UTILITZA_XARXES_EDAT.png"),
       plot = UTILITZA_XARXES_EDAT,
       width = 22,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Ús de xarxes socials, segons gènere (joves)

```{r}
UTILITZA_XARXES_GENERE <- data |> 
  filter(EDAT_GR == 1, 
         GENERE < 3) |> 
  select(GENERE, 
         PONDERA,
         starts_with("UTILITZA")) |>
  pivot_longer(starts_with("UTILITZA"), 
               names_to = "xarxa", 
               values_to = "resposta") |>
  mutate(xarxa = case_when(
  xarxa == "UTILITZA_FACEBOOK" ~ "Facebook",
  xarxa == "UTILITZA_INSTAGRAM" ~ "Instagram",
  xarxa == "UTILITZA_LINKEDIN" ~ "LinkedIn",
  xarxa == "UTILITZA_TWITTER" ~ "Twitter",
  xarxa == "UTILITZA_TELEGRAM" ~ "Telegram",
  xarxa == "UTILITZA_WHATSAPP_2" ~ "Whatsapp",
  xarxa == "UTILITZA_TIKTOK" ~ "Tik-Tok",
  xarxa == "UTILITZA_TWITCH" ~ "Twitch",
  xarxa == "UTILITZA_YOUTUBE" ~ "YouTube",
  xarxa == "UTILITZA_CAP" ~ "Cap"),
  resposta = case_when(
    resposta == 1 ~ "Sí",
    TRUE ~ "No")) |> 
  mutate(GENERE = case_when(
    GENERE == 1 ~ "Homes de 18-24 anys",
    GENERE == 2 ~ "Dones de 18-24 anys")) |> 
  group_by(GENERE, xarxa, resposta)|>
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  group_by(GENERE, xarxa)|>
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(resposta != "No") |> 
 ggplot() +
  geom_col(aes(x = proportion,
               y = reorder_within(xarxa, proportion, GENERE),
               fill = xarxa)) +
    geom_text(aes(x = proportion,
                y = reorder_within(xarxa, proportion, GENERE),
                label = proportion), 
            hjust = -0.3,
            family = "open_sans", 
            color = "#646464",
            fontface = "bold",
            size = 5) +
  geom_vline(aes(xintercept = 0)) +
  scale_y_reordered() +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,112)) +
  scale_fill_manual(values = c("Facebook" = "#1176EF",
                               "Instagram" = "#FB2873",
                               "LinkedIn" = "#2C67B1",
                               "Twitter" = "#2399F1",
                               "Telegram" = "#00AAE0",
                               "Whatsapp" = "#29D955",
                               "Tik-Tok" = "#000000",
                               "Twitch" = "#A744FF",
                               "YouTube" = "#FD0304",
                               "Cap" = "#C6C6C6")) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0,0, "cm"),
        text = element_text(size = 15,
                            family = "open_sans", 
                            color  = "black"),
        strip.text.x = element_text(hjust=0)) +
  labs(x = "",
       y = "") +
facet_wrap(vars(GENERE), 
             nrow=2,
             scales = "free_y")
UTILITZA_XARXES_GENERE

ggsave(file.path(SOCIALS_IMG_FOLDER, "UTILITZA_XARXES_GENERE.png"),
       plot = UTILITZA_XARXES_GENERE,
       width = 14,
       height = 14,
       dpi = 300,
       units = "cm")
```

# ------------------------------------------------------------------------------

# Altres qüestions sociopolítiques

## Plat preferit dels catalans

```{r}
PLAT_PREFERIT <- data|> 
  select(PLAT_PREFERIT,
         PONDERA)|>
  mutate(PLAT_PREFERIT = case_when(
    PLAT_PREFERIT == 80 ~ "Altres",
    PLAT_PREFERIT == 97 ~ "NS/NC",
    PLAT_PREFERIT == 98 ~ "NS/NC",
    PLAT_PREFERIT == 99 ~ "NS/NC",
    PLAT_PREFERIT > 99  & PLAT_PREFERIT < 200 ~ "Sopes i plats de cullera",
    PLAT_PREFERIT > 199  & PLAT_PREFERIT < 300 ~ "Entrants i tapes",
    PLAT_PREFERIT > 299  & PLAT_PREFERIT < 400 ~ "Carns i pollastre",
    PLAT_PREFERIT > 399  & PLAT_PREFERIT < 500 ~ "Peixos i Marisc",
    PLAT_PREFERIT > 499  & PLAT_PREFERIT < 600 ~ "Verdures",
    PLAT_PREFERIT > 699  & PLAT_PREFERIT < 800 ~ "Arròs i Paella",
    PLAT_PREFERIT > 799  & PLAT_PREFERIT < 900 ~ "Pasta i Fideuada",
    PLAT_PREFERIT == 900 ~ "Pizza",
    PLAT_PREFERIT == 1000 ~ "Postres, dolços",
    PLAT_PREFERIT == 1100 ~ "Canelons / Lasanya",
    PLAT_PREFERIT == 1200 ~ "Sushi")) |> 
  group_by(PLAT_PREFERIT)|>
  count(PLAT_PREFERIT, wt = PONDERA) |> 
  ungroup() |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(x = proportion,
               y = fct_relevel(PLAT_PREFERIT,
                               c("Arròs i Paella",
                                 "Pasta i Fideuada",
                                 "Entrants i tapes",
                                 "Carns i pollastre",
                                 "Sopes i plats de cullera",
                                 "Verdures",
                                 "Peixos i Marisc",
                                 "Pizza",
                                 "Canelons / Lasanya",
                                 "Sushi",
                                 "Postres, dolços",
                                 "Altres",
                                 "NS/NC")),
               fill = PLAT_PREFERIT)) +
    geom_text(aes(x = proportion,
                y = fct_relevel(PLAT_PREFERIT,
                                c("Arròs i Paella",
                                 "Pasta i Fideuada",
                                 "Entrants i tapes",
                                 "Carns i pollastre",
                                 "Sopes i plats de cullera",
                                 "Verdures",
                                 "Peixos i Marisc",
                                 "Pizza",
                                 "Canelons / Lasanya",
                                 "Sushi",
                                 "Postres, dolços",
                                 "Altres",
                                 "NS/NC")),
                label = proportion), 
            hjust = -0.3,
            family = "open_sans", 
            color = "#646464",
            fontface = "bold",
            size = 6) +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,100)) +
  scale_y_discrete(limits = rev) +
  scale_fill_manual(values = c("Arròs i Paella" = "#646464",
                                 "Pasta i Fideuada" = "#646464",
                                 "Entrants i tapes" = "#646464",
                                 "Carns i pollastre" = "#646464",
                                 "Sopes i plats de cullera" = "#646464",
                                 "Verdures" = "#646464",
                                 "Peixos i Marisc" = "#646464",
                                 "Pizza" = "#646464",
                                 "Canelons / Lasanya" = "#646464",
                                 "Sushi" = "#646464",
                                 "Postres, dolços" = "#646464",
                                 "Altres" = "#C6C6C6",
                                 "NS/NC" = "#C6C6C6")) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size = 15),
        plot.margin = margin(0.5,1,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
PLAT_PREFERIT

ggsave(file.path(ALTRES_IMG_FOLDER, "PLAT_PREFERIT.png"),
       plot = PLAT_PREFERIT,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Plat preferit dels catalans, per franges d'edat

```{r}
PLAT_PREFERIT_EDAT <- data|> 
  select(PLAT_PREFERIT,
         EDAT_GR,
         PONDERA)|>
  mutate(PLAT_PREFERIT = case_when(
    PLAT_PREFERIT == 80 ~ "Altres",
    PLAT_PREFERIT == 97 ~ "NS/NC",
    PLAT_PREFERIT == 98 ~ "NS/NC",
    PLAT_PREFERIT == 99 ~ "NS/NC",
    PLAT_PREFERIT > 99  & PLAT_PREFERIT < 200 ~ "Sopes i plats de cullera",
    PLAT_PREFERIT > 199  & PLAT_PREFERIT < 300 ~ "Entrants i tapes",
    PLAT_PREFERIT > 299  & PLAT_PREFERIT < 400 ~ "Carns i pollastre",
    PLAT_PREFERIT > 399  & PLAT_PREFERIT < 500 ~ "Peixos i Marisc",
    PLAT_PREFERIT > 499  & PLAT_PREFERIT < 600 ~ "Verdures",
    PLAT_PREFERIT > 699  & PLAT_PREFERIT < 800 ~ "Arròs i Paella",
    PLAT_PREFERIT > 799  & PLAT_PREFERIT < 900 ~ "Pasta i Fideuada",
    PLAT_PREFERIT == 900 ~ "Pizza",
    PLAT_PREFERIT == 1000 ~ "Postres, dolços",
    PLAT_PREFERIT == 1100 ~ "Canelons / Lasanya",
    PLAT_PREFERIT == 1200 ~ "Sushi")) |> 
  as_label(EDAT_GR, drop.levels = F) |> 
  group_by(EDAT_GR, PLAT_PREFERIT)|>
  count(PLAT_PREFERIT, wt = PONDERA) |> 
  ungroup() |> 
   group_by(EDAT_GR)|>
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |>
  filter(!PLAT_PREFERIT %in% c("NS/NC", "Altres")) |> 
  ggplot() +
  geom_col(aes(x = proportion,
               y = reorder_within(PLAT_PREFERIT, proportion, EDAT_GR),
               fill = PLAT_PREFERIT)) +
    geom_text(aes(x = proportion,
                y = reorder_within(PLAT_PREFERIT, proportion, EDAT_GR),
                label = proportion), 
            hjust = -0.3,
            family = "open_sans", 
            color = "#646464",
            fontface = "bold",
            size = 5) +
  geom_vline(aes(xintercept = 0)) +
  scale_y_reordered() +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,140)) +
  scale_fill_manual(values = c("Arròs i Paella" = "#646464",
                                 "Pasta i Fideuada" = "#646464",
                                 "Entrants i tapes" = "#646464",
                                 "Carns i pollastre" = "#646464",
                                 "Sopes i plats de cullera" = "#646464",
                                 "Verdures" = "#646464",
                                 "Peixos i Marisc" = "#646464",
                                 "Pizza" = "#646464",
                                 "Canelons / Lasanya" = "#646464",
                                 "Sushi" = "#646464",
                                 "Postres, dolços" = "#646464")) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0,0, "cm"),
        text = element_text(size = 15,
                            family = "open_sans", 
                            color  = "black"),
        strip.text.x = element_text(hjust=0)) +
  labs(x = "",
       y = "") +
facet_wrap(vars(EDAT_GR), 
             nrow=2,
             scales = "free_y")
PLAT_PREFERIT_EDAT

ggsave(file.path(ALTRES_IMG_FOLDER, "PLAT_PREFERIT_EDAT.png"),
       plot = PLAT_PREFERIT_EDAT,
       width = 25.5,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Plat preferit dels catalans, segons mida de municipi

```{r}
PLAT_PREFERIT_HABITAT <- data|> 
  select(PLAT_PREFERIT,
         HABITAT,
         PONDERA)|>
  mutate(PLAT_PREFERIT = case_when(
    PLAT_PREFERIT == 80 ~ "Altres",
    PLAT_PREFERIT == 97 ~ "NS/NC",
    PLAT_PREFERIT == 98 ~ "NS/NC",
    PLAT_PREFERIT == 99 ~ "NS/NC",
    PLAT_PREFERIT > 99  & PLAT_PREFERIT < 200 ~ "Sopes i plats de cullera",
    PLAT_PREFERIT > 199  & PLAT_PREFERIT < 300 ~ "Entrants i tapes",
    PLAT_PREFERIT > 299  & PLAT_PREFERIT < 400 ~ "Carns i pollastre",
    PLAT_PREFERIT > 399  & PLAT_PREFERIT < 500 ~ "Peixos i Marisc",
    PLAT_PREFERIT > 499  & PLAT_PREFERIT < 600 ~ "Verdures",
    PLAT_PREFERIT > 699  & PLAT_PREFERIT < 800 ~ "Arròs i Paella",
    PLAT_PREFERIT > 799  & PLAT_PREFERIT < 900 ~ "Pasta i Fideuada",
    PLAT_PREFERIT == 900 ~ "Pizza",
    PLAT_PREFERIT == 1000 ~ "Postres, dolços",
    PLAT_PREFERIT == 1100 ~ "Canelons / Lasanya",
    PLAT_PREFERIT == 1200 ~ "Sushi")) |> 
  as_label(HABITAT, drop.levels = F) |> 
  group_by(HABITAT, PLAT_PREFERIT)|>
  count(PLAT_PREFERIT, wt = PONDERA) |> 
  ungroup() |> 
   group_by(HABITAT)|>
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |>
  filter(!PLAT_PREFERIT %in% c("NS/NC", "Altres")) |> 
  ggplot() +
  geom_col(aes(x = proportion,
               y = reorder_within(PLAT_PREFERIT, proportion, HABITAT),
               fill = PLAT_PREFERIT)) +
    geom_text(aes(x = proportion,
                y = reorder_within(PLAT_PREFERIT, proportion, HABITAT),
                label = proportion), 
            hjust = -0.3,
            family = "open_sans", 
            color = "#646464",
            fontface = "bold",
            size = 5) +
  geom_vline(aes(xintercept = 0)) +
  scale_y_reordered() +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,140)) +
  scale_fill_manual(values = c("Arròs i Paella" = "#646464",
                                 "Pasta i Fideuada" = "#646464",
                                 "Entrants i tapes" = "#646464",
                                 "Carns i pollastre" = "#646464",
                                 "Sopes i plats de cullera" = "#646464",
                                 "Verdures" = "#646464",
                                 "Peixos i Marisc" = "#646464",
                                 "Pizza" = "#646464",
                                 "Canelons / Lasanya" = "#646464",
                                 "Sushi" = "#646464",
                                 "Postres, dolços" = "#646464")) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0,0, "cm"),
        text = element_text(size = 15,
                            family = "open_sans", 
                            color  = "black"),
        strip.text.x = element_text(hjust=0)) +
  labs(x = "",
       y = "") +
facet_wrap(vars(HABITAT), 
             nrow=2,
             scales = "free_y")
PLAT_PREFERIT_HABITAT

ggsave(file.path(ALTRES_IMG_FOLDER, "PLAT_PREFERIT_HABITAT.png"),
       plot = PLAT_PREFERIT_HABITAT,
       width = 30,
       height = 14,
       dpi = 300,
       units = "cm")
```


## Plat més representatiu de la cuina catalana

```{r}
PLAT_CUINA_CATALANA <- data|> 
  select(PLAT_CUINA_CATALANA,
         PONDERA)|>
    mutate(PLAT_CUINA_CATALANA = case_when(
    PLAT_CUINA_CATALANA == 1 ~ "Pa amb tomàquet",
    PLAT_CUINA_CATALANA == 2 ~ "Calçots",
    PLAT_CUINA_CATALANA == 3 ~ "Botifarra/llonganissa/fesols/seques",
    PLAT_CUINA_CATALANA == 4 ~ "Fricandó",
    PLAT_CUINA_CATALANA == 5 ~ "Cargols a la llauna",
    PLAT_CUINA_CATALANA == 6 ~ "Escalivada",
    PLAT_CUINA_CATALANA == 7 ~ "Altres",
    PLAT_CUINA_CATALANA == 8 ~ "Crema catalana",
    PLAT_CUINA_CATALANA == 9 ~ "Altres",
    PLAT_CUINA_CATALANA == 10 ~ "Panellets",
    PLAT_CUINA_CATALANA == 11 ~ "Escudella",
    PLAT_CUINA_CATALANA == 12 ~ "Altres",
    PLAT_CUINA_CATALANA == 13 ~ "Altres",
    PLAT_CUINA_CATALANA == 14 ~ "Canelons",
    PLAT_CUINA_CATALANA == 15 ~ "Paella / Fideuada",
    PLAT_CUINA_CATALANA == 16 ~ "Altres",
    PLAT_CUINA_CATALANA == 17 ~ "Altres",
    PLAT_CUINA_CATALANA == 80 ~ "Altres",
    TRUE ~ "NS/NC")) |> 
  as_label(PLAT_CUINA_CATALANA, drop.levels = F) |> 
  group_by(PLAT_CUINA_CATALANA)|>
  count(PLAT_CUINA_CATALANA, wt = PONDERA) |> 
  ungroup() |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(x = proportion,
               y = fct_relevel(PLAT_CUINA_CATALANA,
                               c("Escudella",
                                 "Botifarra/llonganissa/fesols/seques",
                                 "Pa amb tomàquet",
                                 "Calçots",
                                 "Crema catalana",
                                 "Canelons",
                                 "Paella / Fideuada",
                                 "Fricandó",
                                 "Escalivada",
                                 "Cargols a la llauna",
                                 "Altres",
                                 "NS/NC")),
               fill = PLAT_CUINA_CATALANA)) +
    geom_text(aes(x = proportion,
                y = fct_reorder(PLAT_CUINA_CATALANA, proportion),
                label = proportion), 
            hjust = -0.3,
            family = "open_sans", 
            color = "#646464",
            fontface = "bold",
            size = 6) +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,100)) +
  scale_y_discrete(limits = rev) +
  scale_fill_manual(values = c("Escudella" = "#646464",
                               "Botifarra/llonganissa/fesols/seques" = "#646464",
                               "Pa amb tomàquet" = "#646464",
                               "Calçots" = "#646464",
                               "Crema catalana" = "#646464",
                               "Fricandó" = "#646464",
                               "Escalivada" = "#646464",
                               "Cargols a la llauna" = "#646464",
                               "Canelons" = "#646464",
                               "Paella / Fideuada" = "#646464",
                               "Altres" = "#C6C6C6",
                               "NS/NC" = "#C6C6C6")) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size = 15),
        plot.margin = margin(0.5,1,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
PLAT_CUINA_CATALANA

ggsave(file.path(ALTRES_IMG_FOLDER, "PLAT_CUINA_CATALANA.png"),
       plot = PLAT_CUINA_CATALANA,
       width = 17,
       height = 12,
       dpi = 300,
       units = "cm")
```

## Simpatia d’equip de futbol

```{r}
ESPORT_SIMPATIA_EQUIP <- data|> 
  select(ESPORT_SIMPATIA_EQUIP_2,
         ESPORT_SIMPATIA_EQUIP_1,
         PONDERA)|>
   mutate(ESPORT_SIMPATIA_EQUIP_2 = case_when(
    ESPORT_SIMPATIA_EQUIP_2 == 1 ~ "FC Barcelona",
    ESPORT_SIMPATIA_EQUIP_2 == 2 ~ "RCD Espanyol",
    ESPORT_SIMPATIA_EQUIP_2 == 3 ~ "Reial Madrid",
    ESPORT_SIMPATIA_EQUIP_2 == 5 ~ "Altres",
    ESPORT_SIMPATIA_EQUIP_2 == 6 ~ "Altres",
    ESPORT_SIMPATIA_EQUIP_2 == 7 ~ "Girona Futbol Club S.A.D",
    ESPORT_SIMPATIA_EQUIP_2 == 80 ~ "Altres",
    ESPORT_SIMPATIA_EQUIP_1 == 2 ~ "Cap",
    TRUE ~ "NS/NC")) |> 
  as_label(ESPORT_SIMPATIA_EQUIP_2, drop.levels = F) |> 
  group_by(ESPORT_SIMPATIA_EQUIP_2)|>
  count(ESPORT_SIMPATIA_EQUIP_2, wt = PONDERA) |> 
  ungroup() |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(ESPORT_SIMPATIA_EQUIP_2 != "NS/NC") |> 
  ggplot() +
  geom_col(aes(x = proportion,
               y = fct_relevel(ESPORT_SIMPATIA_EQUIP_2,
                               c("FC Barcelona",
                                 "Reial Madrid",
                                 "RCD Espanyol",
                                 "Girona Futbol Club S.A.D",
                                 "Altres",
                                 "Cap")),
               fill = ESPORT_SIMPATIA_EQUIP_2)) +
    geom_text(aes(x = proportion,
                  y = fct_relevel(ESPORT_SIMPATIA_EQUIP_2,
                               c("FC Barcelona",
                                 "Reial Madrid",
                                 "RCD Espanyol",
                                 "Girona Futbol Club S.A.D",
                                 "Altres",
                                 "Cap")),
                label = proportion), 
            hjust = -0.3,
            family = "open_sans", 
            color = "#646464",
            fontface = "bold",
            size = 6) +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,100)) +
  scale_y_discrete(limits = rev) +
  scale_fill_manual(values = c("FC Barcelona" = "#646464",
                                 "Reial Madrid" = "#646464",
                                 "RCD Espanyol" = "#646464",
                                 "Girona Futbol Club S.A.D" = "#646464",
                                 "Altres" = "#C6C6C6",
                                 "Cap" = "#C6C6C6")) + 
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size = 15),
        plot.margin = margin(0.5,1,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
ESPORT_SIMPATIA_EQUIP

ggsave(file.path(ALTRES_IMG_FOLDER, "ESPORT_SIMPATIA_EQUIP.png"),
       plot = ESPORT_SIMPATIA_EQUIP,
       width = 17,
       height = 12,
       dpi = 300,
       units = "cm")
```

## Conducció

```{r}
CONDUCCIO <- data |> 
  select(CONDUCCIO,
         PONDERA) |>
  mutate(CONDUCCIO = case_when(
    CONDUCCIO == 1 ~ "Moltes vegades",
    CONDUCCIO == 2 ~ "Poques vegades",
    CONDUCCIO == 3 ~ "Mai",
    CONDUCCIO == 4 ~ "No té carnet de conduir/ No condueix mai",
    TRUE ~ "NS/NC"),
    CONDUCCIO = factor(CONDUCCIO, levels = c("Moltes vegades",
                                             "Poques vegades",
                                             "Mai",
                                             "No té carnet de conduir/ No condueix mai",
                                             "NS/NC"))) |> 
  group_by(CONDUCCIO) |> 
  count(CONDUCCIO, wt = PONDERA) |> 
  ungroup() |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
   ggplot() +
  geom_col(aes(proportion,
               CONDUCCIO,
               fill = CONDUCCIO), 
           width = 0.5) +
  geom_text(aes(proportion,
                CONDUCCIO,
                label = proportion,
                color = CONDUCCIO), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  geom_text(aes(x = 0, 
                label = CONDUCCIO, 
                y = CONDUCCIO), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = categ_4_colors) +
  scale_color_manual(values = categ_4_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 2)) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,-1,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
CONDUCCIO

ggsave(file.path(ALTRES_IMG_FOLDER, "CONDUCCIO.png"),
       plot = CONDUCCIO,
       width = 17,
       height = 14,
       dpi = 300,
       units = "cm")
```

## Conducció, segons gènere

```{r}
CONDUCCIO_GENERE <- data |> 
  select(CONDUCCIO,
         GENERE,
         PONDERA) |>
  filter(GENERE < 80) |> 
  mutate(CONDUCCIO = case_when(
    CONDUCCIO == 1 ~ "Moltes vegades",
    CONDUCCIO == 2 ~ "Poques vegades",
    CONDUCCIO == 3 ~ "Mai",
    CONDUCCIO == 4 ~ "No té carnet de conduir/ No condueix mai",
    TRUE ~ "NS/NC"),
    CONDUCCIO = factor(CONDUCCIO, levels = c("Moltes vegades",
                                             "Poques vegades",
                                             "Mai",
                                             "No té carnet de conduir/ No condueix mai",
                                             "NS/NC"))) |> 
  as_label(GENERE, drop.levels = F) |> 
  group_by(GENERE, CONDUCCIO) |> 
  count(CONDUCCIO, wt = PONDERA) |> 
  ungroup() |> 
  group_by(GENERE) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(proportion,
               GENERE,
               group = rev(CONDUCCIO),
               fill = CONDUCCIO), 
           width = 0.5) +
  geom_text(aes(proportion,
                GENERE,
                group = rev(CONDUCCIO),
                label = ifelse(proportion > 1, proportion, ""),
                color = CONDUCCIO), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  geom_text(aes(x = 0, 
                label = GENERE, 
                y = GENERE), 
            color = "#585858",
            size = 5,
            hjust = 0, 
            nudge_y = 0.5, 
            check_overlap = TRUE) +
  scale_fill_manual(values = categ_4_colors) +
  scale_color_manual(values = categ_4_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 3)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1.5,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
CONDUCCIO_GENERE

ggsave(file.path(ALTRES_IMG_FOLDER, "CONDUCCIO_GENERE.png"),
       plot = CONDUCCIO_GENERE,
       width = 17,
       height = 10,
       dpi = 300,
       units = "cm")
```

## Conducció, per franges d'edat

```{r}
CONDUCCIO_EDAT <- data |> 
  select(CONDUCCIO,
         EDAT_GR,
         PONDERA) |>
  mutate(CONDUCCIO = case_when(
    CONDUCCIO == 1 ~ "Moltes vegades",
    CONDUCCIO == 2 ~ "Poques vegades",
    CONDUCCIO == 3 ~ "Mai",
    CONDUCCIO == 4 ~ "No té carnet de conduir/ No condueix mai",
    TRUE ~ "NS/NC"),
    CONDUCCIO = factor(CONDUCCIO, levels = c("Moltes vegades",
                                             "Poques vegades",
                                             "Mai",
                                             "No té carnet de conduir/ No condueix mai",
                                             "NS/NC"))) |> 
  as_label(EDAT_GR, drop.levels = F) |> 
  group_by(EDAT_GR, CONDUCCIO) |> 
  count(CONDUCCIO, wt = PONDERA) |> 
  ungroup() |> 
  group_by(EDAT_GR) |> 
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  ggplot() +
  geom_col(aes(proportion,
               EDAT_GR,
               group = rev(CONDUCCIO),
               fill = CONDUCCIO), 
           width = 0.8) +
  geom_text(aes(proportion,
                EDAT_GR,
                group = rev(CONDUCCIO),
                label = ifelse(proportion > 1, proportion, ""),
                color = CONDUCCIO), 
            position = position_stack(vjust = 0.5),
            family = "open_sans", 
            fontface = "bold",
            size = 5.5) +
  scale_fill_manual(values = categ_4_colors) +
  scale_color_manual(values = categ_4_text,
                     guide = "none") +
  scale_x_continuous(expand = c(0,0)) +
    scale_y_discrete(limits = rev) +
  guides(fill = guide_legend(nrow = 3)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = margin(0.5,1,0.5,0, "cm"),
        legend.margin = margin(-1,0,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            size = 16,
                            color  = "black")) +
  labs(x = "",
       y = "",
       fill = "")
CONDUCCIO_EDAT

ggsave(file.path(ALTRES_IMG_FOLDER, "CONDUCCIO_EDAT.png"),
       plot = CONDUCCIO_EDAT,
       width = 18,
       height = 12,
       dpi = 300,
       units = "cm")
```

## Nivell de benestar material a la llar

```{r}
BENESTAR <- data|> 
  select(starts_with("BENESTAR"),
         PONDERA)|>
    pivot_longer(starts_with("BENESTAR"), 
               names_to = "xarxa", 
               values_to = "resposta")|>
  mutate(xarxa = case_when(
  xarxa == "BENESTAR_PERMETRE_COTXE_PROPI" ~ "Es pot permetre tenir cotxe propi",
  xarxa == "BENESTAR_VACANCES" ~ "Es poden permetre anar de \nvacances fora de casa",
  xarxa == "BENESTAR_SUPORT_LLAR" ~ "Tenen alguna persona a qui paguen \nper ajudar-los en les feines de la llar",
  xarxa == "BENESTAR_PROPIETATS" ~ "Disposen d’algun altre habitatge \n(de propietat o lloguer)",
  xarxa == "BENESTAR_FACTURES" ~ "Han hagut d’endarrerir el pagament de factures \n(llum, aigua o gas) en els darrers 12 mesos",
  xarxa == "BENESTAR_TEMPERATURA_LLAR" ~ "Es poden permetre mantenir la \nllar a una temperatura confortable"),
  resposta = case_when(
    resposta == 1 ~ "Sí",
    TRUE ~ "No"
  ))|> 
  group_by(xarxa, resposta)|>
  count(resposta, wt = PONDERA) |> 
  ungroup() |> 
  group_by(xarxa)|>
  mutate(proportion = (n / sum(n))*100) |> 
  mutate(proportion = round_percent(proportion)) |> 
  filter(resposta != "No") |> 
  ggplot() +
  geom_col(aes(x = proportion,
               y = fct_reorder(xarxa, proportion)),
           fill = "#666666") +
    geom_text(aes(x = proportion,
                y = fct_reorder(xarxa, proportion),
                label = proportion), 
            hjust = -0.3,
            family = "open_sans", 
            color = "#646464",
            fontface = "bold",
            size = 6) +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,100)) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size = 15),
        plot.margin = margin(0.5,1,0,0, "cm"),
        text = element_text(family = "open_sans", 
                            color  = "black")) +
  labs(x = "",
       y = "")
BENESTAR

ggsave(file.path(ALTRES_IMG_FOLDER, "BENESTAR.png"),
       plot = BENESTAR,
       width = 18,
       height = 10,
       dpi = 300,
       units = "cm")
```

